<script>
// ==========================================
// 15. POR POR 5: SUBJECT CONFIG LOGIC
// ==========================================
function initSubjectConfigPage() {
  const user = getSessionUser();
  if(!user) return;
  document.getElementById('configTerm').value = user.currentTerm;
  document.getElementById('configYear').value = user.currentYear;
  const select = document.getElementById('configClassSelect'); select.innerHTML = `<option value="">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏¥‡∏ä‡∏≤...</option>`;
  const subjectCacheKey = `v2_subjects_${user.id}_${user.currentTerm}_${user.currentYear}`;
  const cachedSubjects = sessionStorage.getItem(subjectCacheKey);

  if (cachedSubjects && cachedSubjects !== "[]") { buildConfigSubjectDropdown(JSON.parse(cachedSubjects)); } 
  else {
     google.script.run.withFailureHandler(err => { select.innerHTML = `<option value="">‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</option>`; alert("Error: " + err.message); })
       .withSuccessHandler(subjects => { sessionStorage.setItem(subjectCacheKey, JSON.stringify(subjects)); buildConfigSubjectDropdown(subjects); })
       .getTeacherSubjects(user.id, user.role, user.currentTerm, user.currentYear);
  }
}

function buildConfigSubjectDropdown(subjects) {
  const select = document.getElementById('configClassSelect');
  if(subjects.length === 0) { select.innerHTML = `<option value="">‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏ô‡πÄ‡∏ó‡∏≠‡∏°‡∏ô‡∏µ‡πâ</option>`; return; }
  let html = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ --</option>';
  subjects.forEach(sub => { html += `<option value='${JSON.stringify(sub)}'>${sub[0]} - ${sub[1]} (${sub[2]})</option>`; });
  select.innerHTML = html;
}

function loadSubjectConfig() {
  const val = document.getElementById('configClassSelect').value;
  const panel = document.getElementById('configPanel');
  const info = document.getElementById('configSubjectInfo');
  if(!val) { panel.style.pointerEvents = 'none'; panel.classList.add('opacity-50'); info.classList.add('d-none'); return; }

  const item = JSON.parse(val); const user = getSessionUser();
  document.getElementById('dispConfigSubject').innerText = `${item[0]} ${item[1]}`;
  document.getElementById('dispConfigClass').innerText = `‡∏´‡πâ‡∏≠‡∏á ${item[2]}`;
  info.classList.remove('d-none'); panel.style.pointerEvents = 'auto'; panel.classList.remove('opacity-50');
  showLoader(true);
  
  google.script.run.withSuccessHandler(config => {
       showLoader(false); const tbody = document.getElementById('indicatorTableBody'); tbody.innerHTML = '';
       if (config) {
          const ratios = config.ratio.split(':');
          document.getElementById('scoreFormative').value = ratios[0] || 0; document.getElementById('scoreMidterm').value = ratios[1] || 0; document.getElementById('scoreFinal').value = ratios[2] || 0;
          if(config.indicators && config.indicators.length > 0) { config.indicators.forEach(ind => addIndicatorRow(ind.name, ind.score, ind.description || '')); } else { addIndicatorRow(); }
       } else {
          document.getElementById('scoreFormative').value = 70; document.getElementById('scoreMidterm').value = 10; document.getElementById('scoreFinal').value = 20; addIndicatorRow();
       }
       calculateTotalConfigScore();
    }).getSubjectConfig(item[0], item[2], user.currentTerm, user.currentYear);
}

function calculateTotalConfigScore() {
  const f = parseInt(document.getElementById('scoreFormative').value) || 0;
  const m = parseInt(document.getElementById('scoreMidterm').value) || 0;
  const e = parseInt(document.getElementById('scoreFinal').value) || 0;
  const total = f + m + e;
  const badge = document.getElementById('totalScoreBadge');
  badge.innerText = total;
  if(total === 100) { badge.className = 'text-success fs-5 fw-bold'; } else { badge.className = 'text-danger fs-5 fw-bold'; }
}

function saveSubjectConfigData() {
  const val = document.getElementById('configClassSelect').value;
  if(!val) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤");
  const total = parseInt(document.getElementById('totalScoreBadge').innerText);
  if(total !== 100) { if(!confirm("‚ö†Ô∏è ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö 100 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return; }

  const item = JSON.parse(val); const user = getSessionUser();
  const indicators = [];
  const rows = document.querySelectorAll('#indicatorTableBody tr');
  rows.forEach(row => {
    const name = row.querySelector('.ind-name').value.trim();
    const score = parseInt(row.querySelector('.ind-score').value) || 0;
    const description = row.querySelector('.ind-desc').value.trim(); // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
    if(name && score > 0) { 
      indicators.push({ name: name, score: score, description: description }); 
    }
  });

  const configData = { subjectCode: item[0], className: item[2], term: user.currentTerm, year: user.currentYear, formative: parseInt(document.getElementById('scoreFormative').value) || 0, midterm: parseInt(document.getElementById('scoreMidterm').value) || 0, final: parseInt(document.getElementById('scoreFinal').value) || 0, indicators: indicators, teacherId: user.id };
  const btn = document.getElementById('btnSaveConfig');
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...'; btn.disabled = true;

  safeRun(3)
    .withFailureHandler(err => {
       btn.innerHTML = '<i class="fas fa-save me-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏¥‡∏ä‡∏≤'; btn.disabled = false;
       alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
    })
    .withSuccessHandler(res => { btn.innerHTML = '<i class="fas fa-save me-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏¥‡∏ä‡∏≤'; btn.disabled = false; alert(res.message); })
    .saveSubjectConfig(configData);
}

// ==========================================
// 16. POR POR 5: ALL-IN-ONE (‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)
// ==========================================

let currentScoreConfig = null;
let currentScoreStudents = [];
let currentAttStats = {};
let isHeaderEditMode = false;
let isQualVisible = false;
let isSavingScores = false; 

// üåü ‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô (‡πÄ‡∏Å‡∏£‡∏≤‡∏∞‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏î‡πá‡∏Å)
const normID = (id) => { let clean = String(id).replace(/[^a-zA-Z0-9]/g, '').replace(/^0+/, ''); return clean || '0'; };
const normStr = (str) => String(str).replace(/\s+/g, '').toLowerCase();

function initScoreEntryPage() {
  const user = getSessionUser();
  if(!user) return;
  const select = document.getElementById('scoreClassSelect');
  select.innerHTML = `<option value="">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏¥‡∏ä‡∏≤...</option>`;
  
  const subjectCacheKey = `v2_subjects_${user.id}_${user.currentTerm}_${user.currentYear}`;
  const cachedSubjects = sessionStorage.getItem(subjectCacheKey);

  if (cachedSubjects && cachedSubjects !== "[]") {
     buildScoreSubjectDropdown(JSON.parse(cachedSubjects));
  } else {
     google.script.run.withSuccessHandler(subjects => {
          sessionStorage.setItem(subjectCacheKey, JSON.stringify(subjects));
          buildScoreSubjectDropdown(subjects);
     }).getTeacherSubjects(user.id, user.role, user.currentTerm, user.currentYear);
  }
}

function buildScoreSubjectDropdown(subjects) {
  const select = document.getElementById('scoreClassSelect');
  if(subjects.length === 0) { select.innerHTML = `<option value="">‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏ô‡πÄ‡∏ó‡∏≠‡∏°‡∏ô‡∏µ‡πâ</option>`; return; }
  let html = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å --</option>';
  subjects.forEach(sub => { html += `<option value='${JSON.stringify(sub)}'>${sub[0]} - ${sub[1]} (${sub[2]})</option>`; });
  select.innerHTML = html;
}

function toggleHeaderEditMode() {
  const btnEdit = document.getElementById('btnEditHeader');
  if (!isHeaderEditMode) {
    isHeaderEditMode = true;
    btnEdit.className = "btn btn-danger shadow-sm px-3 fw-bold me-2";
    btnEdit.innerHTML = '<i class="fas fa-check me-2"></i>‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á';
    refreshTableOnly();
  } else {
    if(confirm("üí° ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
       saveAllInOneScores(); 
    } else {
       isHeaderEditMode = false;
       btnEdit.className = "btn btn-outline-primary shadow-sm px-3 fw-bold me-2";
       btnEdit.innerHTML = '<i class="fas fa-th me-2"></i>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á';
       refreshTableOnly();
    }
  }
}

function toggleQualColumns() {
  isQualVisible = !isQualVisible;
  const btn = document.getElementById('btnToggleQual');
  if (isQualVisible) {
    btn.className = "btn btn-info shadow-sm px-3 fw-bold me-2 text-white";
    btn.innerHTML = '<i class="fas fa-eye-slash me-2"></i>‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞';
  } else {
    btn.className = "btn btn-outline-info shadow-sm px-3 fw-bold me-2";
    btn.innerHTML = '<i class="fas fa-eye me-2"></i>‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞';
  }
  syncHeaderState(); 
  refreshTableOnly(); 
}

// ==========================================
// üåü ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏° Skeleton UX
// ==========================================
function loadScoreGrid() {
  const val = document.getElementById('scoreClassSelect').value;
  const gridCard = document.getElementById('scoreGridCard');
  const btnSave = document.getElementById('btnSaveScores');
  
  if(!val) {
    gridCard.classList.add('d-none');
    btnSave.disabled = true;
    return;
  }

  const item = JSON.parse(val);
  const user = getSessionUser();
  
  // üåü 1. ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ showLoader ‡∏à‡∏≠‡∏î‡∏≥‡πÅ‡∏•‡πâ‡∏ß!)
  gridCard.classList.remove('d-none');
  btnSave.disabled = true; 
  document.getElementById('scoreGridTitle').innerHTML = `<i class="fas fa-spinner fa-spin me-2 text-primary"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏õ‡∏û.5...`;
  document.getElementById('scoreRatioBadge').innerText = "‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà";
  
  // üåü 2. ‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å (Skeleton) ‡∏´‡∏•‡∏≠‡∏Å‡∏ï‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
  renderSkeletonTable();

  // üåü 3. ‡∏¢‡∏¥‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô
  safeRun(3)
    .withFailureHandler(err => {
        document.getElementById('scoreTableBody').innerHTML = `<tr><td colspan="10" class="text-center text-danger p-5"><i class="fas fa-exclamation-triangle fa-2x mb-2"></i><br>‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${err.message}</td></tr>`;
        document.getElementById('scoreGridTitle').innerHTML = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î`;
    })
    .withSuccessHandler(res => {
        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡∏ñ‡∏∂‡∏á ‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏≠‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏õ‡∏ó‡∏±‡∏ö Skeleton
        btnSave.disabled = false;
        currentScoreConfig = res.config;
        currentScoreStudents = res.students;
        currentAttStats = res.attStats || {}; 
        renderAllInOneTable(res.students, res.config, res.existingScores, res.existingQuals);
    })
    .getAllInOneScoreGridData(item[0], item[2], user.currentTerm, user.currentYear);
}

// ==========================================
// ü¶¥ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏≤‡∏Å‡∏∞‡∏û‡∏£‡∏¥‡∏ö (Skeleton Render)
// ==========================================
function renderSkeletonTable() {
  const thead = document.getElementById('scoreTableHeader');
  const tbody = document.getElementById('scoreTableBody');
  
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏°
  thead.innerHTML = `<tr>
    <th class="p-3" style="width:40px;"><div class="skeleton-box" style="width:20px; height:20px;"></div></th>
    <th class="p-3" style="min-width: 170px;"><div class="skeleton-box" style="width:120px; height:20px;"></div></th>
    <th class="p-3"><div class="skeleton-box mx-auto" style="width:60px; height:20px;"></div></th>
    <th class="p-3"><div class="skeleton-box mx-auto" style="width:60px; height:20px;"></div></th>
    <th class="p-3"><div class="skeleton-box mx-auto" style="width:60px; height:20px;"></div></th>
    <th class="p-3"><div class="skeleton-box mx-auto" style="width:60px; height:20px;"></div></th>
    <th class="p-3"><div class="skeleton-box mx-auto" style="width:60px; height:20px;"></div></th>
  </tr>`;

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏•‡∏≠‡∏° 5 ‡πÅ‡∏ñ‡∏ß
  let skeletonRows = '';
  for(let i=0; i<5; i++) {
    skeletonRows += `<tr>
      <td class="text-center align-middle p-3"><div class="skeleton-box mx-auto" style="width:20px; height:20px;"></div></td>
      <td class="align-middle p-3">
        <div class="skeleton-box mb-2" style="width:140px; height:18px;"></div><br>
        <div class="skeleton-box" style="width:80px; height:12px;"></div>
      </td>
      <td class="text-center align-middle p-3"><div class="skeleton-box mx-auto" style="width:50px; height:30px;"></div></td>
      <td class="text-center align-middle p-3"><div class="skeleton-box mx-auto" style="width:50px; height:30px;"></div></td>
      <td class="text-center align-middle p-3"><div class="skeleton-box mx-auto" style="width:50px; height:30px;"></div></td>
      <td class="text-center align-middle p-3"><div class="skeleton-box mx-auto" style="width:50px; height:30px;"></div></td>
      <td class="text-center align-middle p-3"><div class="skeleton-box mx-auto" style="width:50px; height:30px;"></div></td>
    </tr>`;
  }
  tbody.innerHTML = skeletonRows;
}

function syncHeaderState() {
  if(!document.querySelector('.ind-name-edit')) return; 
  const newIndicators = [];
  const names = document.querySelectorAll('.ind-name-edit');
  const scores = document.querySelectorAll('.ind-score-edit');
  names.forEach((el, i) => {
    newIndicators.push({ name: el.innerText.trim(), score: parseFloat(scores[i].innerText) || 0 });
  });
  currentScoreConfig.indicators = newIndicators;
  
  const f = parseFloat(document.getElementById('edit-ratio-f').innerText) || 0;
  const m = parseFloat(document.getElementById('edit-ratio-m').innerText) || 0;
  const e = parseFloat(document.getElementById('edit-ratio-e').innerText) || 0;
  currentScoreConfig.ratio = `${f}:${m}:${e}`;
}

function refreshTableOnly() {
  const tempScores = {};
  const tempQuals = {};
  
  if (currentScoreStudents && currentScoreStudents.length > 0) {
      currentScoreStudents.forEach(std => {
        const stdId = String(std[0]).trim();
        const safeStdId = normID(stdId); 
        
        const indNames = Array.from(document.querySelectorAll('.ind-name-edit')).map(el => el.innerText.trim());
        document.querySelectorAll(`.formative-std-${safeStdId}`).forEach((input, i) => {
          if(input.value !== '' && indNames[i]) {
             const safeIndName = normStr(`ind_${indNames[i]}`); 
             tempScores[`${safeStdId}_${safeIndName}`] = parseFloat(input.value);
          }
        });
        
        const m = document.querySelector(`.midterm-std-${safeStdId}`);
        if(m && m.value !== '') tempScores[`${safeStdId}_midterm`] = parseFloat(m.value);
        
        const mr = document.querySelector(`.midterm-re-std-${safeStdId}`);
        if(mr && mr.value !== '') tempScores[`${safeStdId}_midterm_re`] = parseFloat(mr.value);
        
        const f = document.querySelector(`.final-std-${safeStdId}`);
        if(f && f.value !== '') tempScores[`${safeStdId}_final`] = parseFloat(f.value);

        const rem = document.querySelector(`.remark-select[data-safeid="${safeStdId}"]`);
        if(rem && rem.value !== '') tempScores[`${safeStdId}_remark`] = rem.value;

        const qr = document.querySelector(`.qual-read[data-safeid="${safeStdId}"]`);
        const qc = document.querySelector(`.qual-char[data-safeid="${safeStdId}"]`);
        const qp = document.querySelector(`.qual-comp[data-safeid="${safeStdId}"]`);
        if(qr && qc && qp) tempQuals[safeStdId] = { read: qr.value, char: qc.value, comp: qp.value };
      });
  }
  renderAllInOneTable(currentScoreStudents, currentScoreConfig, tempScores, tempQuals); 
}

// üåü 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏â‡∏ö‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö & ‡∏ô‡∏≥ % ‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡∏£‡∏´‡∏±‡∏™)
function renderAllInOneTable(students, config, existingScores, existingQuals) {
  const thead = document.getElementById('scoreTableHeader');
  const tbody = document.getElementById('scoreTableBody');
  const val = document.getElementById('scoreClassSelect').value;
  const item = JSON.parse(val);
  
  document.getElementById('scoreGridTitle').innerHTML = `‡∏õ‡∏û.5: ‡∏ß‡∏¥‡∏ä‡∏≤ ${item[0]} ${item[1]} ‡∏´‡πâ‡∏≠‡∏á ${item[2]}`;
  document.getElementById('scoreRatioBadge').innerText = `‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ${config.ratio}`;

  // üåü ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÅ‡∏•‡∏∞‡∏•‡∏î Padding ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏£‡∏Å‡πÜ
  let headHtml = `<tr><th rowspan="2" class="align-middle text-center sticky-head-1 text-muted px-1" style="width:40px;">‡∏ó‡∏µ‡πà</th><th rowspan="2" class="align-middle text-start sticky-head-2 text-muted px-2" style="min-width: 170px;">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>`;
  let subHeadHtml = `<tr>`;
  
  config.indicators.forEach((ind, idx) => {
    let deleteBtn = isHeaderEditMode ? `<div class="mt-1"><button class="btn btn-xs btn-outline-danger p-0 px-1 border-0" onclick="removeIndicator(${idx})"><i class="fas fa-times"></i></button></div>` : '';
    
    let iconColor = ind.description ? 'text-info' : 'text-secondary';
    
    let infoBtn = `<i class="fas fa-info-circle ${iconColor} ms-1" 
                      style="cursor: pointer; transition: transform 0.2s;" 
                      onmouseover="this.style.transform='scale(1.2)'" 
                      onmouseout="this.style.transform='scale(1)'"
                      onclick="showIndicatorEdit(${idx})" 
                      title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"></i>`;

    headHtml += `<th class="text-success border-bottom-0">
                   <div contenteditable="${isHeaderEditMode}" class="ind-name-edit" data-idx="${idx}">${ind.name}</div>
                   ${deleteBtn}
                 </th>`;
                 
    subHeadHtml += `<th class="text-success small fw-normal">
                      (<span contenteditable="${isHeaderEditMode}" class="ind-score-edit" onblur="reCalcAllRows()">${ind.score}</span>) 
                      ${infoBtn}
                    </th>`;
  });
  
  if(isHeaderEditMode) headHtml += `<th rowspan="2" class="align-middle bg-light"><button class="btn btn-sm btn-light text-primary border shadow-sm px-2 py-0" onclick="addIndicator()"><i class="fas fa-plus"></i></button></th>`;

  const ratios = config.ratio.split(':');
  
  headHtml += `<th class="text-primary border-bottom-0 border-start col-highlight-f">‡∏£‡∏ß‡∏°‡πÄ‡∏Å‡πá‡∏ö</th><th class="text-warning text-dark border-bottom-0 col-highlight-m">‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ</th><th class="text-danger border-bottom-0 border-start border-white col-highlight-mr" style="opacity: 0.8;">‡∏ã‡πà‡∏≠‡∏°</th><th class="text-danger border-bottom-0 border-start col-highlight-e">‡∏õ‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏Ñ</th><th class="text-dark border-bottom-0 border-start col-highlight-total">‡∏£‡∏ß‡∏°</th><th class="text-success border-bottom-0 border-start col-highlight-grade">‡πÄ‡∏Å‡∏£‡∏î</th><th class="text-danger border-bottom-0 border-start col-highlight-mr">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th><th colspan="3" class="text-info text-dark border-start ${isQualVisible ? '' : 'd-none'}">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô (0-3)</th></tr>`;
  
  subHeadHtml += `<th class="text-primary small fw-normal border-start col-highlight-f">(<span id="edit-ratio-f">${ratios[0] || 0}</span>)</th><th class="text-warning text-dark small fw-normal col-highlight-m">(<span id="edit-ratio-m" contenteditable="${isHeaderEditMode}" onblur="reCalcAllRows()">${ratios[1] || 0}</span>)</th><th class="text-danger small fw-normal border-start border-white col-highlight-mr" style="opacity: 0.8;">-</th><th class="text-danger small fw-normal border-start col-highlight-e">(<span id="edit-ratio-e" contenteditable="${isHeaderEditMode}" onblur="reCalcAllRows()">${ratios[2] || 0}</span>)</th><th class="text-dark small fw-normal border-start col-highlight-total">(<span id="edit-ratio-total">100</span>)</th><th class="text-success small fw-normal border-start col-highlight-grade">0-4</th><th class="text-danger small fw-normal border-start col-highlight-mr">(‡∏£, ‡∏°‡∏™)</th><th class="text-info small fw-normal border-start ${isQualVisible ? '' : 'd-none'}">‡∏≠‡πà‡∏≤‡∏ô</th><th class="text-info small fw-normal ${isQualVisible ? '' : 'd-none'}">‡∏Ñ‡∏∏‡∏ì‡∏Ø</th><th class="text-info small fw-normal ${isQualVisible ? '' : 'd-none'}">‡∏™‡∏°‡∏£‡∏£‡∏ñ‡∏ô‡∏∞</th></tr>`;
  
  thead.innerHTML = headHtml + subHeadHtml;

  let bodyHtml = '';
  students.sort((a, b) => String(a[0]).localeCompare(String(b[0])));

  students.forEach((std, rowIndex) => {
    const stdId = String(std[0]).trim();
    const safeStdId = normID(stdId); 
    let colIndex = 0; 
    
    let pct = currentAttStats[safeStdId];
    let attText = '';
    let autoMS = false;
    let remarkVal = (existingScores[`${safeStdId}_remark`] !== undefined) ? existingScores[`${safeStdId}_remark`] : '';
    
    if (pct !== undefined) {
        // üåü ‡∏¢‡πâ‡∏≤‡∏¢ % ‡∏°‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™ ‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏õ‡πâ‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
        attText = `<span class="ms-2 fw-bold ${pct < 80 ? 'text-danger' : 'text-success'}" style="font-size: 0.72rem; letter-spacing:-0.3px;"><i class="fas fa-user-clock me-1"></i>${pct}%</span>`;
        if (pct < 80 && remarkVal === '') {
            remarkVal = '‡∏°‡∏™';
            autoMS = true;
        }
    }
    
    // üåü ‡∏à‡∏±‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ä‡∏¥‡∏î‡πÅ‡∏•‡∏∞‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
    bodyHtml += `<tr>
      <td class="text-center text-muted fw-bold sticky-col-1 align-middle" style="font-size:0.85rem;">${rowIndex + 1}</td>
      <td class="text-start sticky-col-2 align-middle px-2">
         <div class="fw-bold text-dark text-truncate" style="max-width: 170px; font-size: 0.88rem; line-height:1.2;">${std[2]}</div>
         <div class="d-flex align-items-center mt-1">
            <span class="text-muted font-monospace" style="font-size: 0.75rem;">${stdId}</span>
            ${attText}
         </div>
      </td>`;
    
    config.indicators.forEach((ind) => {
      const indName = normStr(`ind_${ind.name}`);
      const scoreKey = `${safeStdId}_${indName}`; 
      const val = (existingScores[scoreKey] !== undefined && existingScores[scoreKey] !== "") ? existingScores[scoreKey] : '';
      bodyHtml += `<td class="p-0 align-middle text-center"><input type="number" class="score-cell-input nav-input formative-std-${safeStdId}" style="background:transparent;" value="${val}" data-row="${rowIndex}" data-col="${colIndex++}" onkeydown="handleCellNav(event)" onkeyup="calcRow('${stdId}', '${safeStdId}')"></td>`;
    });

    if(isHeaderEditMode) bodyHtml += `<td class="bg-light"></td>`;

    const midVal = (existingScores[`${safeStdId}_midterm`] !== undefined && existingScores[`${safeStdId}_midterm`] !== "") ? existingScores[`${safeStdId}_midterm`] : '';
    const midReVal = (existingScores[`${safeStdId}_midterm_re`] !== undefined && existingScores[`${safeStdId}_midterm_re`] !== "") ? existingScores[`${safeStdId}_midterm_re`] : ''; 
    const finVal = (existingScores[`${safeStdId}_final`] !== undefined && existingScores[`${safeStdId}_final`] !== "") ? existingScores[`${safeStdId}_final`] : '';
    const q = existingQuals[safeStdId] || { read: "3", char: "3", comp: "3" };
    const opt = `<option value="3">3</option><option value="2">2</option><option value="1">1</option><option value="0">0</option>`;

    bodyHtml += `<td class="p-0 align-middle text-center border-start col-highlight-f"><input type="text" class="score-cell-input fw-bold text-primary" style="background:transparent;" id="sum_f_std_${safeStdId}" value="0" readonly tabindex="-1"></td>
      <td class="p-0 align-middle text-center col-highlight-m"><input type="number" class="score-cell-input nav-input midterm-std-${safeStdId}" style="background:transparent;" value="${midVal}" data-row="${rowIndex}" data-col="${colIndex++}" onkeydown="handleCellNav(event)" onkeyup="calcRow('${stdId}', '${safeStdId}')"></td>
      <td class="p-0 align-middle text-center border-start border-white col-highlight-mr"><input type="number" class="score-cell-input nav-input midterm-re-std-${safeStdId} text-danger fw-bold" style="background:transparent;" value="${midReVal}" placeholder="-" data-row="${rowIndex}" data-col="${colIndex++}" onkeydown="handleCellNav(event)" onkeyup="calcRow('${stdId}', '${safeStdId}')"></td>
      <td class="p-0 align-middle text-center border-start col-highlight-e"><input type="number" class="score-cell-input nav-input final-std-${safeStdId}" style="background:transparent;" value="${finVal}" data-row="${rowIndex}" data-col="${colIndex++}" onkeydown="handleCellNav(event)" onkeyup="calcRow('${stdId}', '${safeStdId}')"></td>
      
      <td class="text-center align-middle text-dark fw-bold border-start col-highlight-total" id="sum_total_std_${safeStdId}" style="font-size: 0.95rem;">0</td>
      <td class="text-center align-middle text-success fw-bold border-start col-highlight-grade" id="grade_std_${safeStdId}" style="font-size: 1rem;">0</td>
      
      <td class="p-0 align-middle text-center border-start col-highlight-mr position-relative">
        <select class="qual-select remark-select nav-input" data-row="${rowIndex}" data-col="${colIndex++}" data-safeid="${safeStdId}" onkeydown="handleCellNav(event)" onchange="calcRow('${stdId}', '${safeStdId}')" style="width: 100%; height:100%; background: transparent; padding:4px; font-size: 0.85rem; border:none; outline:none; text-align:center;">
          <option value="" ${remarkVal === '' ? 'selected' : ''}>-</option>
          <option value="‡∏£" ${remarkVal === '‡∏£' ? 'selected' : ''}>‡∏£</option>
          <option value="‡∏°‡∏™" ${remarkVal === '‡∏°‡∏™' ? 'selected' : ''}>‡∏°‡∏™</option>
        </select>
        ${autoMS ? '<div class="text-danger fw-bold position-absolute" style="font-size: 0.45rem; top: 1px; right: 2px; text-align: center;"><i class="fas fa-robot"></i></div>' : ''}
      </td>
      
      <td class="p-0 align-middle text-center border-start ${isQualVisible ? '' : 'd-none'}"><select class="qual-select qual-read nav-input w-100 h-100 border-0 text-center" data-row="${rowIndex}" data-col="${colIndex++}" onkeydown="handleCellNav(event)" data-safeid="${safeStdId}">${opt.replace(`value="${q.read}"`, `value="${q.read}" selected`)}</select></td>
      <td class="p-0 align-middle text-center ${isQualVisible ? '' : 'd-none'}"><select class="qual-select qual-char nav-input w-100 h-100 border-0 text-center" data-row="${rowIndex}" data-col="${colIndex++}" onkeydown="handleCellNav(event)" data-safeid="${safeStdId}">${opt.replace(`value="${q.char}"`, `value="${q.char}" selected`)}</select></td>
      <td class="p-0 align-middle text-center ${isQualVisible ? '' : 'd-none'}"><select class="qual-select qual-comp nav-input w-100 h-100 border-0 text-center" data-row="${rowIndex}" data-col="${colIndex++}" onkeydown="handleCellNav(event)" data-safeid="${safeStdId}">${opt.replace(`value="${q.comp}"`, `value="${q.comp}" selected`)}</select></td>
    </tr>`;
  });
  tbody.innerHTML = bodyHtml;
  reCalcAllRows();
}

function calculateGrade(score) {
  if (score >= 80) return "4";
  if (score >= 75) return "3.5";
  if (score >= 70) return "3";
  if (score >= 65) return "2.5";
  if (score >= 60) return "2";
  if (score >= 55) return "1.5";
  if (score >= 50) return "1";
  return "0";
}

function reCalcAllRows() {
  let sumFormativeMax = 0;
  document.querySelectorAll('.ind-score-edit').forEach(el => { sumFormativeMax += parseFloat(el.innerText) || 0; });
  const fEl = document.getElementById('edit-ratio-f');
  if(fEl) fEl.innerText = sumFormativeMax;

  const f = sumFormativeMax; 
  const m = parseFloat(document.getElementById('edit-ratio-m').innerText) || 0;
  const e = parseFloat(document.getElementById('edit-ratio-e').innerText) || 0;
  const totalRatio = f + m + e;
  
  const totEl = document.getElementById('edit-ratio-total');
  if(totEl) {
     totEl.innerText = totalRatio;
     totEl.style.color = (totalRatio !== 100) ? 'red' : ''; 
  }

  currentScoreStudents.forEach(std => {
      calcRow(String(std[0]).trim(), normID(std[0]));
  });
}

let autoSaveTimer = null; 
let retrySaveTimer = null;

function calcRow(stdId, safeStdId) {
  if (!safeStdId) safeStdId = normID(stdId);

  let sumFormative = 0;
  const maxScores = Array.from(document.querySelectorAll('.ind-score-edit')).map(el => parseFloat(el.innerText) || 0);
  const maxM = parseFloat(document.getElementById('edit-ratio-m').innerText) || 0;
  const maxE = parseFloat(document.getElementById('edit-ratio-e').innerText) || 0;
  
  document.querySelectorAll(`.formative-std-${safeStdId}`).forEach((input, i) => {
    const val = parseFloat(input.value) || 0;
    input.style.color = val > (maxScores[i] || 0) ? 'red' : '';
    sumFormative += val;
  });
  
  const sumEl = document.getElementById(`sum_f_std_${safeStdId}`);
  if(sumEl) sumEl.value = sumFormative;
  
  const midInput = document.querySelector(`.midterm-std-${safeStdId}`);
  const midReInput = document.querySelector(`.midterm-re-std-${safeStdId}`);
  const midVal = midInput && midInput.value !== '' ? parseFloat(midInput.value) : 0;
  const midReVal = midReInput && midReInput.value !== '' ? parseFloat(midReInput.value) : NaN; 
  
  let effectiveMidterm = midVal; 
  if (midInput && midReInput) {
      if (!isNaN(midReVal)) {
         effectiveMidterm = midReVal;
         midInput.style.textDecoration = "line-through";
         midInput.style.opacity = "0.4";
      } else {
         midInput.style.textDecoration = "none";
         midInput.style.opacity = "1";
      }
      midInput.style.color = midVal > maxM ? 'red' : '';
      midReInput.style.color = effectiveMidterm > maxM ? 'red' : '#dc3545';
  }
  
  const finInput = document.querySelector(`.final-std-${safeStdId}`);
  const finVal = finInput && finInput.value !== '' ? parseFloat(finInput.value) : 0;
  if (finInput) finInput.style.color = finVal > maxE ? 'red' : '';

  const total = sumFormative + effectiveMidterm + finVal;
  const totalCell = document.getElementById(`sum_total_std_${safeStdId}`);
  const gradeCell = document.getElementById(`grade_std_${safeStdId}`);
  if(totalCell) totalCell.innerText = total;

  const remarkSelect = document.querySelector(`.remark-select[data-safeid="${safeStdId}"]`);
  const remark = remarkSelect ? remarkSelect.value : '';

  if (remarkSelect) {
      if(remark !== '') remarkSelect.classList.add('text-danger', 'fw-bold');
      else remarkSelect.classList.remove('text-danger', 'fw-bold');
  }

  if(gradeCell && totalCell) {
      if (remark !== '') {
         gradeCell.innerText = remark;
         totalCell.className = "text-center align-middle text-white fw-bold fs-6 border-start bg-danger";
         gradeCell.className = "text-center align-middle text-white fw-bold fs-5 border-start bg-danger";
      } else {
         gradeCell.innerText = calculateGrade(total);
         if(total < 50) { 
           totalCell.className = "text-center align-middle text-white fw-bold fs-6 border-start bg-danger";
           gradeCell.className = "text-center align-middle text-white fw-bold fs-5 border-start bg-danger"; 
         } else { 
           totalCell.className = "text-center align-middle text-dark fw-bold fs-6 border-start col-highlight-total";
           gradeCell.className = "text-center align-middle text-success fw-bold fs-5 border-start col-highlight-grade";
         }
      }
  }

  const btn = document.getElementById('btnSaveScores');
  if (!isHeaderEditMode && btn) {
      clearTimeout(autoSaveTimer);
      btn.innerHTML = '<i class="fas fa-hourglass-half fa-spin me-2"></i>‡∏£‡∏≠‡πÄ‡∏ã‡∏ü (3 ‡∏ß‡∏¥)...';
      btn.className = "btn btn-outline-warning text-dark shadow-sm px-4 fw-bold"; 
      autoSaveTimer = setTimeout(() => { saveAllInOneScores(true); }, 3000); 
  }
}

function saveAllInOneScores(isSilent = false) {
  if(isSavingScores) {
      if(isSilent) {
          clearTimeout(retrySaveTimer);
          retrySaveTimer = setTimeout(() => saveAllInOneScores(true), 1500);
      }
      return; 
  }
  isSavingScores = true;

  const val = document.getElementById('scoreClassSelect').value;
  const btn = document.getElementById('btnSaveScores');
  const originalBtnClass = "btn btn-success shadow-sm px-4 fw-bold";
  const originalText = '<i class="fas fa-save me-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';

  if(!val) { isSavingScores = false; return; }
  const item = JSON.parse(val);
  const user = getSessionUser();
  
  const f = parseFloat(document.getElementById('edit-ratio-f').innerText) || 0;
  const m = parseFloat(document.getElementById('edit-ratio-m').innerText) || 0;
  const e = parseFloat(document.getElementById('edit-ratio-e').innerText) || 0;
  
  if((f + m + e) !== 100) {
     if(!isSilent) {
        if(!confirm("‚ö†Ô∏è ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö 100 ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) { isSavingScores = false; return; }
     } else {
        if(btn) { btn.innerHTML = originalText; btn.className = originalBtnClass; }
        isSavingScores = false; return; 
     }
  }

  if (!isSilent && btn) {
     btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
     btn.className = originalBtnClass;
     btn.disabled = true;
  } else if (btn) {
     btn.innerHTML = '<i class="fas fa-sync fa-spin me-2"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á Auto-Save...';
     btn.className = "btn btn-info text-white shadow-sm px-4 fw-bold";
  }

  try {
      const newIndicators = [];
      const names = document.querySelectorAll('.ind-name-edit');
      const scores = document.querySelectorAll('.ind-score-edit');
      names.forEach((el, i) => {
        newIndicators.push({ name: el.innerText.trim(), score: parseFloat(scores[i].innerText) || 0 });
      });

      currentScoreConfig.indicators = newIndicators;
      currentScoreConfig.ratio = `${f}:${m}:${e}`;

      const payload = {
        subjectCode: item[0], className: item[2], term: user.currentTerm, year: user.currentYear, teacherId: user.id,
        newConfig: { formative: f, midterm: m, final: e, indicators: newIndicators },
        scoreRecords: [], qualRecords: [], gradeRecords: []
      };

      currentScoreStudents.forEach(std => {
        const stdId = String(std[0]).trim();
        const safeStdId = normID(stdId); 
        
        document.querySelectorAll(`.formative-std-${safeStdId}`).forEach((input, i) => {
          const indName = normStr(`ind_${newIndicators[i].name}`);
          const val = input.value !== '' ? parseFloat(input.value) : ''; 
          payload.scoreRecords.push({ studentId: stdId, subjectCode: item[0], term: user.currentTerm, year: user.currentYear, indicatorId: indName, score: val });
        });

        const midInput = document.querySelector(`.midterm-std-${safeStdId}`);
        if (midInput) payload.scoreRecords.push({ studentId: stdId, subjectCode: item[0], term: user.currentTerm, year: user.currentYear, indicatorId: 'midterm', score: midInput.value !== '' ? parseFloat(midInput.value) : '' });

        const midReInput = document.querySelector(`.midterm-re-std-${safeStdId}`);
        if (midReInput) payload.scoreRecords.push({ studentId: stdId, subjectCode: item[0], term: user.currentTerm, year: user.currentYear, indicatorId: 'midterm_re', score: midReInput.value !== '' ? parseFloat(midReInput.value) : '' });

        const finInput = document.querySelector(`.final-std-${safeStdId}`);
        if (finInput) payload.scoreRecords.push({ studentId: stdId, subjectCode: item[0], term: user.currentTerm, year: user.currentYear, indicatorId: 'final', score: finInput.value !== '' ? parseFloat(finInput.value) : '' });

        const remarkInput = document.querySelector(`.remark-select[data-safeid="${safeStdId}"]`);
        if (remarkInput && remarkInput.value !== '') {
           payload.scoreRecords.push({ studentId: stdId, subjectCode: item[0], term: user.currentTerm, year: user.currentYear, indicatorId: 'remark', score: remarkInput.value });
        }

        const tCell = document.getElementById(`sum_total_std_${safeStdId}`);
        const gCell = document.getElementById(`grade_std_${safeStdId}`);
        payload.gradeRecords.push({ studentId: stdId, subjectCode: item[0], totalScore: tCell ? tCell.innerText : '0', grade: gCell ? gCell.innerText : '0' });
        
        const qRead = document.querySelector(`.qual-read[data-safeid="${safeStdId}"]`);
        const qChar = document.querySelector(`.qual-char[data-safeid="${safeStdId}"]`);
        const qComp = document.querySelector(`.qual-comp[data-safeid="${safeStdId}"]`);
        
        payload.qualRecords.push({ studentId: stdId, subjectCode: item[0], term: user.currentTerm, year: user.currentYear, read: qRead ? qRead.value : '3', char: qChar ? qChar.value : '3', comp: qComp ? qComp.value : '3' });
      });

      safeRun(3)
        .withFailureHandler(err => {
          isSavingScores = false; 
          if(btn) { btn.disabled = false; btn.innerHTML = originalText; btn.className = originalBtnClass; }
          if(!isSilent) alert("‚ùå ‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå: " + err.message);
        })
        .withSuccessHandler(res => {
          isSavingScores = false; 
          if(btn) { btn.disabled = false; btn.innerHTML = originalText; btn.className = originalBtnClass; }
          
          document.getElementById('scoreRatioBadge').innerText = `‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ${f}:${m}:${e}`;

          if (!isSilent) {
             let wasInEditMode = isHeaderEditMode;
             isHeaderEditMode = false;
             const btnEdit = document.getElementById('btnEditHeader');
             if(btnEdit) {
                btnEdit.className = "btn btn-outline-primary shadow-sm px-3 fw-bold me-2";
                btnEdit.innerHTML = '<i class="fas fa-th me-2"></i>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á';
             }
             showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß", "success");
             if(wasInEditMode) refreshTableOnly(); 
          } else {
             showToast("‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß (Auto-Saved)", "info");
          }
      }).saveAllInOneWithConfig(payload);

  } catch(e) {
      isSavingScores = false; 
      if(btn) { btn.disabled = false; btn.innerHTML = originalText; btn.className = originalBtnClass; }
      if(!isSilent) alert("‚ùå UI Error: " + e.message);
      console.error(e);
  }
}

function addIndicator() {
  currentScoreConfig.indicators.push({ name: "‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà", score: 10 });
  refreshTableOnly();
}

function addIndicatorRow(name = '', score = 0, description = '') {
  const tbody = document.getElementById('indicatorTableBody');
  const rowCount = tbody.rows.length + 1;
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td class="text-center fw-bold text-muted">${rowCount}</td>
    <td><input type="text" class="form-control form-control-sm ind-name" value="${name}" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà 1"></td>
    <td><textarea class="form-control form-control-sm ind-desc" rows="1" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå...">${description}</textarea></td>
    <td><input type="number" class="form-control form-control-sm text-center ind-score" value="${score}" onkeyup="calculateTotalConfigScore()"></td>
    <td class="text-center"><button class="btn btn-sm btn-outline-danger border-0" onclick="this.closest('tr').remove(); calculateTotalConfigScore();"><i class="fas fa-trash"></i></button></td>
  `;
  tbody.appendChild(tr);
}

function removeIndicator(idx) {
  if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ô‡∏µ‡πâ?")) {
    currentScoreConfig.indicators.splice(idx, 1);
    refreshTableOnly();
  }
}

function handleCellNav(e) {
  if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
    const input = e.target;
    const row = parseInt(input.dataset.row);
    const col = parseInt(input.dataset.col);
    let nextRow = row; let nextCol = col;
    if (e.key === 'ArrowUp') nextRow--;
    if (e.key === 'ArrowDown') nextRow++;
    if (e.key === 'ArrowLeft') nextCol--;
    if (e.key === 'ArrowRight') nextCol++;
    const nextInput = document.querySelector(`.nav-input[data-row="${nextRow}"][data-col="${nextCol}"]`);
    if (nextInput) { e.preventDefault(); nextInput.focus(); nextInput.select(); }
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å
function showIndicatorDetail(idx) {
  // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å config ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
  if (!currentScoreConfig || !currentScoreConfig.indicators[idx]) return;
  const ind = currentScoreConfig.indicators[idx];
  
  // ‡∏à‡∏±‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
  const desc = ind.description ? ind.description : '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡πÑ‡∏ß‡πâ‡∏Ñ‡∏£‡∏±‡∏ö';
  const scoreInfo = `<span class="badge bg-warning text-dark ms-2">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏° ${ind.score}</span>`;
  
  // ‡∏ô‡∏≥‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏õ‡πÉ‡∏™‡πà‡πÉ‡∏ô Modal
  document.getElementById('indicatorModalTitle').innerHTML = `<i class="fas fa-tag me-2"></i>${ind.name} ${scoreInfo}`;
  document.getElementById('indicatorModalDesc').innerText = desc;
  
  // ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏õ‡∏¥‡∏î Modal
  const modal = new bootstrap.Modal(document.getElementById('indicatorDetailModal'));
  modal.show();
}

// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
function showIndicatorEdit(idx) {
  if (!currentScoreConfig || !currentScoreConfig.indicators[idx]) return;
  const ind = currentScoreConfig.indicators[idx];
  
  // ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏•‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å
  document.getElementById('editIndIdx').value = idx;
  document.getElementById('editIndDesc').value = ind.description || '';
  
  // ‡∏à‡∏±‡∏î‡∏´‡∏±‡∏ß‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
  const scoreInfo = `<span class="badge bg-warning text-dark ms-2">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏° ${ind.score}</span>`;
  document.getElementById('indicatorEditModalTitle').innerHTML = `<i class="fas fa-edit me-2"></i>${ind.name} ${scoreInfo}`;
  
  // ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏õ‡∏¥‡∏î Modal
  const modal = new bootstrap.Modal(document.getElementById('indicatorEditModal'));
  modal.show();
}

// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏µ‡∏´‡∏ô‡πâ‡∏≤)
function saveIndicatorDetail() {
  const idx = document.getElementById('editIndIdx').value;
  const newDesc = document.getElementById('editIndDesc').value.trim();
  
  if (idx === "") return;
  
  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
  currentScoreConfig.indicators[idx].description = newDesc;
  
  // ‡∏õ‡∏¥‡∏î Modal ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡πÑ‡∏ß
  bootstrap.Modal.getInstance(document.getElementById('indicatorEditModal')).hide();
  showToast('‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', 'info');

  // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Dropdown ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏£‡∏∞‡∏ö‡∏ö
  const classData = JSON.parse(document.getElementById('scoreClassSelect').value);
  const subjectCode = classData[0];
  const className = classData[2];
  
  // ‡πÅ‡∏¢‡∏Å‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô Formative, Midterm, Final
  const ratios = currentScoreConfig.ratio.split(':');
  
  // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Payload ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡∏ö‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï Subject_Config
  const payload = {
    subjectCode: subjectCode,
    className: className,
    term: currentTerm,   // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global ‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö
    year: currentYear,   // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global ‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö
    teacherId: currentUser.id, // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global ‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö
    formative: ratios[0] || 70,
    midterm: ratios[1] || 10,
    final: ratios[2] || 20,
    indicators: currentScoreConfig.indicators // ‡∏™‡πà‡∏á Array ‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÅ‡∏Å‡πâ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏Å‡πâ‡∏≠‡∏ô
  };
  
  // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô
  safeRun(3)
    .withFailureHandler(function(err) {
      showToast('‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message, 'danger');
    })
    .withSuccessHandler(function(res) {
    if(res.status === 'success') {
      showToast('‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß!', 'success');
    } else {
      showToast('‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + res.message, 'danger');
    }
  }).saveSubjectConfig(payload);
}

</script>