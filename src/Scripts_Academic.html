<script>
// ==========================================
// 1. ACADEMIC & ATTENDANCE LOGIC
// ==========================================
var sigCanvas, sigCtx, isDrawing = false;
var currentStudents = [];
let tempHistoryData = [];

function getRealClassName() {
  const classVal = document.getElementById('selectClass').value;
  if (!classVal) return "";
  return String(JSON.parse(classVal)[2]).trim(); 
}

function initAcademicPage() {
  const user = getSessionUser();
  if(!user) return;
  if(document.getElementById('academic-header-info')) document.getElementById('academic-header-info').innerText = `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô: ${user.name} | ‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ${user.currentYear}`;
  
  const dateInput = document.getElementById('teachingDate');
  const pendingDate = sessionStorage.getItem('pending_teaching_date');
  if (pendingDate) {
      if(dateInput) dateInput.value = pendingDate;
      sessionStorage.removeItem('pending_teaching_date'); 
  } else if(dateInput && !dateInput.value) {
      const today = new Date();
      dateInput.value = new Date(today.getTime() - (today.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
  }
  updateThaiDateDisplay();
  reloadTimetableByDate();
  setTimeout(setupSignatureCanvas, 300);
}

function updateThaiDateDisplay() {
  const dateVal = document.getElementById('teachingDate').value;
  const display = document.getElementById('thaiDateDisplay');
  if(display && dateVal) display.innerHTML = '<i class="fas fa-calendar-check me-2"></i>' + formatThaiDate(dateVal);
}

function reloadTimetableByDate(forceRefresh = false) {
  const user = getSessionUser();
  const dateInput = document.getElementById('teachingDate');
  const dateStr = dateInput ? dateInput.value : "";
  if(!user || !dateStr) { showLoader(false); return; }

  const cacheKey = `v2_timetable_${user.id}_${dateStr}`;
  if (!forceRefresh && sessionStorage.getItem(cacheKey)) { buildTimetableDropdown(JSON.parse(sessionStorage.getItem(cacheKey))); return; }

  showLoader(true);
  google.script.run
    .withFailureHandler(err => { showLoader(false); alert("Error: " + err.message); })
    .withSuccessHandler(function(timetable) {
      try { sessionStorage.setItem(cacheKey, JSON.stringify(timetable)); } catch(e){} 
      buildTimetableDropdown(timetable);
    }).getTeacherTimetableByDate(user.id, dateStr); 
}

function buildTimetableDropdown(timetable) {
  const select = document.getElementById('selectClass');
  if(!select) return;
  select.innerHTML = '<option value="">-- ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô --</option>';
  if(document.getElementById('studentRows')) document.getElementById('studentRows').innerHTML = ''; 
  document.getElementById('classInfoCard')?.classList.add('d-none');
  document.getElementById('studentListSection')?.classList.add('d-none');

  if(!timetable || timetable.length === 0) { select.innerHTML = '<option value="">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>'; showLoader(false); return; }
  
  timetable.forEach(item => {
    let opt = document.createElement('option');
    opt.value = JSON.stringify(item);
    opt.text = `‡∏Ñ‡∏≤‡∏ö ${item[5]}: ${item[0]} ${item[1]} (${String(item[2]).trim()})`;
    select.add(opt);
  });

  const pendingStr = sessionStorage.getItem('pending_attendance_item');
  if (pendingStr) {
     try {
         const pendingObj = JSON.parse(pendingStr);
         for(let i = 0; i < select.options.length; i++) {
             if(!select.options[i].value) continue;
             const optObj = JSON.parse(select.options[i].value);
             if(optObj[0] === pendingObj[0] && optObj[2] === pendingObj[2] && String(optObj[5]) === String(pendingObj[5])) {
                 select.selectedIndex = i; break;
             }
         }
     } catch(e) { console.error("Error parsing pending item:", e); }
     if (select.selectedIndex > 0) loadStudentList(); else showLoader(false); 
     sessionStorage.removeItem('pending_attendance_item');
  } else { showLoader(false); }
}

function autoSelectRoom() {
  const val = document.getElementById('selectClass').value;
  if(!val) return;
  const roomSelect = document.getElementById('selectRoom');
  if(roomSelect) roomSelect.value = String(JSON.parse(val)[3]).trim();
  loadStudentList(); 
}

function loadStudentList(forceRefresh = false) {
  const classVal = document.getElementById('selectClass').value;
  const btn = document.getElementById('btnSubmitAll');
  const dateInput = document.getElementById('teachingDate'); 

  if(!classVal) {
      if(btn) btn.disabled = true;
      document.getElementById('classInfoCard')?.classList.add('d-none');
      document.getElementById('studentListSection')?.classList.add('d-none');
      showLoader(false); return;
  }

  const item = JSON.parse(classVal);
  const fullClassName = getRealClassName(); 
  let dateStr = dateInput && dateInput.value ? dateInput.value : new Date().toISOString().split('T')[0];
  
  const isHR = (item[0].toUpperCase() === 'HR' || item[1].includes('‡πÇ‡∏Æ‡∏°‡∏£‡∏π‡∏°'));

  document.getElementById('classInfoCard')?.classList.remove('d-none');
  if(document.getElementById('dispClass')) document.getElementById('dispClass').innerText = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á: ${fullClassName}`;

  // üåü ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß! ‡πÅ‡∏ï‡πà‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏•‡∏á‡πÑ‡∏õ‡πÅ‡∏ó‡∏ô ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
  const topicInput = document.getElementById('inputTopic');
  if(topicInput) {
      if (isHR && !topicInput.value) {
          topicInput.value = "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÇ‡∏Æ‡∏°‡∏£‡∏π‡∏°‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
      } else if (!isHR && topicInput.value === "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÇ‡∏Æ‡∏°‡∏£‡∏π‡∏°‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢") {
          topicInput.value = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏≠‡∏≠‡∏Å‡∏ñ‡πâ‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥
      }
  }

  showLoader(true);
  const cacheKey = `v4_stdlist_${fullClassName}`;

  const fetchHistoryAndRender = (studentsData) => {
      if (isHR) {
          google.script.run
          .withFailureHandler(err => { showLoader(false); renderMorningTable(studentsData, {}); })
          .withSuccessHandler(function(historyData) {
              showLoader(false);
              renderMorningTable(studentsData, historyData || {});
              document.getElementById('studentListSection')?.classList.remove('d-none');
              
              if(btn) {
                  btn.disabled = false;
                  // üåü ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"
                  if(historyData && Object.keys(historyData).length > 0) {
                      btn.innerHTML = '<i class="fas fa-edit me-1"></i> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Æ‡∏°‡∏£‡∏π‡∏° (‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á)';
                      btn.className = "btn btn-warning text-dark w-100 mt-4 py-3 fw-bold shadow-sm";
                  } else {
                      btn.innerHTML = '<i class="fas fa-sun me-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Æ‡∏°‡∏£‡∏π‡∏°';
                      btn.className = "btn btn-primary w-100 mt-4 py-3 fw-bold shadow-sm";
                  }
                  
                  let detailBtn = document.getElementById('btnDetailedSubmit');
                  if(detailBtn) detailBtn.classList.add('d-none');
              }
              setTimeout(setupSignatureCanvas, 200);
          }).getMorningActivityData(dateStr, fullClassName);
      } else {
          google.script.run
          .withFailureHandler(err => { showLoader(false); renderAttendanceTable(studentsData, {}); })
          .withSuccessHandler(function(historyArray) {
              showLoader(false);
              const historyMap = {};
              if (historyArray) { historyArray.forEach(h => { historyMap[h.cleanId] = h.status; historyMap[String(h.studentId).trim()] = h.status; }); }
              renderAttendanceTable(studentsData, historyMap);
              document.getElementById('studentListSection')?.classList.remove('d-none');
              
              if(btn) {
                  btn.disabled = false;
                  if(Object.keys(historyMap).length > 0) {
                      btn.innerHTML = '<i class="fas fa-edit me-1"></i> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô (‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á)';
                      btn.className = "btn btn-warning w-100 mt-4 py-3 fw-bold shadow-sm";
                  } else {
                      btn.innerHTML = '<i class="fas fa-save me-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô';
                      btn.className = "btn btn-primary w-100 mt-4 py-3 fw-bold shadow-sm";
                  }
                  let detailBtn = document.getElementById('btnDetailedSubmit');
                  if(detailBtn) detailBtn.classList.remove('d-none'); 
              }
              setTimeout(setupSignatureCanvas, 200);
          }).getTodayAttendanceHistory(dateStr, item[0], fullClassName);
      }
  };

  if (!forceRefresh && sessionStorage.getItem(cacheKey)) {
      currentStudents = JSON.parse(sessionStorage.getItem(cacheKey));
      fetchHistoryAndRender(currentStudents); 
  } else {
      google.script.run
      .withFailureHandler(err => { showLoader(false); alert("Error: " + err.message); })
      .withSuccessHandler(function(students) {
          currentStudents = students;
          if(!students || students.length === 0) {
              showLoader(false);
              document.getElementById('studentRows').innerHTML = `<tr><td colspan="5" class="text-center p-4 text-danger">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡πâ‡∏≠‡∏á ${fullClassName}</td></tr>`;
              if(btn) btn.disabled = true; return;
          }
          try { sessionStorage.setItem(cacheKey, JSON.stringify(students)); } catch(e){}
          fetchHistoryAndRender(students);
      }).getStudentsByClass(fullClassName);
  }
}

function renderAttendanceTable(students, historyMap = {}) {
  try {
      const tbody = document.getElementById('studentRows');
      if (!tbody) return;
      
      const table = tbody.closest('table');
      if (table) {
          let thead = table.querySelector('thead');
          if (thead) {
              thead.innerHTML = `
                  <tr class="table-primary text-center">
                      <th style="width: 50px;">‡∏ó‡∏µ‡πà</th>
                      <th class="text-start">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                      <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                  </tr>
              `;
          }
      }

      let html = '';
      students.sort((a, b) => String(a[0]).localeCompare(String(b[0])));
      
      students.forEach((s, index) => {
        const rawId = String(s[0]).trim();    
        const cleanId = String(parseInt(rawId, 10)); 
        const stdName = s[2];
        
        let currentStatus = "‡∏°‡∏≤"; let isMatched = false;
        if (historyMap[cleanId]) { currentStatus = historyMap[cleanId]; isMatched = true; } 
        else if (historyMap[rawId]) { currentStatus = historyMap[rawId]; isMatched = true; }
        
        html += `<tr><td class="text-center fw-bold text-muted">${index + 1}</td><td><div class="fw-bold">${stdName}</div><div class="small text-muted">ID: ${rawId} ${isMatched ? '<i class="fas fa-check-circle text-success ms-1"></i>' : ''}</div></td><td><div class="btn-group w-100" role="group"><input type="radio" class="btn-check" name="status_${rawId}" id="present_${rawId}" value="‡∏°‡∏≤" ${currentStatus === '‡∏°‡∏≤' ? 'checked' : ''} onchange="updateSummary()"><label class="btn btn-outline-success btn-sm" for="present_${rawId}">‡∏°‡∏≤</label><input type="radio" class="btn-check" name="status_${rawId}" id="late_${rawId}" value="‡∏™‡∏≤‡∏¢" ${currentStatus === '‡∏™‡∏≤‡∏¢' ? 'checked' : ''} onchange="updateSummary()"><label class="btn btn-outline-warning btn-sm" for="late_${rawId}">‡∏™‡∏≤‡∏¢</label><input type="radio" class="btn-check" name="status_${rawId}" id="leave_${rawId}" value="‡∏•‡∏≤" ${currentStatus === '‡∏•‡∏≤' || currentStatus === 'leave' ? 'checked' : ''} onchange="updateSummary()"><label class="btn btn-outline-info btn-sm" for="leave_${rawId}">‡∏•‡∏≤</label><input type="radio" class="btn-check" name="status_${rawId}" id="absent_${rawId}" value="‡∏Ç‡∏≤‡∏î" ${currentStatus === '‡∏Ç‡∏≤‡∏î' ? 'checked' : ''} onchange="updateSummary()"><label class="btn btn-outline-danger btn-sm" for="absent_${rawId}">‡∏Ç‡∏≤‡∏î</label></div></td></tr>`;
      });
      
      tbody.innerHTML = html;
      if (typeof updateSummary === "function") updateSummary();
      
  } catch(e) {
      console.error("Error in renderAttendanceTable:", e);
  }
}

// ==========================================
// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÇ‡∏Æ‡∏°‡∏£‡∏π‡∏°
// ==========================================

function updateMorningSummary() {
  const present = document.querySelectorAll('input[value="‡∏°‡∏≤"][id^="t_f_"]:checked').length;
  const late = document.querySelectorAll('input[value="‡∏™‡∏≤‡∏¢"][id^="t_f_"]:checked').length;
  const leave = document.querySelectorAll('input[value="‡∏•‡∏≤"][id^="t_f_"]:checked').length;
  const absent = document.querySelectorAll('input[value="‡∏Ç‡∏≤‡∏î"][id^="t_f_"]:checked').length;

  if(document.getElementById('sumPresent')) document.getElementById('sumPresent').innerText = present;
  if(document.getElementById('sumAbsent')) document.getElementById('sumAbsent').innerText = absent;
  if(document.getElementById('sumOther')) document.getElementById('sumOther').innerText = late + leave;

  let absentNames = [], lateNames = [], leaveNames = [], notAreaNames = [], notDutyNames = [];
  
  document.querySelectorAll('#studentRows tr').forEach(tr => {
      const nameDiv = tr.querySelector('.std-name-label'); 
      if(!nameDiv) return;
      const name = nameDiv.innerText;
      
      if(tr.querySelector('input[value="‡∏Ç‡∏≤‡∏î"][id^="t_f_"]:checked')) absentNames.push(name);
      if(tr.querySelector('input[value="‡∏™‡∏≤‡∏¢"][id^="t_f_"]:checked')) lateNames.push(name);
      if(tr.querySelector('input[value="‡∏•‡∏≤"][id^="t_f_"]:checked')) leaveNames.push(name);
      if(tr.querySelector('input[value="‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤"][id^="t_a_"]:checked')) notAreaNames.push(name);
      if(tr.querySelector('input[value="‡πÑ‡∏°‡πà‡∏ó‡∏≥"][id^="t_d_"]:checked')) notDutyNames.push(name);
  });

  const freq = {};
  const allNames = [...absentNames, ...lateNames, ...leaveNames, ...notAreaNames, ...notDutyNames];
  allNames.forEach(name => freq[name] = (freq[name] || 0) + 1);

  const sortNames = (arr) => arr.sort((a, b) => freq[b] !== freq[a] ? freq[b] - freq[a] : a.localeCompare(b, 'th'));

  absentNames = sortNames(absentNames); lateNames = sortNames(lateNames); leaveNames = sortNames(leaveNames);
  notAreaNames = sortNames(notAreaNames); notDutyNames = sortNames(notDutyNames);

  // üåü ‡πÄ‡∏≠‡∏≤‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏≤‡∏≠‡∏≠‡∏Å ‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
  const formatNames = (names) => names.map(n => {
      let countTxt = freq[n] > 1 ? `<span class="text-danger ms-1" style="font-size:0.75rem;">(${freq[n]})</span>` : '';
      return `<span class="d-inline-block text-dark" style="white-space: nowrap;">${n}${countTxt}</span>`;
  }).join('<span class="text-muted mx-1">,</span> ');

  const oldSummary = document.getElementById('morningSummaryAlert');
  if(oldSummary) oldSummary.remove();

  let summaryHtml = `<div id="morningSummaryAlert" class="alert alert-warning shadow-sm py-2 mb-3 border-start border-4 border-warning animate__animated animate__fadeIn"><div class="fw-bold mb-2 text-dark" style="font-size:0.9rem;"><i class="fas fa-clipboard-list me-1"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:</div>`;
  
  if(absentNames.length > 0) summaryHtml += `<div class="text-danger small mb-2"><span class="badge bg-danger me-1">‡∏Ç‡∏≤‡∏î‡πÄ‡∏™‡∏≤‡∏ò‡∏á (${absentNames.length})</span> <span style="line-height:1.8;">${formatNames(absentNames)}</span></div>`;
  if(lateNames.length > 0) summaryHtml += `<div class="text-warning text-dark small mb-2"><span class="badge bg-warning text-dark me-1">‡∏™‡∏≤‡∏¢ (${lateNames.length})</span> <span style="line-height:1.8;">${formatNames(lateNames)}</span></div>`;
  if(leaveNames.length > 0) summaryHtml += `<div class="text-info text-dark small mb-2"><span class="badge bg-info text-dark me-1">‡∏•‡∏≤ (${leaveNames.length})</span> <span style="line-height:1.8;">${formatNames(leaveNames)}</span></div>`;
  if(notAreaNames.length > 0) summaryHtml += `<div class="text-secondary small mb-2"><span class="badge bg-secondary me-1">‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Ç‡∏ï (${notAreaNames.length})</span> <span style="line-height:1.8;">${formatNames(notAreaNames)}</span></div>`;
  if(notDutyNames.length > 0) summaryHtml += `<div class="text-secondary small mb-2"><span class="badge bg-secondary me-1">‡πÑ‡∏°‡πà‡∏ó‡∏≥‡πÄ‡∏ß‡∏£ (${notDutyNames.length})</span> <span style="line-height:1.8;">${formatNames(notDutyNames)}</span></div>`;
  
  if (absentNames.length === 0 && lateNames.length === 0 && leaveNames.length === 0 && notAreaNames.length === 0 && notDutyNames.length === 0) {
      summaryHtml += `<div class="text-success small fw-bold"><i class="fas fa-check-circle me-1"></i>‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô üéâ</div>`;
  }
  summaryHtml += `</div>`;
  
  const tableContainer = document.getElementById('studentRows')?.closest('.table-responsive');
  if(tableContainer) tableContainer.insertAdjacentHTML('beforebegin', summaryHtml);
}

// ==========================================
// 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ‡πÇ‡∏Æ‡∏°‡∏£‡∏π‡∏° ‡∏ö‡∏ô Dashboard
// ==========================================
function loadMorningSummaryDashboard(teacherId, term, year) {
  let container = document.getElementById('morningDashboardContainer');
  if (!container) {
     const scheduleCard = document.getElementById('todayScheduleBody')?.closest('.card');
     const parentRow = scheduleCard?.closest('.row'); 
     if(parentRow) {
         parentRow.insertAdjacentHTML('afterend', '<div class="row mt-4 mb-4"><div class="col-12"><div id="morningDashboardContainer" class="animate__animated animate__fadeInUp"></div></div></div>');
     } else {
         const pageContent = document.getElementById('page-content');
         pageContent.insertAdjacentHTML('beforeend', '<div id="morningDashboardContainer" class="mt-4 mb-4 animate__animated animate__fadeInUp"></div>');
     }
     container = document.getElementById('morningDashboardContainer');
  }

  container.innerHTML = `<div class="text-center p-3"><div class="spinner-border text-warning spinner-border-sm me-2"></div><span class="small text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏£‡∏∏‡∏õ‡πÇ‡∏Æ‡∏°‡∏£‡∏π‡∏°...</span></div>`;

  google.script.run.withSuccessHandler(res => {
     if (!res || !res.hasHR) { container.closest('.row').style.display = 'none'; return; }

     const d = res.data;
     if (!d.hasData) {
        container.innerHTML = `<div class="card border-warning shadow-sm" style="border-radius: 10px;"><div class="card-header bg-warning text-dark fw-bold border-0" style="border-radius: 10px 10px 0 0;"><i class="fas fa-sun me-2"></i>‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏¢‡∏≤‡∏°‡πÄ‡∏ä‡πâ‡∏≤ (‡∏´‡πâ‡∏≠‡∏á ${d.className})</div><div class="card-body text-center py-4 bg-light" style="border-radius: 0 0 10px 10px;"><i class="fas fa-clipboard-list fa-2x text-warning mb-2 opacity-50"></i><div class="text-muted small">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div></div></div>`;
        return;
     }

     const freq = {};
     const allNames = [...d.absent, ...d.late, ...d.leave, ...d.notArea, ...d.notDuty];
     allNames.forEach(name => { freq[name] = (freq[name] || 0) + 1; });

     const sortNames = (arr) => arr.sort((a, b) => freq[b] !== freq[a] ? freq[b] - freq[a] : a.localeCompare(b, 'th'));

     d.absent = sortNames(d.absent); d.late = sortNames(d.late); d.leave = sortNames(d.leave); d.notArea = sortNames(d.notArea); d.notDuty = sortNames(d.notDuty);

     let summaryHtml = `<div class="card border-warning shadow-sm" style="background-color: #fffdf5; border-radius: 10px;"><div class="card-header bg-warning text-dark fw-bold border-0 d-flex justify-content-between align-items-center" style="border-radius: 10px 10px 0 0;"><div><i class="fas fa-sun me-2"></i>‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏¢‡∏≤‡∏°‡πÄ‡∏ä‡πâ‡∏≤ (‡∏´‡πâ‡∏≠‡∏á ${d.className})</div><div class="badge bg-white text-dark shadow-sm">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div></div><div class="card-body p-3 px-4">`;

     if (d.absent.length === 0 && d.late.length === 0 && d.leave.length === 0 && d.notArea.length === 0 && d.notDuty.length === 0) {
         summaryHtml += `<div class="text-success fw-bold text-center py-3"><i class="fas fa-check-circle fa-3x mb-3 text-success opacity-75"></i><br><span style="font-size: 1.1rem;">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô üéâ</span></div>`;
     } else {
         const renderRow = (label, count, names, badgeClass, iconClass) => {
             if (names.length === 0) return '';
             
             const formattedNames = names.map(name => {
                 // üåü ‡πÄ‡∏≠‡∏≤‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏≤‡∏≠‡∏≠‡∏Å ‡πÇ‡∏ä‡∏ß‡πå‡πÅ‡∏Ñ‡πà (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)
                 let freqText = freq[name] > 1 ? `<span class="text-danger ms-1" style="font-size: 0.75rem;">(${freq[name]})</span>` : '';
                 let nameColor = freq[name] > 1 ? 'text-dark' : 'text-secondary';
                 return `<span class="d-inline-block ${nameColor}" style="white-space: nowrap;">${name}${freqText}</span>`;
             }).join('<span class="text-muted mx-1">,</span> ');

             return `<div class="d-flex align-items-start mb-3 pb-2 border-bottom" style="border-color: rgba(0,0,0,0.05) !important;">
                        <div style="min-width: 105px;">
                            <span class="badge ${badgeClass} shadow-sm w-100 py-2 text-start" style="font-size: 0.75rem;">
                                <i class="fas ${iconClass} me-2"></i>${label} (${count})
                            </span>
                        </div>
                        <div class="small ms-3" style="line-height: 1.9; flex-grow: 1;">
                            ${formattedNames}
                        </div>
                     </div>`;
         };
         
         summaryHtml += renderRow('‡∏Ç‡∏≤‡∏î‡πÄ‡∏™‡∏≤‡∏ò‡∏á', d.absent.length, d.absent, 'bg-danger', 'fa-flag');
         summaryHtml += renderRow('‡∏™‡∏≤‡∏¢', d.late.length, d.late, 'bg-warning text-dark', 'fa-clock');
         summaryHtml += renderRow('‡∏•‡∏≤', d.leave.length, d.leave, 'bg-info text-dark', 'fa-envelope-open-text');
         summaryHtml += renderRow('‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Ç‡∏ï', d.notArea.length, d.notArea, 'bg-secondary', 'fa-map-marker-alt');
         summaryHtml += renderRow('‡πÑ‡∏°‡πà‡∏ó‡∏≥‡πÄ‡∏ß‡∏£', d.notDuty.length, d.notDuty, 'bg-secondary', 'fa-broom');
     }
     summaryHtml += `</div></div>`;
     container.innerHTML = summaryHtml;
  }).getTodayMorningSummary(teacherId, term, year);
}

// ==========================================
// 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Æ‡∏°‡∏£‡∏π‡∏° (HR) ‡πÅ‡∏ó‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏õ‡∏Å‡∏ï‡∏¥
// ==========================================
function renderMorningTable(students, historyData = {}) {
  try {
      const tbody = document.getElementById('studentRows');
      if (!tbody) return;
      
      // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
      const table = tbody.closest('table');
      if (table) {
          let thead = table.querySelector('thead');
          if (thead) {
              thead.innerHTML = `
                  <tr class="table-warning text-dark text-center">
                      <th style="width: 40px;">‡∏ó‡∏µ‡πà</th>
                      <th class="text-start ps-3">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                      <th style="min-width: 120px;">‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</th>
                      <th style="min-width: 110px;">‡∏ó‡∏≥‡πÄ‡∏ß‡∏£</th>
                      <th style="min-width: 150px;">‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏≤‡∏ò‡∏á</th>
                  </tr>
              `;
          }
      }

      let html = '';
      students.sort((a, b) => String(a[0]).localeCompare(String(b[0])));
      
      students.forEach((s, index) => {
          const rawId = String(s[0]).trim();
          const cleanId = String(parseInt(rawId, 10)); 
          
          // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡πÉ‡∏´‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏Ç‡∏∂‡πâ‡∏ô ‡∏™‡∏•‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà
          const h = historyData[rawId] || historyData[cleanId] || {};
          const hArea = String(h.area || '‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°').trim();
          const hDuty = String(h.duty || '‡∏ó‡∏≥').trim();
          const hFlag = String(h.flag || '‡∏°‡∏≤').trim();
          
          html += `<tr>
            <td class="text-center text-muted fw-bold align-middle">${index + 1}</td>
            <td class="text-start align-middle px-2">
               <div class="fw-bold text-dark" style="font-size:0.85rem;">${s[2]}</div>
               <div class="small text-muted font-monospace">ID: ${rawId} ${Object.keys(h).length > 0 ? '<i class="fas fa-check-circle text-success ms-1"></i>' : ''}</div>
            </td>
            
            <td class="align-middle"><div class="btn-group btn-group-sm w-100 shadow-sm">
              <input type="radio" class="btn-check" name="area_${rawId}" id="t_a_‡πÄ‡∏Ç‡πâ‡∏≤_${rawId}" value="‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°" ${hArea==='‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°'?'checked':''}>
              <label class="btn btn-outline-info text-dark px-1" for="t_a_‡πÄ‡∏Ç‡πâ‡∏≤_${rawId}">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</label>
              <input type="radio" class="btn-check" name="area_${rawId}" id="t_a_‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤_${rawId}" value="‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤" ${hArea==='‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤'?'checked':''}>
              <label class="btn btn-outline-secondary px-1" for="t_a_‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤_${rawId}">‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤</label>
            </div></td>
            
            <td class="align-middle"><div class="btn-group btn-group-sm w-100 shadow-sm">
              <input type="radio" class="btn-check" name="duty_${rawId}" id="t_d_‡∏ó‡∏≥_${rawId}" value="‡∏ó‡∏≥" ${hDuty==='‡∏ó‡∏≥'?'checked':''}>
              <label class="btn btn-outline-primary px-1" for="t_d_‡∏ó‡∏≥_${rawId}">‡∏ó‡∏≥</label>
              <input type="radio" class="btn-check" name="duty_${rawId}" id="t_d_‡πÑ‡∏°‡πà‡∏ó‡∏≥_${rawId}" value="‡πÑ‡∏°‡πà‡∏ó‡∏≥" ${hDuty==='‡πÑ‡∏°‡πà‡∏ó‡∏≥'?'checked':''}>
              <label class="btn btn-outline-secondary px-1" for="t_d_‡πÑ‡∏°‡πà‡∏ó‡∏≥_${rawId}">‡πÑ‡∏°‡πà‡∏ó‡∏≥</label>
            </div></td>
            
            <td class="align-middle"><div class="btn-group btn-group-sm w-100 shadow-sm">
              <input type="radio" class="btn-check" name="flag_${rawId}" id="t_f_‡∏°‡∏≤_${rawId}" value="‡∏°‡∏≤" ${hFlag==='‡∏°‡∏≤'?'checked':''} onchange="updateMorningSummary()">
              <label class="btn btn-outline-success px-1" for="t_f_‡∏°‡∏≤_${rawId}">‡∏°‡∏≤</label>
              <input type="radio" class="btn-check" name="flag_${rawId}" id="t_f_‡∏™‡∏≤‡∏¢_${rawId}" value="‡∏™‡∏≤‡∏¢" ${hFlag==='‡∏™‡∏≤‡∏¢'?'checked':''} onchange="updateMorningSummary()">
              <label class="btn btn-outline-warning px-1" for="t_f_‡∏™‡∏≤‡∏¢_${rawId}">‡∏™‡∏≤‡∏¢</label>
              <input type="radio" class="btn-check" name="flag_${rawId}" id="t_f_‡∏•‡∏≤_${rawId}" value="‡∏•‡∏≤" ${hFlag==='‡∏•‡∏≤'?'checked':''} onchange="updateMorningSummary()">
              <label class="btn btn-outline-info px-1" for="t_f_‡∏•‡∏≤_${rawId}">‡∏•‡∏≤</label>
              <input type="radio" class="btn-check" name="flag_${rawId}" id="t_f_‡∏Ç‡∏≤‡∏î_${rawId}" value="‡∏Ç‡∏≤‡∏î" ${hFlag==='‡∏Ç‡∏≤‡∏î'?'checked':''} onchange="updateMorningSummary()">
              <label class="btn btn-outline-danger px-1" for="t_f_‡∏Ç‡∏≤‡∏î_${rawId}">‡∏Ç‡∏≤‡∏î</label>
            </div></td>
          </tr>`;
      });
      
      tbody.innerHTML = html;
      if (typeof updateMorningSummary === "function") updateMorningSummary();
      
  } catch(e) {
      console.error("Error in renderMorningTable:", e);
      alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÇ‡∏Æ‡∏°‡∏£‡∏π‡∏°: " + e.message);
  }
}

// ==========================================
// 5. ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô (‡∏•‡πâ‡∏≤‡∏á Event ‡πÄ‡∏Å‡πà‡∏≤ + ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö 100% ‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠)
// ==========================================
function setupSignatureCanvas() {
  const wrapper = document.querySelector('.signature-wrapper');
  if (!wrapper) return;

  // üåü ‡∏ó‡∏∏‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤ ‡∏™‡∏£‡πâ‡∏≤‡∏á element ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏•‡∏¢ ‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡πÄ‡∏≠‡∏µ‡πà‡∏¢‡∏°‡∏≠‡πà‡∏≠‡∏á
  wrapper.innerHTML = '<canvas id="sig-canvas" width="450" height="150" style="touch-action: none; width: 100%; height: 100%; cursor: crosshair;"></canvas>';

  sigCanvas = document.getElementById('sig-canvas');
  sigCtx = sigCanvas.getContext('2d');
  
  sigCtx.lineWidth = 2.5;
  sigCtx.lineCap = 'round';
  sigCtx.lineJoin = 'round';
  sigCtx.strokeStyle = '#000000';
  
  isDrawing = false; // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö

  // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡πÄ‡∏õ‡πä‡∏∞‡∏ó‡∏∏‡∏Å‡∏™‡πÄ‡∏Å‡∏•‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
  const getPos = (e) => {
    const rect = sigCanvas.getBoundingClientRect();
    let clientX = e.clientX;
    let clientY = e.clientY;
    
    if (e.touches && e.touches.length > 0) {
      clientX = e.touches[0].clientX;
      clientY = e.touches[0].clientY;
    } else if (e.changedTouches && e.changedTouches.length > 0) {
      clientX = e.changedTouches[0].clientX;
      clientY = e.changedTouches[0].clientY;
    }
    
    const scaleX = sigCanvas.width / rect.width;
    const scaleY = sigCanvas.height / rect.height;
    
    return {
      x: (clientX - rect.left) * scaleX,
      y: (clientY - rect.top) * scaleY
    };
  };

  const startDraw = (e) => {
    if (e.cancelable) e.preventDefault();
    isDrawing = true;
    const pos = getPos(e);
    sigCtx.beginPath();
    sigCtx.moveTo(pos.x, pos.y);
  };

  const doDraw = (e) => {
    if (e.cancelable) e.preventDefault();
    if (!isDrawing) return;
    const pos = getPos(e);
    sigCtx.lineTo(pos.x, pos.y);
    sigCtx.stroke();
  };

  const stopDraw = (e) => {
    if (e && e.cancelable) e.preventDefault();
    isDrawing = false;
    sigCtx.beginPath();
  };

  // üñ±Ô∏è ‡∏ú‡∏π‡∏Å Event ‡πÄ‡∏°‡∏≤‡∏™‡πå
  sigCanvas.addEventListener('mousedown', startDraw);
  sigCanvas.addEventListener('mousemove', doDraw);
  sigCanvas.addEventListener('mouseup', stopDraw);
  sigCanvas.addEventListener('mouseout', stopDraw);

  // üì± ‡∏ú‡∏π‡∏Å Event ‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠
  sigCanvas.addEventListener('touchstart', startDraw, { passive: false });
  sigCanvas.addEventListener('touchmove', doDraw, { passive: false });
  sigCanvas.addEventListener('touchend', stopDraw, { passive: false });
  sigCanvas.addEventListener('touchcancel', stopDraw, { passive: false });
}

function clearSignature() {
  if (sigCtx && sigCanvas) {
    sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
    sigCtx.beginPath();
  }
}

function getCompressedSignature() {
  if (!sigCanvas) return "";

  const tempCanvas = document.createElement('canvas');
  tempCanvas.width = sigCanvas.width;
  tempCanvas.height = sigCanvas.height;
  const ctx = tempCanvas.getContext('2d');

  ctx.fillStyle = '#FFFFFF';
  ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
  ctx.drawImage(sigCanvas, 0, 0);
  
  return tempCanvas.toDataURL('image/jpeg', 0.5);
}

function drawSig(e) { }

function submitAcademicData() {
  const classVal = document.getElementById('selectClass').value;
  if (!classVal) return;
  const item = JSON.parse(classVal);
  
  const isHR = (item[0].toUpperCase() === 'HR' || item[1].includes('‡πÇ‡∏Æ‡∏°‡∏£‡∏π‡∏°'));
  if (isHR) { submitMorningCheckAcademic(); return; }

  const topic = document.getElementById('inputTopic').value;
  const dateInput = document.getElementById('teachingDate'); 
  const user = getSessionUser();
  
  if(!topic) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö");
  
  // üåü ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏†‡∏≤‡∏û‡πÅ‡∏ó‡∏ô
  const sigData = getCompressedSignature();
  if(sigData.length < 1000) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö");

  const btn = document.getElementById('btnSubmitAll');
  btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

  const now = new Date();
  const localDateStr = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
  let date = dateInput && dateInput.value ? dateInput.value : localDateStr;
  const normalizedClassName = getRealClassName(); 
  
  const attendanceBatch = currentStudents.map(s => {
    return { date: date, term: user.currentTerm, year: user.currentYear, subjectCode: item[0], subjectName: item[1], className: normalizedClassName, period: item[5], studentId: s[0], studentName: s[2], status: document.querySelector(`input[name="status_${s[0]}"]:checked`).value, teacherId: user.id };
  });

  const lessonRecord = {
    date: date, subjectCode: item[0], subjectName: item[1], className: normalizedClassName, period: item[5], topic: topic,
    totalPresent: parseInt(document.getElementById('sumPresent').innerText) + parseInt(document.querySelectorAll('input[value="‡∏™‡∏≤‡∏¢"]:checked').length),
    totalAbsent: document.getElementById('sumAbsent').innerText,
    totalLeave: document.querySelectorAll('input[value="‡∏•‡∏≤"]:checked').length,
    teacherId: user.id, signature: sigData // üåü ‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ
  };

  showLoader(true);
  safeRun(3)
    .withFailureHandler(function(err) { showLoader(false); btn.disabled = false; btn.innerHTML = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'; alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message); })
    .withSuccessHandler(function() {
      safeRun(3)
        .withFailureHandler(function(err) { showLoader(false); btn.disabled = false; btn.innerHTML = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'; alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ï‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô: " + err.message); })
        .withSuccessHandler(function() {
          showLoader(false);
          const userData = sessionStorage.getItem('pssms_user');
          sessionStorage.clear();
          if(userData) sessionStorage.setItem('pssms_user', userData);
          alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
          loadPage('Page_Dashboard_Teacher'); 
      }).saveLessonRecord(lessonRecord);
  }).saveAttendanceBatch(attendanceBatch);
}

// üåü ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå (‡∏ß‡∏¥‡∏ä‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥)
function updateSummary() {
  const present = document.querySelectorAll('input[value="‡∏°‡∏≤"]:checked').length;
  const late = document.querySelectorAll('input[value="‡∏™‡∏≤‡∏¢"]:checked').length;
  const leave = document.querySelectorAll('input[value="‡∏•‡∏≤"]:checked').length;
  const absent = document.querySelectorAll('input[value="‡∏Ç‡∏≤‡∏î"]:checked').length;

  if(document.getElementById('sumPresent')) document.getElementById('sumPresent').innerText = present;
  if(document.getElementById('sumAbsent')) document.getElementById('sumAbsent').innerText = absent;
  if(document.getElementById('sumOther')) document.getElementById('sumOther').innerText = late + leave;

  // ‡∏Å‡∏ß‡∏≤‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏£‡∏∏‡∏õ
  let absentNames = [], lateNames = [], leaveNames = [];
  document.querySelectorAll('#studentRows tr').forEach(tr => {
      const nameDiv = tr.querySelector('.fw-bold');
      if(!nameDiv) return;
      const name = nameDiv.innerText;
      if(tr.querySelector('input[value="‡∏Ç‡∏≤‡∏î"]:checked')) absentNames.push(name);
      if(tr.querySelector('input[value="‡∏™‡∏≤‡∏¢"]:checked')) lateNames.push(name);
      if(tr.querySelector('input[value="‡∏•‡∏≤"]:checked')) leaveNames.push(name);
  });

  const oldSummary = document.getElementById('attendanceSummaryAlert');
  if(oldSummary) oldSummary.remove();

  let summaryHtml = `<div id="attendanceSummaryAlert" class="alert alert-primary shadow-sm py-2 mb-3 border-start border-4 border-primary animate__animated animate__fadeIn">
      <div class="fw-bold mb-1" style="font-size:0.9rem;"><i class="fas fa-users me-1"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥:</div>`;
  if (absentNames.length === 0 && lateNames.length === 0 && leaveNames.length === 0) {
      summaryHtml += `<div class="text-success small fw-bold"><i class="fas fa-check-circle me-1"></i>‡∏°‡∏≤‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô üéâ</div>`;
  } else {
      if(absentNames.length > 0) summaryHtml += `<div class="text-danger small mb-1"><b>‡∏Ç‡∏≤‡∏î (${absentNames.length}):</b> ${absentNames.join(', ')}</div>`;
      if(lateNames.length > 0) summaryHtml += `<div class="text-warning text-dark small mb-1"><b>‡∏™‡∏≤‡∏¢ (${lateNames.length}):</b> ${lateNames.join(', ')}</div>`;
      if(leaveNames.length > 0) summaryHtml += `<div class="text-info text-dark small mb-1"><b>‡∏•‡∏≤ (${leaveNames.length}):</b> ${leaveNames.join(', ')}</div>`;
  }
  summaryHtml += `</div>`;
  
  const tableContainer = document.getElementById('studentRows')?.closest('.table-responsive');
  if(tableContainer) tableContainer.insertAdjacentHTML('beforebegin', summaryHtml);
}

// ==========================================
// 6. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏¢‡∏≤‡∏°‡πÄ‡∏ä‡πâ‡∏≤ (‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å)
// ==========================================
function submitMorningCheckAcademic() {
  const classVal = document.getElementById('selectClass').value;
  const item = JSON.parse(classVal);
  const dateInput = document.getElementById('teachingDate');
  const user = getSessionUser();
  
  const now = new Date();
  const localDateStr = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
  let dateStr = dateInput && dateInput.value ? dateInput.value : localDateStr;
  const className = getRealClassName();
  
  // üåü ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏†‡∏≤‡∏û‡πÅ‡∏ó‡∏ô
  const sigData = getCompressedSignature();
  if(sigData.length < 1000) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö");

  const records = [];
  currentStudents.forEach(s => {
    const stdId = String(s[0]).trim();
    records.push({
      studentId: stdId,
      studentName: s[2],
      area: document.querySelector(`#studentRows input[name="area_${stdId}"]:checked`).value,
      duty: document.querySelector(`#studentRows input[name="duty_${stdId}"]:checked`).value,
      flag: document.querySelector(`#studentRows input[name="flag_${stdId}"]:checked`).value
    });
  });

  const payload = {
    date: dateStr, term: user.currentTerm, year: user.currentYear,
    className: className, teacherId: user.id, records: records
  };

  const btn = document.getElementById('btnSubmitAll');
  const oldText = btn.innerHTML;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
  btn.disabled = true;
  showLoader(true);

  safeRun(3)
    .withSuccessHandler(res => {
      showLoader(false);
      btn.innerHTML = oldText;
      btn.disabled = false;
      alert(res.message);
      const userData = sessionStorage.getItem('pssms_user');
      sessionStorage.clear();
      if(userData) sessionStorage.setItem('pssms_user', userData);
      loadPage('Page_Dashboard_Teacher'); 
    })
    .withFailureHandler(err => {
      showLoader(false);
      btn.innerHTML = oldText;
      btn.disabled = false;
      alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
    })
    .saveMorningActivityBatch(payload);
}

function getSessionUser() { return JSON.parse(localStorage.getItem('pssms_user') || sessionStorage.getItem('pssms_user')); }

// ----------------------------------------------------------------------
// ‡∏ä‡∏∏‡∏î‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Modal ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
// ----------------------------------------------------------------------
function viewTodayHistory() {
  const classVal = document.getElementById('selectClass').value;
  const dateInput = document.getElementById('teachingDate'); 
  if(!classVal) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
  
  const item = JSON.parse(classVal);
  const subjectCode = item[0];
  const className = getRealClassName(); 
  let dateStr = dateInput && dateInput.value ? dateInput.value : new Date().toISOString().split('T')[0];

  showLoader(true);
  google.script.run.withSuccessHandler(function(history) {
    showLoader(false);
    if (!history || history.length === 0) return alert("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏±‡∏ö");
    tempHistoryData = history;
    renderHistoryModal(subjectCode);
  }).getTodayAttendanceHistory(dateStr, subjectCode, className);
}

function viewAllHistory() {
  const classVal = document.getElementById('selectClass').value;
  if(!classVal) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
  
  const item = JSON.parse(classVal);
  const subjectCode = item[0];
  const className = getRealClassName(); 

  showLoader(true);
  google.script.run.withSuccessHandler(function(sessions) {
    showLoader(false);
    renderSessionListModal(sessions, subjectCode, className);
  }).getCourseSessionList(subjectCode, className);
}

function renderSessionListModal(sessions, subjectCode, className) {
  let html = '';
  if (sessions.length === 0) {
    html = '<div class="text-center p-4 text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡πÉ‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ</div>';
  } else {
    html = '<div class="list-group list-group-flush">';
    sessions.forEach(s => {
      html += `<button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-3" onclick="loadHistoryForEdit('${s.date}')"><div><div class="fw-bold text-primary"><i class="fas fa-calendar-alt me-2"></i>${s.displayDate}</div><div class="small text-muted">‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà ${s.period}</div></div><span class="badge bg-light text-dark border rounded-pill">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ${s.count} ‡∏Ñ‡∏ô <i class="fas fa-chevron-right ms-2 text-secondary"></i></span></button>`;
    });
    html += '</div>';
  }

  const modalHtml = `<div id="sessionListModal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:10000; display:flex; align-items:center; justify-content:center; padding:15px;"><div class="bg-white rounded-3 shadow-lg animate__animated animate__fadeInUp" style="width:100%; max-width:500px; max-height:80vh; display:flex; flex-direction:column;"><div class="p-3 bg-primary text-white d-flex justify-content-between align-items-center rounded-top"><h6 class="mb-0 fw-bold"><i class="fas fa-history me-2"></i>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô: ${className}</h6><button class="btn-close btn-close-white" onclick="document.getElementById('sessionListModal').remove()"></button></div><div class="p-0" style="overflow-y:auto;">${html}</div><div class="p-3 bg-light border-top text-center"><button class="btn btn-secondary btn-sm w-100" onclick="document.getElementById('sessionListModal').remove()">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button></div></div></div>`;
  const old = document.getElementById('sessionListModal'); if(old) old.remove();
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function loadHistoryForEdit(dateStr) {
  const modalList = document.getElementById('sessionListModal'); if(modalList) modalList.remove();
  const classVal = document.getElementById('selectClass').value;
  const item = JSON.parse(classVal);
  const subjectCode = item[0];
  const className = getRealClassName(); 
  const dateInput = document.getElementById('teachingDate');
  if(dateInput) { dateInput.value = dateStr; reloadTimetableByDate(); }

  showLoader(true);
  google.script.run.withSuccessHandler(function(historyArray) {
    showLoader(false);
    tempHistoryData = historyArray;
    if (!tempHistoryData || tempHistoryData.length === 0) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î");
    renderHistoryModal(subjectCode);
  }).getTodayAttendanceHistory(dateStr, subjectCode, className);
}

function renderHistoryModal(subjectCode) {
  let html = tempHistoryData.map((h, index) => {
    let badgeClass = h.status === '‡∏°‡∏≤' ? 'bg-success' : (h.status === '‡∏™‡∏≤‡∏¢' ? 'bg-warning text-dark' : 'bg-danger');
    return `<div class="d-flex justify-content-between align-items-center border-bottom py-2"><div style="flex-grow: 1;"><div class="fw-bold" style="font-size: 0.85rem;">${h.studentName}</div><div id="status-badge-${index}" class="badge ${badgeClass}" style="font-size: 0.7rem;">${h.status}</div></div><div class="btn-group btn-group-sm"><button class="btn btn-outline-success" onclick="updateLocalStatus(${index}, '‡∏°‡∏≤')">‡∏°‡∏≤</button><button class="btn btn-outline-warning" onclick="updateLocalStatus(${index}, '‡∏™‡∏≤‡∏¢')">‡∏™‡∏≤‡∏¢</button><button class="btn btn-outline-info" onclick="updateLocalStatus(${index}, '‡∏•‡∏≤')">‡∏•‡∏≤</button><button class="btn btn-outline-danger" onclick="updateLocalStatus(${index}, '‡∏Ç‡∏≤‡∏î')">‡∏Ç‡∏≤‡∏î</button></div></div>`;
  }).join('');

  const modalHtml = `<div id="historyModal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:10000; display:flex; align-items:center; justify-content:center; padding:15px;"><div class="bg-white rounded-3 shadow-lg" style="width:100%; max-width:450px; max-height:85vh; display:flex; flex-direction:column;"><div class="p-3 bg-dark text-white d-flex justify-content-between align-items-center"><h6 class="mb-0 fw-bold"><i class="fas fa-user-edit me-2"></i>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</h6><button class="btn-close btn-close-white" onclick="document.getElementById('historyModal').remove()"></button></div><div class="p-3" style="overflow-y:auto;"><div class="alert alert-secondary small py-1 mb-2">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç" ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</div>${html}</div><div class="p-3 bg-light border-top"><button class="btn btn-primary w-100 fw-bold py-2" onclick="saveAllHistoryChanges()"><i class="fas fa-save me-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button></div></div></div>`;
  const oldModal = document.getElementById('historyModal'); if(oldModal) oldModal.remove();
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function updateLocalStatus(index, newStatus) {
  tempHistoryData[index].status = newStatus;
  const badge = document.getElementById(`status-badge-${index}`);
  badge.innerText = newStatus;
  badge.className = `badge ${newStatus === '‡∏°‡∏≤' ? 'bg-success' : (newStatus === '‡∏™‡∏≤‡∏¢' ? 'bg-warning text-dark' : (newStatus === '‡∏•‡∏≤' ? 'bg-info text-dark' : 'bg-danger'))}`;
}

function saveAllHistoryChanges() {
  if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
  const user = getSessionUser();
  showLoader(true);
  safeRun(3)
    .withFailureHandler(function(err) { showLoader(false); alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message); })
    .withSuccessHandler(function(res) {
    showLoader(false);
    if(res.status === "success") {
      alert("‚úÖ " + res.message);
      document.getElementById('historyModal').remove();
      if(user) sessionStorage.removeItem(`risk_dash_${user.id}_${user.currentTerm}_${user.currentYear}`);
      loadStudentList(true); 
    } else { alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + res.message); }
  }).updateAttendanceBatch(tempHistoryData); 
}

// ==========================================
// 7. ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏™‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (Detailed Lesson)
// ==========================================
function openDetailedLessonModal() {
  const topic = document.getElementById('inputTopic').value;
  if(!topic) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å '‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô' ‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏£‡∏±‡∏ö"); document.getElementById('inputTopic').focus(); return; }
  
  // üåü ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
  const sigData = getCompressedSignature();
  if(sigData.length < 1000) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö"); return; }
  
  document.getElementById('detailedLessonForm').reset();
  const modal = new bootstrap.Modal(document.getElementById('detailedLessonModal'));
  modal.show();
}

function getBase64(file) {
  return new Promise((resolve, reject) => {
    if(!file) { resolve(null); return; }
    const reader = new FileReader(); reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error);
  });
}

async function submitDetailedLesson() {
  const classVal = document.getElementById('selectClass').value;
  const topic = document.getElementById('inputTopic').value;
  const dateInput = document.getElementById('teachingDate'); 
  const user = getSessionUser();
  const item = JSON.parse(classVal);
  let date = dateInput && dateInput.value ? dateInput.value : new Date().toISOString().split('T')[0];
  const normalizedClassName = getRealClassName(); 
  
  const dpaElements = document.querySelectorAll('.dpa-check:checked'); const dpaValues = Array.from(dpaElements).map(el => el.value);
  const skillElements = document.querySelectorAll('.skill-check:checked'); const skillValues = Array.from(skillElements).map(el => el.value);
  const workFile = document.getElementById('dl_work_file').files[0];
  const imageFile = document.getElementById('dl_image_file').files[0];

  const submitBtn = document.querySelector('#detailedLessonModal .btn-primary');
  const originalBtnText = submitBtn.innerHTML;
  submitBtn.disabled = true; submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
  showLoader(true);

  try {
    const workFileBase64 = await getBase64(workFile);
    const imageFileBase64 = await getBase64(imageFile);

    const detailedRecord = {
      date: date, subjectCode: item[0], subjectName: item[1], className: normalizedClassName, period: item[5], topic: topic, teacherId: user.id,
      outcomes: document.getElementById('dl_outcomes').value, problems: document.getElementById('dl_problems').value, solutions: document.getElementById('dl_solutions').value,
      dpa: dpaValues, skills: skillValues, studentResults: document.getElementById('dl_student_results').value, workFileBase64: workFileBase64, imageFileBase64: imageFileBase64
    };

    const attendanceBatch = currentStudents.map(s => {
      return { date: date, term: user.currentTerm, year: user.currentYear, subjectCode: item[0], subjectName: item[1], className: normalizedClassName, period: item[5], studentId: s[0], studentName: s[2], status: document.querySelector(`input[name="status_${s[0]}"]:checked`).value, teacherId: user.id };
    });

    const basicRecord = {
      date: date, subjectCode: item[0], subjectName: item[1], className: normalizedClassName, period: item[5], topic: topic,
      totalPresent: parseInt(document.getElementById('sumPresent').innerText) + parseInt(document.querySelectorAll('input[value="‡∏™‡∏≤‡∏¢"]:checked').length),
      totalAbsent: document.getElementById('sumAbsent').innerText, totalLeave: document.querySelectorAll('input[value="‡∏•‡∏≤"]:checked').length,
      teacherId: user.id, 
      signature: getCompressedSignature() // üåü ‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ
    };

    safeRun(3).withFailureHandler(err => { showLoader(false); submitBtn.disabled = false; submitBtn.innerHTML = originalBtnText; alert("‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠: " + err.message); }).withSuccessHandler(() => {
      safeRun(3).withFailureHandler(err => { showLoader(false); submitBtn.disabled = false; submitBtn.innerHTML = originalBtnText; alert("‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ï‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô: " + err.message); }).withSuccessHandler(() => {
        safeRun(3).withFailureHandler(err => { showLoader(false); submitBtn.disabled = false; submitBtn.innerHTML = originalBtnText; alert("‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ï‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: " + err.message); }).withSuccessHandler((res) => {
          showLoader(false);
          bootstrap.Modal.getInstance(document.getElementById('detailedLessonModal')).hide();
          sessionStorage.removeItem(`risk_dash_${user.id}_${user.currentTerm}_${user.currentYear}`);
          sessionStorage.removeItem(`lesson_history_${user.id}_${user.currentTerm}_${user.currentYear}`);
          alert(res.message);
          loadPage('Page_Dashboard_Teacher'); 
        }).saveDetailedLessonRecord(detailedRecord);
      }).saveLessonRecord(basicRecord);
    }).saveAttendanceBatch(attendanceBatch);

  } catch (err) {
    showLoader(false); submitBtn.disabled = false; submitBtn.innerHTML = originalBtnText; alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
  }
}

// ==========================================
// 8. ACADEMIC REPORT LOGIC
// ==========================================
function initAcademicReportPage() { reloadReportSubjects(); }

function reloadReportSubjects() {
  const termEl = document.getElementById('reportTerm');
  const yearEl = document.getElementById('reportYear');
  const select = document.getElementById('reportClassSelect');
  if(!termEl || !yearEl || !select) return;
  const term = termEl.value; const year = yearEl.value; const user = getSessionUser();

  select.innerHTML = `<option value="">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏¥‡∏ä‡∏≤...</option>`; select.disabled = true;
  const tbody = document.getElementById('reportTableBody'); if(tbody) tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-muted">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤</td></tr>';
  const summaryDiv = document.getElementById('reportSummaryInfo'); if(summaryDiv) summaryDiv.remove();

  const subjectCacheKey = `report_subjects_${user.id}_${term}_${year}`;
  const cachedSubjects = sessionStorage.getItem(subjectCacheKey);
  if (cachedSubjects) { buildReportSubjectDropdown(JSON.parse(cachedSubjects), term, year); return; }

  google.script.run
    .withFailureHandler(err => { select.innerHTML = '<option value="">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</option>'; select.disabled = false; alert(err.message); })
    .withSuccessHandler(subjects => { sessionStorage.setItem(subjectCacheKey, JSON.stringify(subjects)); buildReportSubjectDropdown(subjects, term, year); })
    .getTeacherSubjects(user.id, user.role, term, year);
}

function buildReportSubjectDropdown(subjects, term, year) {
  const select = document.getElementById('reportClassSelect');
  select.disabled = false;
  if(subjects.length === 0) { select.innerHTML = `<option value="">‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏ô‡πÄ‡∏ó‡∏≠‡∏° ${term}/${year}</option>`; return; }
  let html = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ --</option><option value="ALL" class="fw-bold text-white bg-primary">‡∏î‡∏π‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô (‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</option>';
  subjects.forEach(sub => { html += `<option value='${JSON.stringify(sub)}'>${sub[0]} - ${sub[3]} (${sub[1]})</option>`; });
  select.innerHTML = html;
}

function generateReport() {
  const val = document.getElementById('reportClassSelect').value;
  if(!val) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
  const term = document.getElementById('reportTerm').value; const year = document.getElementById('reportYear').value; const user = getSessionUser();
  showLoader(true);

  if (val === "ALL") {
    google.script.run.withFailureHandler(err => { showLoader(false); alert("Error: " + err.message); })
      .withSuccessHandler(function(res) { try { renderAllSubjectsReportTable(res); } catch (e) { showLoader(false); console.error(e); } })
      .getAllSubjectsReport(user.id, term, year);
  } else {
    try {
      const item = JSON.parse(val); 
      google.script.run.withFailureHandler(err => { showLoader(false); alert("Error: " + err.message); })
        .withSuccessHandler(function(res) { try { renderReportTable(res, item[0], item[1], item[2]); } catch (e) { showLoader(false); console.error(e); } })
        .getSemesterReport(item[0], item[2], term, year);
    } catch (e) { showLoader(false); alert("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: " + e.message); }
  }
}

function renderReportTable(res, subjectCode, subjectName, className) {
  showLoader(false);
  const tbody = document.getElementById('reportTableBody'); if (!tbody) return;
  tbody.innerHTML = '';
  const oldHeader = document.getElementById('reportSummaryInfo'); if(oldHeader) oldHeader.remove();

  if(!res || !res.students || res.students.length === 0) { tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ</td></tr>'; return; }

  const data = res.students; const meta = res.meta || { periodsPerWeek: 0, totalCoursePeriods: 0, maxAbsenceQuota: 0, currentTotalTaught: 0 }; 
  const taught = meta.currentTotalTaught; const total = meta.totalCoursePeriods; const progressPercent = total > 0 ? Math.min((taught / total) * 100, 100).toFixed(1) : 0; const remaining = total - taught;
  const critical = []; const ms = []; const risk = [];
  data.forEach(s => { const p = parseFloat(s.percent); if (p < 60) critical.push(s); else if (p < 80) ms.push(s); else if (p <= 85) risk.push(s); });

  const renderList = (arr, colorClass) => {
    if(arr.length === 0) return `<div class="text-center text-muted small py-3">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ üéâ</div>`;
    return arr.map(s => `<div class="d-flex justify-content-between align-items-center border-bottom py-2"><div><div class="fw-bold text-dark" style="font-size: 0.85rem;">${s.id} ${s.name}</div><div class="text-muted" style="font-size: 0.75rem;">‡∏°‡∏≤ <span class="text-success fw-bold">${s.present + s.late}</span>/${taught} ‡∏Ñ‡∏≤‡∏ö (‡∏Ç‡∏≤‡∏î <span class="text-danger">${s.absent}</span>, ‡∏•‡∏≤ <span class="text-info">${s.leave}</span>)</div></div><span class="badge bg-${colorClass} rounded-pill" style="font-size: 0.8rem;">${s.percent}%</span></div>`).join('');
  };

  let infoHtml = `<div id="reportSummaryInfo" class="mb-4 animate__animated animate__fadeIn"><div class="card border-0 shadow-sm mb-4" style="background: linear-gradient(to right, #ffffff, #f8f9fa);"><div class="card-body"><div class="d-flex justify-content-between align-items-center mb-2"><h6 class="fw-bold text-primary m-0"><i class="fas fa-clock me-2"></i>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤: ${subjectCode} ${subjectName} (${className})</h6><span class="badge bg-light text-dark border">‡∏™‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß ${taught} / ${total} ‡∏Ñ‡∏≤‡∏ö</span></div><div class="progress" style="height: 15px; border-radius: 10px; background-color: #e9ecef;"><div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" role="progressbar" style="width: ${progressPercent}%">${progressPercent}%</div></div><div class="d-flex justify-content-between mt-2" style="font-size: 0.8rem;"><span class="text-secondary"><i class="fas fa-info-circle me-1"></i>‡πÄ‡∏Å‡∏ì‡∏ë‡πå: ‡∏Ç‡∏≤‡∏î‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î <b>${meta.maxAbsenceQuota}</b> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (20%)</span><span class="text-success fw-bold">‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å ${remaining > 0 ? remaining : 0} ‡∏Ñ‡∏≤‡∏ö</span></div></div></div><h6 class="fw-bold text-danger mb-3"><i class="fas fa-exclamation-triangle me-2"></i>‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</h6><div class="row g-3 mb-4"><div class="col-md-4"><div class="card border-info shadow-sm h-100"><div class="card-header bg-info text-dark fw-bold small d-flex justify-content-between"><span>‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á (80-85%)</span><span class="badge bg-white text-dark">${risk.length}</span></div><div class="card-body p-2" style="max-height: 250px; overflow-y: auto;">${renderList(risk, 'info text-dark')}</div></div></div><div class="col-md-4"><div class="card border-warning shadow-sm h-100"><div class="card-header bg-warning text-dark fw-bold small d-flex justify-content-between"><span>‡∏ï‡∏¥‡∏î ‡∏°‡∏™. (60-79%)</span><span class="badge bg-white text-dark">${ms.length}</span></div><div class="card-body p-2" style="max-height: 250px; overflow-y: auto;">${renderList(ms, 'warning text-dark')}</div></div></div><div class="col-md-4"><div class="card border-danger shadow-sm h-100"><div class="card-header bg-danger text-white fw-bold small d-flex justify-content-between"><span>‡∏´‡∏°‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (< 60%)</span><span class="badge bg-white text-danger">${critical.length}</span></div><div class="card-body p-2" style="max-height: 250px; overflow-y: auto;">${renderList(critical, 'danger')}</div></div></div></div></div>`;
  const tableEl = document.querySelector('table');
  if(tableEl) { tableEl.insertAdjacentHTML('beforebegin', infoHtml); const theads = tableEl.querySelectorAll('th'); if (theads.length >= 3) { theads[1].innerText = "‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"; theads[2].innerText = "‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•"; } }

  let html = '';
  data.forEach((s, index) => {
    const p = parseFloat(s.percent); const totalMissed = (s.leave || 0) + (s.absent || 0); const remainingQuota = meta.maxAbsenceQuota - totalMissed;
    let statusBadge = ''; let rowClass = ''; let progressColor = ''; let quotaText = '';
    if (remainingQuota >= 0) quotaText = `<span class="text-muted small">‡∏Ç‡∏≤‡∏î‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å <b>${remainingQuota}</b> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>`; else quotaText = `<span class="text-danger fw-bold small">‡πÄ‡∏Å‡∏¥‡∏ô‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤ <b>${Math.abs(remainingQuota)}</b> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>`;
    if (p > 85) { statusBadge = '<span class="badge bg-success rounded-pill px-2">‡∏õ‡∏Å‡∏ï‡∏¥</span>'; progressColor = 'bg-success'; } else if (p >= 80) { statusBadge = '<span class="badge bg-info text-dark rounded-pill px-2">‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á</span>'; progressColor = 'bg-info'; } else if (p >= 60) { statusBadge = '<span class="badge bg-warning text-dark rounded-pill px-2">‡∏°‡∏™.</span>'; rowClass = 'table-warning'; progressColor = 'bg-warning'; } else { statusBadge = '<span class="badge bg-danger rounded-pill px-2">‡∏´‡∏°‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</span>'; rowClass = 'table-danger'; progressColor = 'bg-danger'; }
    html += `<tr class="${rowClass}"><td class="text-center small">${index + 1}</td><td><div class="fw-bold text-primary small">${s.id}</div></td><td><div class="fw-bold small">${s.name}</div></td><td class="text-center"><span class="text-success fw-bold">${s.present}</span> <span class="text-muted">/</span> <span class="text-warning fw-bold">${s.late}</span></td><td class="text-center"><span class="text-info">${s.leave}</span> <span class="text-muted">/</span> <span class="text-danger fw-bold">${s.absent}</span><div class="mt-1">${quotaText}</div></td><td style="vertical-align: middle;"><div class="d-flex align-items-center"><div class="flex-grow-1 me-2"><div class="progress" style="height: 6px;"><div class="progress-bar ${progressColor}" style="width: ${p}%"></div></div></div><span class="fw-bold small ${p < 80 ? 'text-danger' : 'text-success'}">${p}%</span></div></td><td class="text-center">${statusBadge}</td></tr>`;
  });
  tbody.innerHTML = html;
}

function renderAllSubjectsReportTable(data) {
  showLoader(false);
  const tbody = document.getElementById('reportTableBody'); if (!tbody) return;
  tbody.innerHTML = '';
  const oldHeader = document.getElementById('reportSummaryInfo'); if(oldHeader) oldHeader.remove();
  if(!data || data.length === 0) { tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡πÄ‡∏ó‡∏≠‡∏°‡∏ô‡∏µ‡πâ</td></tr>'; return; }

  const critical = []; const ms = []; const risk = [];
  data.forEach(s => { const p = parseFloat(s.percent); if (p < 60) critical.push(s); else if (p < 80) ms.push(s); else if (p <= 85) risk.push(s); });
  const renderList = (arr, colorClass) => {
    if(arr.length === 0) return `<div class="text-center text-muted small py-3">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ üéâ</div>`;
    return arr.map(s => `<div class="d-flex justify-content-between align-items-center border-bottom py-2"><div style="flex-grow:1; padding-right:10px;"><div class="fw-bold text-dark" style="font-size: 0.85rem;">${s.id} ${s.name}</div><div class="text-primary" style="font-size: 0.75rem;"><i class="fas fa-book me-1"></i>${s.subjectCode} (${s.className})</div></div><span class="badge bg-${colorClass} rounded-pill" style="font-size: 0.8rem;">${s.percent}%</span></div>`).join('');
  };

  let infoHtml = `<div id="reportSummaryInfo" class="mb-4 animate__animated animate__fadeIn"><div class="card border-0 shadow-sm mb-4 bg-primary text-white text-center py-3" style="border-radius: 10px;"><h5 class="fw-bold m-0"><i class="fas fa-layer-group me-2"></i>‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</h5><div class="small mt-1 opacity-75">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <b>${data.length}</b> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤)</div></div><h6 class="fw-bold text-danger mb-3"><i class="fas fa-exclamation-triangle me-2"></i>‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤)</h6><div class="row g-3 mb-4"><div class="col-md-4"><div class="card border-info shadow-sm h-100"><div class="card-header bg-info text-dark fw-bold small d-flex justify-content-between"><span>‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á (80-85%)</span><span class="badge bg-white text-dark">${risk.length}</span></div><div class="card-body p-2" style="max-height: 250px; overflow-y: auto;">${renderList(risk, 'info text-dark')}</div></div></div><div class="col-md-4"><div class="card border-warning shadow-sm h-100"><div class="card-header bg-warning text-dark fw-bold small d-flex justify-content-between"><span>‡∏ï‡∏¥‡∏î ‡∏°‡∏™. (60-79%)</span><span class="badge bg-white text-dark">${ms.length}</span></div><div class="card-body p-2" style="max-height: 250px; overflow-y: auto;">${renderList(ms, 'warning text-dark')}</div></div></div><div class="col-md-4"><div class="card border-danger shadow-sm h-100"><div class="card-header bg-danger text-white fw-bold small d-flex justify-content-between"><span>‡∏´‡∏°‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (< 60%)</span><span class="badge bg-white text-danger">${critical.length}</span></div><div class="card-body p-2" style="max-height: 250px; overflow-y: auto;">${renderList(critical, 'danger')}</div></div></div></div></div>`;
  const tableEl = document.querySelector('table');
  if(tableEl) { tableEl.insertAdjacentHTML('beforebegin', infoHtml); const theads = tableEl.querySelectorAll('th'); if (theads.length >= 3) { theads[1].innerText = "‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"; theads[2].innerText = "‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•"; } }

  let html = ''; let currentGroup = ''; let studentIndex = 1; 
  data.forEach((s) => {
    const p = parseFloat(s.percent); const remainingQuota = s.remainingQuota; const groupKey = `${s.subjectCode}_${s.className}`;
    if (groupKey !== currentGroup) {
      studentIndex = 1; 
      html += `<tr style="background-color: #e7f1ff; border-top: 2px solid #0d6efd; border-bottom: 2px solid #0d6efd;"><td colspan="7" class="fw-bold text-primary text-start py-3 ps-3"><i class="fas fa-book-open me-2 text-primary"></i> <span style="font-size: 1.05rem;">‡∏ß‡∏¥‡∏ä‡∏≤: ${s.subjectCode} ${s.subjectName}</span><span class="badge bg-primary rounded-pill ms-2" style="font-size:0.85rem;"><i class="fas fa-users me-1"></i>‡∏´‡πâ‡∏≠‡∏á ${s.className}</span><span class="badge bg-light text-dark border ms-2 shadow-sm">‡∏™‡∏≠‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ${s.taught} ‡∏Ñ‡∏≤‡∏ö</span></td></tr>`;
      currentGroup = groupKey;
    }
    let statusBadge = ''; let rowClass = ''; let progressColor = ''; let quotaText = '';
    if (remainingQuota >= 0) quotaText = `<span class="text-muted small">‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤ <b>${remainingQuota}</b></span>`; else quotaText = `<span class="text-danger fw-bold small">‡πÄ‡∏Å‡∏¥‡∏ô <b>${Math.abs(remainingQuota)}</b></span>`;
    if (p > 85) { statusBadge = '<span class="badge bg-success rounded-pill px-2">‡∏õ‡∏Å‡∏ï‡∏¥</span>'; progressColor = 'bg-success'; } else if (p >= 80) { statusBadge = '<span class="badge bg-info text-dark rounded-pill px-2">‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á</span>'; progressColor = 'bg-info'; } else if (p >= 60) { statusBadge = '<span class="badge bg-warning text-dark rounded-pill px-2">‡∏°‡∏™.</span>'; rowClass = 'table-warning'; progressColor = 'bg-warning'; } else { statusBadge = '<span class="badge bg-danger rounded-pill px-2">‡∏´‡∏°‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</span>'; rowClass = 'table-danger'; progressColor = 'bg-danger'; }
    html += `<tr class="${rowClass}"><td class="text-center small">${studentIndex++}</td><td><div class="fw-bold text-primary small">${s.id}</div></td><td><div class="fw-bold small">${s.name}</div></td><td class="text-center"><span class="text-success fw-bold">${s.present}</span> <span class="text-muted">/</span> <span class="text-warning fw-bold">${s.late}</span></td><td class="text-center"><span class="text-info">${s.leave}</span> <span class="text-muted">/</span> <span class="text-danger fw-bold">${s.absent}</span><div class="mt-1">${quotaText}</div></td><td style="vertical-align: middle;"><div class="d-flex align-items-center"><div class="flex-grow-1 me-2"><div class="progress" style="height: 6px;"><div class="progress-bar ${progressColor}" style="width: ${p}%"></div></div></div><span class="fw-bold small ${p < 80 ? 'text-danger' : 'text-success'}">${p}%</span></div></td><td class="text-center">${statusBadge}</td></tr>`;
  });
  tbody.innerHTML = html;
}

// ==========================================
// 9. ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏¢‡∏≤‡∏°‡πÄ‡∏ä‡πâ‡∏≤ / ‡πÇ‡∏Æ‡∏°‡∏£‡∏π‡∏° (UI & Logic)
// ==========================================
let currentMorningStudents = [];

// 1. ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Æ‡∏°‡∏£‡∏π‡∏°
function openMorningCheckModal(item) {
  const fullClassName = String(item[2]).trim(); // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á (‡πÄ‡∏ä‡πà‡∏ô 4/1)
  const now = new Date();
  const dateStr = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
  
  showLoader(true);
  
  // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á ‡πÅ‡∏•‡∏∞ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡∏°‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
  google.script.run.withSuccessHandler(function(students) {
     currentMorningStudents = students;
     google.script.run.withSuccessHandler(function(historyData) {
        showLoader(false);
        renderMorningCheckModal(students, historyData, fullClassName, dateStr);
     }).getMorningActivityData(dateStr, fullClassName);
  }).getStudentsByClass(fullClassName);
}

// 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á Pop-up
function renderMorningCheckModal(students, historyData, className, dateStr) {
  let html = '';
  students.sort((a, b) => String(a[0]).localeCompare(String(b[0])));
  
  students.forEach((s, index) => {
    const rawId = String(s[0]).trim();
    const cleanId = String(parseInt(rawId, 10)); // üåü ‡∏Å‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏î‡∏ô‡∏ï‡∏±‡∏î‡πÄ‡∏•‡∏Ç 0
    const stdName = s[2];
    
    // üåü ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏ö‡∏ö‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ (‡πÅ‡∏°‡∏ï‡∏ä‡πå‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏°‡∏µ 0 ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ 0)
    const h = historyData[rawId] || historyData[cleanId] || {};
    let hArea = String(h.area || '').trim(); 
    let hDuty = String(h.duty || '').trim();
    let hFlag = String(h.flag || '').trim();
    
    // üõ†Ô∏è Auto-Converter
    if (["‡∏°‡∏≤", "‡∏™‡∏≤‡∏¢", "‡∏•‡∏≤", "‡∏Ç‡∏≤‡∏î"].includes(hArea) || ["‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°", "‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤"].includes(hFlag)) {
        let tempArea = hArea;
        hArea = ["‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°", "‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤"].includes(hFlag) ? hFlag : '‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°';
        hFlag = ["‡∏°‡∏≤", "‡∏™‡∏≤‡∏¢", "‡∏•‡∏≤", "‡∏Ç‡∏≤‡∏î"].includes(tempArea) ? tempArea : '‡∏°‡∏≤';
    }
    if (hDuty === '‡∏°‡∏≤‡∏ó‡∏≥') hDuty = '‡∏ó‡∏≥';
    if (hDuty === '‡πÑ‡∏°‡πà‡∏°‡∏≤') hDuty = '‡πÑ‡∏°‡πà‡∏ó‡∏≥';
    
    if (!hArea) hArea = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°';
    if (!hDuty) hDuty = '‡∏ó‡∏≥';
    if (!hFlag) hFlag = '‡∏°‡∏≤';
    
    // üåü ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠ name ‡πÄ‡∏õ‡πá‡∏ô modal_ ‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏µ‡∏Å‡∏±‡∏ô‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥
    html += `<tr>
      <td class="text-center text-muted fw-bold align-middle">${index + 1}</td>
      <td class="text-start align-middle px-2">
         <div class="fw-bold text-dark" style="font-size:0.85rem;">${stdName}</div>
         <div class="small text-muted font-monospace">ID: ${rawId} ${Object.keys(h).length > 0 ? '<i class="fas fa-check-circle text-success ms-1"></i>' : ''}</div>
      </td>
      
      <td class="align-middle"><div class="btn-group btn-group-sm w-100 shadow-sm">
        <input type="radio" class="btn-check" name="modal_area_${rawId}" id="m_a_‡πÄ‡∏Ç‡πâ‡∏≤_${rawId}" value="‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°" ${hArea==='‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°'?'checked':''}>
        <label class="btn btn-outline-info text-dark px-1" for="m_a_‡πÄ‡∏Ç‡πâ‡∏≤_${rawId}">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</label>
        <input type="radio" class="btn-check" name="modal_area_${rawId}" id="m_a_‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤_${rawId}" value="‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤" ${hArea==='‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤'?'checked':''}>
        <label class="btn btn-outline-secondary px-1" for="m_a_‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤_${rawId}">‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤</label>
      </div></td>
      
      <td class="align-middle"><div class="btn-group btn-group-sm w-100 shadow-sm">
        <input type="radio" class="btn-check" name="modal_duty_${rawId}" id="m_d_‡∏ó‡∏≥_${rawId}" value="‡∏ó‡∏≥" ${hDuty==='‡∏ó‡∏≥'?'checked':''}>
        <label class="btn btn-outline-primary px-1" for="m_d_‡∏ó‡∏≥_${rawId}">‡∏ó‡∏≥</label>
        <input type="radio" class="btn-check" name="modal_duty_${rawId}" id="m_d_‡πÑ‡∏°‡πà‡∏ó‡∏≥_${rawId}" value="‡πÑ‡∏°‡πà‡∏ó‡∏≥" ${hDuty==='‡πÑ‡∏°‡πà‡∏ó‡∏≥'?'checked':''}>
        <label class="btn btn-outline-secondary px-1" for="m_d_‡πÑ‡∏°‡πà‡∏ó‡∏≥_${rawId}">‡πÑ‡∏°‡πà‡∏ó‡∏≥</label>
      </div></td>
      
      <td class="align-middle"><div class="btn-group btn-group-sm w-100 shadow-sm">
        <input type="radio" class="btn-check" name="modal_flag_${rawId}" id="m_f_‡∏°‡∏≤_${rawId}" value="‡∏°‡∏≤" ${hFlag==='‡∏°‡∏≤'?'checked':''}>
        <label class="btn btn-outline-success px-1" for="m_f_‡∏°‡∏≤_${rawId}">‡∏°‡∏≤</label>
        <input type="radio" class="btn-check" name="modal_flag_${rawId}" id="m_f_‡∏™‡∏≤‡∏¢_${rawId}" value="‡∏™‡∏≤‡∏¢" ${hFlag==='‡∏™‡∏≤‡∏¢'?'checked':''}>
        <label class="btn btn-outline-warning px-1" for="m_f_‡∏™‡∏≤‡∏¢_${rawId}">‡∏™‡∏≤‡∏¢</label>
        <input type="radio" class="btn-check" name="modal_flag_${rawId}" id="m_f_‡∏•‡∏≤_${rawId}" value="‡∏•‡∏≤" ${hFlag==='‡∏•‡∏≤'?'checked':''}>
        <label class="btn btn-outline-info px-1" for="m_f_‡∏•‡∏≤_${rawId}">‡∏•‡∏≤</label>
        <input type="radio" class="btn-check" name="modal_flag_${rawId}" id="m_f_‡∏Ç‡∏≤‡∏î_${rawId}" value="‡∏Ç‡∏≤‡∏î" ${hFlag==='‡∏Ç‡∏≤‡∏î'?'checked':''}>
        <label class="btn btn-outline-danger px-1" for="m_f_‡∏Ç‡∏≤‡∏î_${rawId}">‡∏Ç‡∏≤‡∏î</label>
      </div></td>
    </tr>`;
  });

  const modalHtml = `
  <div class="modal fade" id="morningCheckModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-fullscreen-lg-down">
      <div class="modal-content bg-light" style="border-radius: 12px; overflow: hidden;">
        <div class="modal-header bg-warning text-dark border-0 p-3 shadow-sm" style="z-index: 10;">
          <div>
            <h5 class="modal-title fw-bold mb-0"><i class="fas fa-sun me-2 text-primary"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÇ‡∏Æ‡∏°‡∏£‡∏π‡∏° & ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏≤‡∏ò‡∏á</h5>
            <div class="small fw-bold mt-1 text-secondary"><i class="fas fa-users me-1"></i>‡∏´‡πâ‡∏≠‡∏á ${className} | <i class="fas fa-calendar-alt me-1 ms-2"></i>${formatThaiDate(dateStr)}</div>
          </div>
          <button type="button" class="btn-close shadow-none" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0">
          <div class="table-responsive bg-white" style="max-height: 65vh;">
            <table class="table table-hover align-middle mb-0 text-center text-nowrap">
              <thead class="table-light text-muted small sticky-top shadow-sm" style="z-index: 5;">
                <tr>
                  <th style="width: 40px;">‡∏ó‡∏µ‡πà</th>
                  <th class="text-start ps-3">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                  <th style="min-width: 120px;">‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</th>
                  <th style="min-width: 110px;">‡∏ó‡∏≥‡πÄ‡∏ß‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</th>
                  <th style="min-width: 150px;">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏≤‡∏ò‡∏á</th>
                </tr>
              </thead>
              <tbody>${html}</tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer bg-white border-top p-3 d-flex justify-content-between align-items-center">
          <span class="text-muted small d-none d-md-inline"><i class="fas fa-database me-1"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡πÅ‡∏¢‡∏Å‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>
          <button class="btn btn-success fw-bold px-5 py-2 shadow-sm w-sm-100" onclick="submitMorningCheck('${dateStr}', '${className}')">
            <i class="fas fa-save me-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Æ‡∏°‡∏£‡∏π‡∏°
          </button>
        </div>
      </div>
    </div>
  </div>`;

  const oldModal = document.getElementById('morningCheckModal');
  if(oldModal) oldModal.remove();
  document.body.insertAdjacentHTML('beforeend', modalHtml);
  
  const modal = new bootstrap.Modal(document.getElementById('morningCheckModal'), { backdrop: 'static' });
  modal.show();
}

// 3. ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
function submitMorningCheck(dateStr, className) {
  const user = getSessionUser();
  const records = [];
  
  currentMorningStudents.forEach(s => {
    const rawId = String(s[0]).trim();
    // üåü ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å name ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ modal_ ‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤
    records.push({
      studentId: rawId,
      studentName: s[2],
      area: document.querySelector(`input[name="modal_area_${rawId}"]:checked`).value,
      duty: document.querySelector(`input[name="modal_duty_${rawId}"]:checked`).value,
      flag: document.querySelector(`input[name="modal_flag_${rawId}"]:checked`).value
    });
  });

  const payload = {
    date: dateStr,
    term: user.currentTerm,
    year: user.currentYear,
    className: className,
    teacherId: user.id,
    records: records
  };

  const btn = document.querySelector('#morningCheckModal .btn-success');
  const oldText = btn.innerHTML;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
  btn.disabled = true;

  safeRun(3)
    .withSuccessHandler(res => {
      btn.innerHTML = oldText;
      btn.disabled = false;
      bootstrap.Modal.getInstance(document.getElementById('morningCheckModal')).hide();
      showToast(res.message, "success");
    })
    .withFailureHandler(err => {
      btn.innerHTML = oldText;
      btn.disabled = false;
      alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
    })
    .saveMorningActivityBatch(payload);
}

// ==========================================
// 10. LESSON HISTORY DASHBOARD
// ==========================================
let allLessonHistories = []; 

function initLessonHistoryPage() {
  const user = getSessionUser();
  if(!user) return;
  if(document.getElementById('history-header-info')) document.getElementById('history-header-info').innerText = `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô: ${user.name} | ‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${user.currentTerm}/${user.currentYear}`;
  const cacheKey = `lesson_history_${user.id}_${user.currentTerm}_${user.currentYear}`;

  if (sessionStorage.getItem(cacheKey)) {
     allLessonHistories = JSON.parse(sessionStorage.getItem(cacheKey));
     renderLessonHistoryCards(allLessonHistories); return;
  }
  showLoader(true);
  google.script.run.withFailureHandler(err => { showLoader(false); alert("Error: " + err.message); })
    .withSuccessHandler(res => { showLoader(false); sessionStorage.setItem(cacheKey, JSON.stringify(res)); allLessonHistories = res; renderLessonHistoryCards(res); })
    .getDetailedLessonRecords(user.id, user.currentTerm, user.currentYear);
}

function filterLessonHistory() {
  const keyword = document.getElementById('searchLessonHistory').value.toLowerCase();
  const filtered = allLessonHistories.filter(item => item.subjectCode.toLowerCase().includes(keyword) || item.subjectName.toLowerCase().includes(keyword) || item.className.toLowerCase().includes(keyword) || item.topic.toLowerCase().includes(keyword));
  renderLessonHistoryCards(filtered);
}

function renderLessonHistoryCards(data) {
  const container = document.getElementById('lessonHistoryContainer'); if(!container) return;
  if (data.length === 0) { container.innerHTML = `<div class="col-12 text-center p-5 text-muted"><i class="fas fa-folder-open fa-3x mb-3 opacity-25"></i><h5>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ô‡πÄ‡∏ó‡∏≠‡∏°‡∏ô‡∏µ‡πâ</h5></div>`; return; }

  let html = '';
  data.forEach((item, index) => {
    const dpaBadges = item.dpa.length > 0 ? item.dpa.map(d => `<span class="badge bg-info text-dark me-1 mb-1 shadow-sm">${d}</span>`).join('') : '<span class="text-muted small">- ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏ -</span>';
    const skillBadges = item.skills.length > 0 ? item.skills.map(s => `<span class="badge bg-warning text-dark me-1 mb-1 shadow-sm">${s}</span>`).join('') : '<span class="text-muted small">- ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏ -</span>';
    let attachments = ''; let availableFiles = [];
    if (item.workUrl && !item.workUrl.includes("Error")) availableFiles.push({ url: item.workUrl, title: '‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏•‡∏á‡∏≤‡∏ô/‡∏ä‡∏¥‡πâ‡∏ô‡∏á‡∏≤‡∏ô' });
    if (item.imageUrl && !item.imageUrl.includes("Error")) availableFiles.push({ url: item.imageUrl, title: '‡∏†‡∏≤‡∏û‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏®' });
    if (availableFiles.length > 0) {
      const encodedFiles = encodeURIComponent(JSON.stringify(availableFiles));
      attachments += `<hr class="text-muted mt-2 mb-2"><div class="d-flex gap-2">`;
      availableFiles.forEach((file, fIndex) => {
         let btnClass = fIndex === 0 ? "btn-outline-primary" : "btn-outline-success"; let icon = fIndex === 0 ? "fa-file-alt" : "fa-image";
         attachments += `<button type="button" onclick="openGalleryModal('${encodedFiles}', ${fIndex})" class="btn btn-sm ${btnClass}"><i class="fas ${icon} me-1"></i> ${file.title}</button>`;
      });
      attachments += `</div>`;
    }
    const safeTs = encodeURIComponent(item.timestamp);
    html += `<div class="col-md-6 col-xl-4"><div class="card shadow-sm border-0 w-100 mb-2" style="border-radius: 12px; overflow: hidden;"><div class="card-header bg-dark text-white p-3 d-flex justify-content-between align-items-start gap-2 position-relative"><div style="min-width: 90px;"><span class="badge bg-light text-dark fw-bold mb-1">${formatThaiDate(item.date)}</span><div class="small"><i class="fas fa-clock me-1"></i> ‡∏Ñ‡∏≤‡∏ö ${item.period}</div></div><div class="text-end pe-4" style="flex-grow: 1;"><div class="fw-bold text-info" style="font-size: 0.9rem; line-height: 1.2; margin-bottom: 3px;">${item.subjectCode} ${item.subjectName}</div><div class="badge bg-primary">‡∏´‡πâ‡∏≠‡∏á ${item.className}</div></div><div class="dropdown position-absolute" style="top: 12px; right: 10px;"><button class="btn btn-sm text-white opacity-75 shadow-none p-1" type="button" data-bs-toggle="dropdown"><i class="fas fa-ellipsis-v fa-lg"></i></button><ul class="dropdown-menu dropdown-menu-end shadow"><li><a class="dropdown-item" href="javascript:void(0)" onclick="openEditLessonHistory('${safeTs}')"><i class="fas fa-edit me-2 text-warning"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</a></li><li><hr class="dropdown-divider"></li><li><a class="dropdown-item text-danger" href="javascript:void(0)" onclick="deleteLessonHistory('${safeTs}')"><i class="fas fa-trash-alt me-2"></i> ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ</a></li></ul></div></div><div class="card-body bg-white"><h6 class="fw-bold text-primary mb-3 pb-2 border-bottom"><i class="fas fa-lightbulb me-2"></i>${item.topic}</h6><div class="mb-3"><div class="small fw-bold text-secondary mb-1">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ:</div><div class="small text-dark bg-light p-2 rounded border-start border-3 border-success" style="white-space: pre-wrap; font-size: 0.8rem;">${item.outcomes || '-'}</div></div><div class="row g-2 mb-3"><div class="col-6"><div class="small fw-bold text-danger mb-1"><i class="fas fa-exclamation-circle me-1"></i> ‡∏õ‡∏±‡∏ç‡∏´‡∏≤:</div><div class="small text-dark bg-light p-2 rounded border-start border-3 border-danger" style="white-space: pre-wrap; font-size: 0.8rem;">${item.problems || '-'}</div></div><div class="col-6"><div class="small fw-bold text-success mb-1"><i class="fas fa-check-circle me-1"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:</div><div class="small text-dark bg-light p-2 rounded border-start border-3 border-info" style="white-space: pre-wrap; font-size: 0.8rem;">${item.solutions || '-'}</div></div></div><div><div class="mb-2"><div class="small fw-bold text-secondary mb-1" style="font-size: 0.75rem;">‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î DPA:</div><div>${dpaBadges}</div></div><div class="mb-2"><div class="small fw-bold text-secondary mb-1" style="font-size: 0.75rem;">‡∏ó‡∏±‡∏Å‡∏©‡∏∞ 3R8C:</div><div>${skillBadges}</div></div>${attachments}</div></div></div></div>`;
  });
  container.innerHTML = html;
}

function deleteLessonHistory(encodedTs) {
  if(!confirm("‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏™‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ)")) return;
  const ts = decodeURIComponent(encodedTs); showLoader(true);
  google.script.run.withSuccessHandler(res => { showLoader(false); alert(res.message); if(res.status === 'success') { const user = getSessionUser(); sessionStorage.removeItem(`lesson_history_${user.id}_${user.currentTerm}_${user.currentYear}`); initLessonHistoryPage(); } }).deleteDetailedLessonRecord(ts);
}

function openEditLessonHistory(encodedTs) {
  const ts = decodeURIComponent(encodedTs); const item = allLessonHistories.find(i => String(i.timestamp) === ts); if(!item) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
  document.getElementById('edit_dl_ts').value = ts; document.getElementById('edit_dl_topic').value = item.topic; document.getElementById('edit_dl_outcomes').value = item.outcomes; document.getElementById('edit_dl_problems').value = item.problems; document.getElementById('edit_dl_solutions').value = item.solutions; document.getElementById('edit_dl_student_results').value = item.studentResults;
  document.querySelectorAll('.edit-dpa-check').forEach(cb => cb.checked = false); document.querySelectorAll('.edit-skill-check').forEach(cb => cb.checked = false);
  item.dpa.forEach(val => { const cb = document.querySelector(`.edit-dpa-check[value="${val}"]`); if(cb) cb.checked = true; });
  item.skills.forEach(val => { const cb = document.querySelector(`.edit-skill-check[value="${val}"]`); if(cb) cb.checked = true; });
  const modal = new bootstrap.Modal(document.getElementById('editLessonHistoryModal')); modal.show();
}

async function saveEditLessonHistory() {
  const ts = document.getElementById('edit_dl_ts').value;
  const dpaElements = document.querySelectorAll('.edit-dpa-check:checked'); const dpaValues = Array.from(dpaElements).map(el => el.value);
  const skillElements = document.querySelectorAll('.edit-skill-check:checked'); const skillValues = Array.from(skillElements).map(el => el.value);
  const workFile = document.getElementById('edit_dl_work_file').files[0]; const imageFile = document.getElementById('edit_dl_image_file').files[0];
  const btn = document.getElementById('btnSaveEditLesson'); const oldText = btn.innerHTML; btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
  try {
    const workFileBase64 = await getBase64(workFile); const imageFileBase64 = await getBase64(imageFile);
    const record = { topic: document.getElementById('edit_dl_topic').value, outcomes: document.getElementById('edit_dl_outcomes').value, problems: document.getElementById('edit_dl_problems').value, solutions: document.getElementById('edit_dl_solutions').value, dpa: dpaValues, skills: skillValues, studentResults: document.getElementById('edit_dl_student_results').value, workFileBase64: workFileBase64, imageFileBase64: imageFileBase64 };
    safeRun(3)
      .withFailureHandler(err => { btn.disabled = false; btn.innerHTML = oldText; alert("‚ùå Error: " + err.message); })
      .withSuccessHandler(res => { btn.disabled = false; btn.innerHTML = oldText; bootstrap.Modal.getInstance(document.getElementById('editLessonHistoryModal')).hide(); alert(res.message); if (res.status === 'success') { const user = getSessionUser(); sessionStorage.removeItem(`lesson_history_${user.id}_${user.currentTerm}_${user.currentYear}`); initLessonHistoryPage(); } })
      .updateDetailedLessonRecord(ts, record);
  } catch(e) { btn.disabled = false; btn.innerHTML = oldText; alert("Error: " + e.message); }
}



// ==========================================
// üåü ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û/‡πÑ‡∏ü‡∏•‡πå ‡πÅ‡∏ö‡∏ö Popup
// ==========================================
let galleryItems = []; let galleryCurrentIndex = 0;
function openGalleryModal(encodedFiles, startIndex) {
  galleryItems = JSON.parse(decodeURIComponent(encodedFiles)); galleryCurrentIndex = parseInt(startIndex);
  let modalEl = document.getElementById('galleryViewerModal');
  if (!modalEl) {
    const modalHtml = `<div class="modal fade" id="galleryViewerModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-xl modal-dialog-centered" style="max-width: 90vw;"><div class="modal-content bg-dark" style="height: 85vh; border-radius: 12px; overflow: hidden;"><div class="modal-header border-0 text-white p-3" style="background-color: rgba(0,0,0,0.6); position: absolute; width: 100%; z-index: 10;"><h6 class="modal-title fw-bold" id="galleryViewerTitle">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h6><button type="button" class="btn-close btn-close-white shadow-none" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body p-0 position-relative"><div class="position-absolute top-50 start-50 translate-middle text-white text-center" style="z-index: 1;"><div class="spinner-border text-light mb-2" role="status"></div><div class="small">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Drive...</div></div><iframe id="galleryViewerIframe" src="" width="100%" height="100%" style="border: none; position: relative; z-index: 2; background-color: white;"></iframe><button id="btnGalleryPrev" class="btn btn-dark position-absolute top-50 start-0 translate-middle-y ms-3 shadow-lg" style="z-index: 10; border-radius: 50%; width: 50px; height: 50px; opacity: 0.85;" onclick="navigateGallery(-1)"><i class="fas fa-chevron-left fa-lg"></i></button><button id="btnGalleryNext" class="btn btn-dark position-absolute top-50 end-0 translate-middle-y me-3 shadow-lg" style="z-index: 10; border-radius: 50%; width: 50px; height: 50px; opacity: 0.85;" onclick="navigateGallery(1)"><i class="fas fa-chevron-right fa-lg"></i></button></div></div></div></div>`;
    document.body.insertAdjacentHTML('beforeend', modalHtml); modalEl = document.getElementById('galleryViewerModal');
  }
  updateGalleryView(); const modal = new bootstrap.Modal(modalEl); modal.show();
}

function updateGalleryView() {
  const item = galleryItems[galleryCurrentIndex];
  document.getElementById('galleryViewerTitle').innerHTML = `<i class="fas fa-search-plus me-2 text-info"></i> ${item.title} <span class="badge bg-light text-dark ms-2" style="font-size:0.75rem;">${galleryCurrentIndex + 1} / ${galleryItems.length}</span>`;
  let embedUrl = item.url; if (embedUrl && embedUrl.includes('/view')) embedUrl = embedUrl.replace(/\/view.*/, '/preview');
  document.getElementById('galleryViewerIframe').src = embedUrl;
  const showNav = galleryItems.length > 1 ? 'block' : 'none'; document.getElementById('btnGalleryPrev').style.display = showNav; document.getElementById('btnGalleryNext').style.display = showNav;
}

function navigateGallery(direction) {
  galleryCurrentIndex += direction;
  if (galleryCurrentIndex < 0) galleryCurrentIndex = galleryItems.length - 1;
  if (galleryCurrentIndex >= galleryItems.length) galleryCurrentIndex = 0;
  updateGalleryView(); 
}

// ==========================================
// 11. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô AI-Insights
// ==========================================
function analyzeProblems() {
  const body = document.getElementById('problemAnalysisBody');
  const recordsWithProblems = allLessonHistories.filter(item => { const p = item.problems ? item.problems.trim() : ""; return p !== "" && p !== "-"; });
  if (recordsWithProblems.length === 0) { body.innerHTML = `<div class="text-center p-5 text-muted"><i class="fas fa-smile-beam fa-4x mb-3 text-success"></i><h5 class="fw-bold text-success">‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö!</h5><p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏∏‡∏õ‡∏™‡∏£‡∏£‡∏Ñ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö</p></div>`; new bootstrap.Modal(document.getElementById('problemAnalysisModal')).show(); return; }
  body.innerHTML = `<div class="text-center p-5 animate__animated animate__fadeIn"><div class="spinner-grow text-danger mb-3" style="width: 3rem; height: 3rem;" role="status"></div><h5 class="fw-bold text-danger animate__animated animate__pulse animate__infinite">PSSMS AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</h5><p class="text-muted small">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏° ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏à‡∏±‡∏¢ (CAR)</p></div>`;
  const modal = new bootstrap.Modal(document.getElementById('problemAnalysisModal')); modal.show();
  setTimeout(() => { runSmartAIAnalysis(recordsWithProblems, body); }, 1500);
}

function runSmartAIAnalysis(records, body) {
  const categories = {
    "‡∏î‡πâ‡∏≤‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡πÉ‡∏à": { keywords: ["‡∏Ñ‡∏∏‡∏¢", "‡πÄ‡∏•‡πà‡∏ô", "‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå", "‡∏´‡∏•‡∏±‡∏ö", "‡πÑ‡∏°‡πà‡∏™‡∏ô‡πÉ‡∏à", "‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡∏±‡∏á", "‡∏ß‡∏≠‡∏Å‡πÅ‡∏ß‡∏Å", "‡∏™‡∏°‡∏≤‡∏ò‡∏¥", "‡πÄ‡∏ö‡∏∑‡πà‡∏≠", "‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à", "‡πÄ‡∏Å‡∏°", "‡∏Å‡∏ß‡∏ô", "‡πÅ‡∏Å‡∏•‡πâ‡∏á", "‡∏ó‡∏∞‡πÄ‡∏•‡∏≤‡∏∞", "‡πÄ‡∏´‡∏°‡πà‡∏≠", "‡∏´‡∏¢‡∏≠‡∏Å", "‡∏û‡∏π‡∏î‡πÅ‡∏ó‡∏£‡∏Å", "‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πà‡∏ß‡∏°‡∏°‡∏∑‡∏≠", "‡∏Ç‡∏≤‡∏î‡∏™‡∏°‡∏≤‡∏ò‡∏¥", "‡πÇ‡∏ã‡πÄ‡∏ä‡∏µ‡∏¢‡∏•", "‡πÅ‡∏ä‡∏ó", "‡πÅ‡∏ï‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤", "‡∏Å‡∏¥‡∏ô‡∏Ç‡∏ô‡∏°", "‡∏ã‡∏ô", "‡∏´‡∏≤‡∏ß", "‡∏ü‡∏∏‡∏ö", "‡∏ô‡∏¥‡∏ô‡∏ó‡∏≤", "‡∏ï‡∏µ‡∏Å‡∏±‡∏ô", "‡∏ß‡∏¥‡πà‡∏á‡πÄ‡∏•‡πà‡∏ô", "‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏û‡πà‡∏ô‡∏û‡πà‡∏≤‡∏ô", "‡πÑ‡∏°‡πà‡∏ü‡∏±‡∏á", "‡∏´‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏á", "‡∏Ñ‡∏∏‡∏¢‡∏Ç‡πâ‡∏≤‡∏°‡πÇ‡∏ï‡πä‡∏∞", "‡πÄ‡∏•‡πà‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠", "‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏•‡∏á", "‡πÄ‡∏Ñ‡∏≤‡∏∞‡πÇ‡∏ï‡πä‡∏∞", "‡πÇ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á", "‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°", "‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ï‡∏∑‡∏≠‡∏£‡∏∑‡∏≠‡∏£‡πâ‡∏ô", "‡πÄ‡∏â‡∏∑‡πà‡∏≠‡∏¢‡∏ä‡∏≤", "‡∏ô‡∏¥‡πà‡∏á‡πÄ‡∏â‡∏¢", "‡∏Å‡πâ‡∏≤‡∏ß‡∏£‡πâ‡∏≤‡∏ß", "‡∏´‡∏¢‡∏≤‡∏ö‡∏Ñ‡∏≤‡∏¢", "‡∏û‡∏π‡∏î‡∏Ñ‡∏≥‡∏´‡∏¢‡∏≤‡∏ö", "‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏≤‡∏£‡∏û", "‡∏ï‡πà‡∏≠‡∏ï‡πâ‡∏≤‡∏ô", "‡∏ä‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Ñ‡∏∏‡∏¢", "‡πÅ‡∏≠‡∏ö‡∏Å‡∏¥‡∏ô", "‡πÑ‡∏°‡πà‡∏à‡∏î", "‡∏ô‡∏±‡πà‡∏á‡πÄ‡∏´‡∏°‡πà‡∏≠", "‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ", "‡πÄ‡∏ã‡∏•‡∏ü‡∏µ‡πà", "‡∏ï‡∏∞‡πÇ‡∏Å‡∏ô", "‡∏£‡∏ö‡∏Å‡∏ß‡∏ô", "‡∏î‡∏∑‡πâ‡∏≠", "‡πÑ‡∏°‡πà‡∏ô‡∏¥‡πà‡∏á", "‡∏¢‡∏∏‡∏Å‡∏¢‡∏¥‡∏Å", "‡∏•‡∏∏‡∏Å‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà", "‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ‡πÄ‡∏•‡πà‡∏ô", "‡∏û‡∏±‡∏ö‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©", "‡∏ü‡∏±‡∏á‡πÄ‡∏û‡∏•‡∏á", "‡πÉ‡∏™‡πà‡∏´‡∏π‡∏ü‡∏±‡∏á", "‡∏™‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡∏à‡∏Å", "‡∏´‡∏ß‡∏µ‡∏ú‡∏°", "‡∏ó‡∏≤‡∏•‡∏¥‡∏õ", "‡∏Ñ‡∏∏‡∏¢‡πÅ‡∏ó‡∏£‡∏Å", "‡πÄ‡∏ñ‡∏µ‡∏¢‡∏á", "‡∏´‡∏±‡∏ß‡πÄ‡∏£‡∏≤‡∏∞", "‡πÇ‡∏´‡∏ß‡∏Å‡πÄ‡∏´‡∏ß‡∏Å", "‡∏á‡πà‡∏ß‡∏á", "‡∏≠‡∏¥‡∏î‡∏≠‡∏≠‡∏î", "‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏â‡∏±‡∏ö‡∏Å‡∏£‡∏∞‡πÄ‡∏â‡∏á", "‡∏ñ‡∏≠‡∏ô‡∏´‡∏≤‡∏¢‡πÉ‡∏à", "‡πÑ‡∏£‡πâ‡∏™‡∏°‡∏≤‡∏ò‡∏¥", "‡∏•‡∏≠‡∏¢‡πÑ‡∏õ‡∏•‡∏≠‡∏¢‡∏°‡∏≤", "‡πÑ‡∏°‡πà‡∏à‡∏î‡∏à‡πà‡∏≠", "‡∏´‡∏•‡∏∏‡∏Å‡∏´‡∏•‡∏¥‡∏Å", "‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏±‡∏ô", "‡∏´‡∏¢‡∏≠‡∏Å‡∏•‡πâ‡∏≠", "‡∏Å‡πà‡∏≠‡∏Å‡∏ß‡∏ô", "‡∏£‡∏±‡∏á‡πÅ‡∏Å", "‡∏ö‡∏π‡∏•‡∏•‡∏µ‡πà", "‡πÑ‡∏°‡πà‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°", "‡πÄ‡∏•‡πà‡∏ô‡∏´‡∏±‡∏ß", "‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡πÉ‡∏à"], count: 0, items: [] },
    "‡∏î‡πâ‡∏≤‡∏ô‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ": { keywords: ["‡∏ä‡πâ‡∏≤", "‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à", "‡∏•‡∏∑‡∏°", "‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô", "‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å", "‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô", "‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç", "‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì", "‡∏¢‡∏≤‡∏Å", "‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ô", "‡∏™‡∏±‡∏ö‡∏™‡∏ô", "‡∏™‡∏≠‡∏ö", "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô", "‡∏ï‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ô", "‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå", "‡∏™‡∏£‡∏∏‡∏õ", "‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì", "‡∏≠‡πà‡∏≠‡∏ô", "‡∏ó‡∏±‡∏Å‡∏©‡∏∞", "‡∏à‡∏±‡∏ö‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°", "‡∏ï‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°", "‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ", "‡∏ó‡∏î‡∏•‡∏≠‡∏á", "‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏Å‡∏ï‡πå", "‡∏ó‡∏≥‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ", "‡∏Ñ‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô", "‡∏≠‡πà‡∏≤‡∏ô‡∏™‡∏∞‡∏Å‡∏î", "‡∏™‡∏∞‡∏Å‡∏î‡∏Ñ‡∏≥", "‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡∏∞‡∏Å‡∏∏‡∏Å‡∏ï‡∏∞‡∏Å‡∏±‡∏Å", "‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ú‡∏¥‡∏î", "‡∏•‡∏≤‡∏¢‡∏°‡∏∑‡∏≠", "‡∏≠‡πà‡∏≤‡∏ô‡∏ä‡πâ‡∏≤", "‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ä‡πâ‡∏≤", "‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á", "‡∏ï‡∏µ‡πÇ‡∏à‡∏ó‡∏¢‡πå", "‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏Å", "‡∏Ñ‡∏¥‡∏î‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å", "‡∏à‡∏≥‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ", "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏∑‡∏°‡∏´‡∏•‡∏±‡∏á", "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥", "‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤", "‡∏™‡∏±‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå", "‡πÅ‡∏¢‡∏Å‡πÅ‡∏¢‡∏∞", "‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ", "‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ", "‡πÑ‡∏°‡πà‡∏Å‡∏•‡πâ‡∏≤‡∏ï‡∏≠‡∏ö", "‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î", "‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ú‡∏¥‡∏î", "‡∏°‡πÇ‡∏ô‡∏ó‡∏±‡∏®‡∏ô‡πå‡∏Ñ‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô", "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÄ‡∏î‡∏¥‡∏°", "‡∏•‡∏∑‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤", "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ", "‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô‡∏†‡∏≤‡∏û", "‡∏ô‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å", "‡∏Ç‡∏≤‡∏î‡∏ó‡∏±‡∏Å‡∏©‡∏∞", "‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ", "‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô", "‡∏ó‡∏≥‡∏ú‡∏¥‡∏î‡∏™‡πÄ‡∏ï‡πá‡∏õ", "‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤", "‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô", "‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á", "‡∏á‡∏á", "‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô", "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏•‡∏∂‡∏Å", "‡πÑ‡∏°‡πà‡∏ö‡∏£‡∏£‡∏•‡∏∏", "‡∏ï‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô", "‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå", "‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡∏¥‡∏°", "‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏°", "‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ï‡∏Å", "‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏¥‡∏î", "‡∏ö‡∏ß‡∏Å‡πÄ‡∏•‡∏Ç‡∏ú‡∏¥‡∏î", "‡∏™‡∏π‡∏ï‡∏£‡∏Ñ‡∏ì‡∏¥‡∏ï", "‡∏ó‡πà‡∏≠‡∏á‡∏à‡∏≥", "‡∏û‡∏£‡∏µ‡πÄ‡∏ã‡∏ô‡∏ï‡πå", "‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠", "‡∏Ç‡∏≤‡∏î‡πÑ‡∏´‡∏ß‡∏û‡∏£‡∏¥‡∏ö", "‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤", "‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡πà‡∏≠‡∏ô", "‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ä‡πâ‡∏≤", "‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ"], count: 0, items: [] },
    "‡∏î‡πâ‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ô‡∏±‡∏¢": { keywords: ["‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô", "‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô", "‡∏™‡∏≤‡∏¢", "‡∏Ç‡∏≤‡∏î", "‡∏´‡∏ô‡∏µ", "‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå", "‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠", "‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤", "‡∏•‡∏∑‡∏°‡∏ô‡∏≥", "‡∏†‡∏≤‡∏£‡∏∞‡∏á‡∏≤‡∏ô", "‡∏ß‡∏¥‡∏ô‡∏±‡∏¢", "‡∏ï‡∏£‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏ß‡∏•‡∏≤", "‡∏•‡∏≠‡∏Å", "‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï", "‡∏Ç‡πâ‡∏≠‡∏ï‡∏Å‡∏•‡∏á", "‡∏Å‡∏é", "‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö", "‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢", "‡∏•‡∏∞‡∏ó‡∏¥‡πâ‡∏á", "‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏≤‡∏¢", "‡∏ú‡∏•‡∏±‡∏î‡∏ß‡∏±‡∏ô", "‡∏Ñ‡πâ‡∏≤‡∏á", "‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á", "‡∏î‡∏¥‡∏ô‡∏™‡∏≠", "‡∏õ‡∏≤‡∏Å‡∏Å‡∏≤", "‡∏™‡∏°‡∏∏‡∏î", "‡∏´‡∏≤‡∏¢", "‡∏ó‡∏¥‡πâ‡∏á", "‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö", "‡πÇ‡∏î‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "‡∏°‡∏≤‡∏™‡∏≤‡∏¢", "‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ä‡πâ‡∏≤", "‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô", "‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏≤‡∏™", "‡∏•‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô", "‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡πÅ‡∏ó‡∏ô", "‡∏Å‡πä‡∏≠‡∏õ‡∏õ‡∏µ‡πâ", "‡∏ß‡∏≤‡∏á‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏ß‡πâ", "‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á", "‡πÑ‡∏°‡πà‡∏ó‡∏≥‡πÄ‡∏ß‡∏£", "‡∏™‡∏Å‡∏õ‡∏£‡∏Å", "‡∏ó‡∏¥‡πâ‡∏á‡∏Ç‡∏¢‡∏∞", "‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "‡∏´‡∏ô‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "‡πÅ‡∏≠‡∏ö‡∏´‡∏ô‡∏µ", "‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á", "‡∏≠‡πâ‡∏≤‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•", "‡πÅ‡∏Å‡πâ‡∏ï‡∏±‡∏ß", "‡πÄ‡∏•‡∏ó", "‡πÑ‡∏°‡πà‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß", "‡∏™‡∏°‡∏∏‡∏î‡∏´‡∏°‡∏î", "‡∏•‡∏∑‡∏°‡πÄ‡∏≠‡∏≤‡∏°‡∏≤", "‡∏•‡∏∑‡∏°‡∏ó‡∏≥", "‡∏Ñ‡πâ‡∏≤‡∏á‡∏™‡πà‡∏á", "‡∏ú‡∏•‡∏±‡∏î‡∏ß‡∏±‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏û‡∏£‡∏∏‡πà‡∏á", "‡∏´‡∏°‡∏±‡∏Å‡∏´‡∏°‡∏°", "‡∏î‡∏≠‡∏á‡∏á‡∏≤‡∏ô", "‡πÑ‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô", "‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô", "‡∏Ç‡∏≤‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö", "‡πÑ‡∏°‡πà‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏™‡∏±‡∏ç‡∏ç‡∏≤", "‡∏ú‡∏¥‡∏î‡∏ô‡∏±‡∏î", "‡∏•‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô", "‡πÅ‡∏≠‡∏ö‡∏î‡∏π", "‡∏•‡∏∑‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠", "‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡∏ß‡∏ú‡∏¥‡∏î‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö", "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏´‡∏•‡∏∏‡∏î", "‡∏ú‡∏°‡∏¢‡∏≤‡∏ß", "‡πÑ‡∏°‡πà‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Å‡∏é", "‡∏ù‡πà‡∏≤‡∏ù‡∏∑‡∏ô", "‡∏Ç‡∏±‡∏î‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á"], count: 0, items: [] },
    "‡∏î‡πâ‡∏≤‡∏ô‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°‡πÅ‡∏•‡∏∞‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£": { keywords: ["‡πÄ‡∏ô‡πá‡∏ï", "‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï", "‡∏Ñ‡∏≠‡∏°", "‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡πÄ‡∏ï‡∏≠‡∏£‡πå", "‡∏£‡πâ‡∏≠‡∏ô", "‡πÑ‡∏ü‡∏î‡∏±‡∏ö", "‡∏ù‡∏ô‡∏ï‡∏Å", "‡∏û‡∏±‡∏á", "‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏£‡∏ö‡∏Å‡∏ß‡∏ô", "‡πÅ‡∏≠‡∏≠‡∏±‡∏î", "‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì", "‡∏à‡∏≠", "‡∏Ñ‡∏±‡∏ö‡πÅ‡∏Ñ‡∏ö", "‡∏≠‡∏≤‡∏Å‡∏≤‡∏®", "‡∏°‡∏∑‡∏î", "‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°", "‡∏ä‡∏≥‡∏£‡∏∏‡∏î", "‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà", "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠", "‡πÑ‡∏°‡∏Ñ‡πå", "‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô", "‡∏•‡∏≥‡πÇ‡∏û‡∏á", "‡∏™‡∏∞‡∏î‡∏∏‡∏î", "‡∏´‡∏•‡∏∏‡∏î", "‡∏Ñ‡πâ‡∏≤‡∏á", "‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡∏Å", "‡πÅ‡∏≠‡∏£‡πå‡πÄ‡∏™‡∏µ‡∏¢", "‡∏û‡∏±‡∏î‡∏•‡∏°", "‡∏≠‡∏ö‡∏≠‡πâ‡∏≤‡∏ß", "‡∏´‡∏ô‡∏≤‡∏ß", "‡πÅ‡∏™‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á", "‡∏°‡∏∑‡∏î‡πÑ‡∏õ", "‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å", "‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á", "‡∏ï‡∏±‡∏î‡∏´‡∏ç‡πâ‡∏≤", "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "‡∏Ç‡∏±‡∏î‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞", "‡πÅ‡∏Ç‡∏Å‡∏°‡∏≤‡πÄ‡∏¢‡∏∑‡∏≠‡∏ô", "‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®", "‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏•‡πá‡∏ï", "‡πÇ‡∏ó‡∏£‡∏ó‡∏±‡∏®‡∏ô‡πå", "‡∏™‡∏≤‡∏¢ HDMI", "‡∏õ‡∏•‡∏±‡πä‡∏Å‡πÑ‡∏ü", "‡πÇ‡∏ï‡πä‡∏∞‡∏û‡∏±‡∏á", "‡πÄ‡∏Å‡πâ‡∏≤‡∏≠‡∏µ‡πâ‡πÄ‡∏™‡∏µ‡∏¢", "‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏∞‡∏≠‡∏≤‡∏î", "‡∏ù‡∏∏‡πà‡∏ô", "‡πÄ‡∏´‡∏°‡πá‡∏ô", "‡∏Å‡∏•‡∏¥‡πà‡∏ô", "‡∏≠‡∏¥‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï", "‡∏´‡∏•‡∏∏‡∏î‡∏ö‡πà‡∏≠‡∏¢", "‡πÑ‡∏ß‡πÑ‡∏ü", "wifi", "‡∏ä‡πâ‡∏≤‡∏°‡∏≤‡∏Å", "‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô", "‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏û‡∏≠", "‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠", "‡πÅ‡∏ö‡πà‡∏á‡∏Å‡∏±‡∏ô", "‡πÅ‡∏¢‡πà‡∏á‡∏Å‡∏±‡∏ô", "‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£", "‡∏ù‡∏ô‡∏ï‡∏Å‡∏´‡∏ô‡∏±‡∏Å", "‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°", "‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏ó‡∏£‡∏Å", "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ä‡∏ô", "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏£‡∏¥‡πâ‡∏ô", "‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏´‡∏°‡∏î", "‡∏´‡∏°‡∏∂‡∏Å‡∏´‡∏°‡∏î", "‡πÅ‡∏ö‡∏ï‡∏´‡∏°‡∏î"], count: 0, items: [] },
    "‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ": { keywords: [], count: 0, items: [] }
  };

  records.forEach(item => {
     let matched = false; const text = (item.problems + " " + item.outcomes).toLowerCase();
     for (const cat in categories) {
        if(cat === "‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ") continue;
        if (categories[cat].keywords.some(kw => text.includes(kw))) { categories[cat].count++; categories[cat].items.push(item); matched = true; break; }
     }
     if(!matched) { categories["‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ"].count++; categories["‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ"].items.push(item); }
  });

  let topCat = "‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ"; let maxCount = -1;
  for (const cat in categories) { if (categories[cat].count > maxCount && cat !== "‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ") { maxCount = categories[cat].count; topCat = cat; } }

  let aiInsight = "";
  if (topCat === "‡∏î‡πâ‡∏≤‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡πÉ‡∏à") { aiInsight = "üìå <b>AI ‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤ (CAR):</b> ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏£‡πà‡∏ß‡∏° ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á <span class='text-primary fw-bold'>'‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏£‡πà‡∏ß‡∏°‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£ Gamification (‡πÄ‡∏Å‡∏°‡∏°‡∏¥‡∏ü‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô) ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°‡πÅ‡∏£‡∏á‡∏ó‡∏≤‡∏á‡∏ö‡∏ß‡∏Å'</span> ‡∏´‡∏£‡∏∑‡∏≠ <span class='text-primary fw-bold'>'‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ Active Learning ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏°‡πà‡∏û‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'</span>"; } 
  else if (topCat === "‡∏î‡πâ‡∏≤‡∏ô‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ") { aiInsight = "üìå <b>AI ‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤ (CAR):</b> ‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á <span class='text-primary fw-bold'>'‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ú‡∏•‡∏™‡∏±‡∏°‡∏§‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ä‡πâ‡∏≤ ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô (Peer-Assisted Learning) ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡∏™‡∏∑‡πà‡∏≠‡∏°‡∏±‡∏•‡∏ï‡∏¥‡∏°‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡πÄ‡∏ä‡∏¥‡∏á‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö'</span> ‡∏´‡∏£‡∏∑‡∏≠ <span class='text-primary fw-bold'>'‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏î‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡πÅ‡∏ö‡∏ö‡∏ù‡∏∂‡∏Å‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•'</span>"; } 
  else if (topCat === "‡∏î‡πâ‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ô‡∏±‡∏¢") { aiInsight = "üìå <b>AI ‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤ (CAR):</b> ‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏ß‡∏¥‡∏ô‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡πà‡∏ô‡∏ä‡∏±‡∏î ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á <span class='text-primary fw-bold'>'‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ô‡∏±‡∏¢‡πÉ‡∏ô‡∏ï‡∏ô‡πÄ‡∏≠‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à‡πÅ‡∏ö‡∏ö‡πÇ‡∏ó‡πÄ‡∏Ñ‡∏ô (Token Economy) ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô'</span>"; } 
  else if (topCat === "‡∏î‡πâ‡∏≤‡∏ô‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°‡πÅ‡∏•‡∏∞‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£") { aiInsight = "üìå <b>AI ‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤:</b> ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏° ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ <span class='text-primary fw-bold'>'‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡πÅ‡∏ö‡∏ö‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô (Flexible Lesson Plan) ‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡∏ö Unplugged (‡πÑ‡∏°‡πà‡∏û‡∏∂‡πà‡∏á‡∏û‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤/‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï) ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏™‡∏°‡∏≠'</span> ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏ù‡πà‡∏≤‡∏¢‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á"; } 
  else { aiInsight = "üìå <b>AI ‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤:</b> ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏•‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ï‡∏±‡∏ß ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ <span class='text-primary fw-bold'>'‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (Individual Analysis)'</span> ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢ (Differentiated Instruction) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ñ‡∏£‡∏±‡∏ö"; }

  let html = `<div class="card border-0 shadow-sm mb-4 rounded-3" style="background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);"><div class="card-body"><div class="d-flex align-items-center mb-3 pb-2 border-bottom"><div class="bg-danger text-white rounded-circle d-flex justify-content-center align-items-center me-3 shadow" style="width: 45px; height: 45px;"><i class="fas fa-brain fa-lg"></i></div><div><h6 class="fw-bold mb-0 text-danger">PSSMS AI-Insights</h6><div class="small text-muted">‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <b>${records.length}</b> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div></div></div><div class="d-flex flex-wrap gap-2 mb-3">`;
  for (const cat in categories) { if (categories[cat].count > 0) { let badgeColor = cat === topCat ? "bg-danger" : "bg-secondary"; let isTopAlert = cat === topCat ? '<i class="fas fa-exclamation-circle ms-1 animate__animated animate__flash animate__infinite"></i>' : ''; html += `<span class="badge ${badgeColor} p-2 shadow-sm" style="font-size: 0.85rem; border-radius: 8px;">${cat} : ‡∏û‡∏ö ${categories[cat].count} ‡∏Ñ‡∏≤‡∏ö ${isTopAlert}</span>`; } }
  html += `</div><div class="alert alert-primary mb-0 shadow-sm border-start border-4 border-primary"><div class="d-flex"><i class="fas fa-lightbulb fa-2x text-warning me-3"></i><div style="font-size: 0.9rem; line-height: 1.5;">${aiInsight}</div></div></div></div></div><h6 class="fw-bold text-dark mb-3"><i class="fas fa-list-ul me-2"></i>‡πÄ‡∏à‡∏≤‡∏∞‡∏•‡∏∂‡∏Å‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h6>`;

  for (const cat in categories) {
     if (categories[cat].items.length > 0) {
        let catIcon = "fa-folder"; if(cat.includes("‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°")) catIcon = "fa-user-ninja"; else if(cat.includes("‡∏ó‡∏±‡∏Å‡∏©‡∏∞")) catIcon = "fa-chart-line"; else if(cat.includes("‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö")) catIcon = "fa-clipboard-check"; else if(cat.includes("‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°")) catIcon = "fa-wifi";
        html += `<div class="mb-4"><span class="badge bg-dark fs-6 mb-2 shadow-sm"><i class="fas ${catIcon} me-2"></i>${cat}</span><div class="list-group shadow-sm border-0" style="border-radius: 10px; overflow: hidden;">`;
        categories[cat].items.forEach(item => {
          html += `<div class="list-group-item border-start border-4 border-danger border-top-0 border-end-0 border-bottom"><div class="d-flex justify-content-between small mb-2 bg-light p-1 rounded"><span class="fw-bold text-primary"><i class="fas fa-book me-1"></i>${item.subjectCode} (‡∏´‡πâ‡∏≠‡∏á ${item.className})</span><span class="text-secondary"><i class="fas fa-calendar-alt me-1"></i>${formatThaiDate(item.date)}</span></div><div style="font-size: 0.85rem; line-height: 1.5;"><span class="badge bg-danger-subtle text-danger border border-danger mb-1">‡∏õ‡∏±‡∏ç‡∏´‡∏≤</span> <span class="text-dark fw-bold">${item.problems}</span><br><span class="badge bg-success-subtle text-success border border-success mt-1">‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</span> <span class="text-dark">${item.solutions || '-'}</span></div></div>`;
        });
        html += `</div></div>`;
     }
  }
  body.innerHTML = html;
}

// ==========================================
// 12. DASHBOARD & ACADEMIC LOGIC
// ==========================================
function loadStudentSummary() {
  google.script.run.withSuccessHandler(function(data) {
    if (data && data.length > 0) { renderStudentTable(data); renderStudentChart(data); }
  }).getStudentSummaryStats();
}

function renderStudentTable(data) {
  const tbody = document.getElementById('summaryTableBody');
  const tfooter = document.getElementById('tableFooter');
  if(!tbody) return;
  let html = ''; let sumM = 0, sumF = 0, sumT = 0;
  data.forEach(item => {
    sumM += item.male; sumF += item.female; sumT += item.total;
    html += `<tr><td><span class="badge bg-light text-dark border">${item.grade}</span></td><td class="text-center text-primary">${item.male}</td><td class="text-center text-danger">${item.female}</td><td class="text-center fw-bold">${item.total}</td></tr>`;
  });
  tbody.innerHTML = html;
  if(tfooter) tfooter.innerHTML = `<tr><td>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td><td class="text-center text-primary">${sumM}</td><td class="text-center text-danger">${sumF}</td><td class="text-center bg-primary text-white">${sumT}</td></tr>`;
}

function renderStudentChart(data) {
  const canvas = document.getElementById('studentChart');
  if(!canvas) return;
  if (window.myChart) window.myChart.destroy();
  window.myChart = new Chart(canvas.getContext('2d'), {
    type: 'bar',
    data: {
      labels: data.map(i => i.grade),
      datasets: [{ label: '‡∏ä‡∏≤‡∏¢', data: data.map(i => i.male), backgroundColor: '#3498db' }, { label: '‡∏´‡∏ç‡∏¥‡∏á', data: data.map(i => i.female), backgroundColor: '#e74c3c' }]
    },
    options: { indexAxis: 'y', responsive: true, plugins: { legend: { position: 'bottom' } }, scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } } }
  });
}
</script>