<script>
// ==========================================
// 1. Core System & UI
// ==========================================
window.onload = function() {
  applySavedTheme();
  checkAutoLogin();
};

function formatThaiDate(dateString) {
  if (!dateString || dateString === "undefined" || dateString === "") return "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î";
  const date = new Date(dateString);
  if (isNaN(date.getTime())) return dateString; 
  const days = ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå'];
  const months = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
  return `${days[date.getDay()]} ${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear() + 543}`;
}

const sidebar = document.getElementById('sidebar');
const collapseBtn = document.getElementById('sidebarCollapse');
if (collapseBtn) {
  collapseBtn.onclick = () => sidebar.classList.toggle('active');
}

function showLoader(status) {
  const loader = document.getElementById('loader');
  if (loader) status ? loader.classList.remove('d-none') : loader.classList.add('d-none');
}

// ==========================================
// 2. Authentication
// ==========================================
function checkAutoLogin() {
  const savedUser = localStorage.getItem('pssms_user');
  const sessionUser = sessionStorage.getItem('pssms_user');
  if (savedUser) { renderApp(JSON.parse(savedUser)); } 
  else if (sessionUser) { renderApp(JSON.parse(sessionUser)); } 
  else { showLoader(false); document.getElementById('login-section').classList.remove('d-none'); }
}

function processLogin() {
  const user = document.getElementById('username').value;
  const pass = document.getElementById('password').value;
  const rememberMe = document.getElementById('rememberMe').checked;
  if(!user || !pass) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
  showLoader(true);
  google.script.run.withSuccessHandler(function(res) {
    showLoader(false);
    if (res.status === "success") {
      const userData = JSON.stringify(res);
      if (rememberMe) localStorage.setItem('pssms_user', userData);
      else sessionStorage.setItem('pssms_user', userData);
      renderApp(res);
    } else { alert(res.message); }
  }).checkLogin(user, pass);
}

function logout() {
  if(confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
    localStorage.removeItem('pssms_user');
    localStorage.removeItem('pssms_last_page'); 
    sessionStorage.clear(); 
    document.getElementById('main-app').classList.add('d-none');
    document.getElementById('login-section').classList.remove('d-none');
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
  }
}

// ==========================================
// 3. Routing & Menu
// ==========================================
function renderApp(user) {
  window.currentUser = user;
  document.getElementById('login-section').classList.add('d-none');
  document.getElementById('main-app').classList.remove('d-none');
  
  let termText = "";
  if(user.currentTerm && user.currentYear) {
    termText = `<span class="badge bg-info text-dark shadow-sm" style="font-size: 0.7rem; border-radius: 6px;">‡πÄ‡∏ó‡∏≠‡∏° ${user.currentTerm}/${user.currentYear}</span>`;
  }

  const currentTheme = localStorage.getItem('pssms_theme') || 'light';
  const themeIcon = currentTheme === 'dark' ? 'fa-sun text-warning' : 'fa-moon text-secondary';

  document.getElementById('user-display').innerHTML = `
  <div class="d-flex align-items-center justify-content-end gap-3">
    <button class="btn btn-light rounded-circle shadow-sm border" style="width: 40px; height: 40px; transition: all 0.3s;" onclick="toggleDarkMode()">
      <i id="darkModeIcon" class="fas ${themeIcon} fa-lg"></i>
    </button>
    <div class="text-end">
      <div class="fw-bold text-dark theme-text" style="font-size: 0.95rem; line-height: 1;">${user.name}</div>
      <div class="d-flex align-items-center justify-content-end gap-2 mt-1" style="font-size: 0.8rem;">
        <span class="text-muted fw-bold">${user.role}</span>
        ${termText}
      </div>
    </div>
  </div>`;
  
  let menuHTML = '';
  let startPage = '';
  const role = user.role.toUpperCase();

  if (role === 'STUDENT') {
    startPage = 'Page_Dashboard_Student';
    menuHTML += `<li class="mb-3"><a href="javascript:void(0)" class="nav-link-custom active" onclick="loadPage('Page_Dashboard_Student')"><i class="fas fa-home me-2"></i>‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</a></li>`;
  } else {
    startPage = (role === 'ADMIN') ? 'Page_Dashboard_Admin' : 'Page_Dashboard_Teacher';
    const homeLabel = (role === 'ADMIN') ? '‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£' : '‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏Ñ‡∏£‡∏π';
    menuHTML += `<li class="mb-3"><a href="javascript:void(0)" class="nav-link-custom active" onclick="loadPage('${startPage}')"><i class="fas fa-chart-line me-2"></i>${homeLabel}</a></li>`;
  }

  if (role === 'ADMIN') {
    menuHTML += `
      <div class="menu-divider">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö</div>
      <li class="mb-1"><a href="javascript:void(0)" class="nav-link-sub text-warning" onclick="loadPage('Page_Admin_Users')"><i class="fas fa-users-cog me-2"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</a></li>
      <li class="mb-1"><a href="javascript:void(0)" class="nav-link-sub text-info" onclick="loadPage('Page_Admin_Timetable')"><i class="fas fa-calendar-alt me-2"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô</a></li>
      <li class="mb-3"><a href="javascript:void(0)" class="nav-link-sub text-light" onclick="loadPage('Page_Admin_Settings')"><i class="fas fa-cogs me-2"></i>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</a></li>
    `;
  }

  if (role !== 'STUDENT') {
    menuHTML += `
      <div class="menu-divider">‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ 4 ‡∏ù‡πà‡∏≤‡∏¢</div>
      <li class="mb-1"><a href="javascript:void(0)" class="dept-btn academic" onclick="loadPage('Page_Academic')"><i class="fas fa-graduation-cap"></i> <span>‡∏ù‡πà‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£</span></a></li>
      <li class="mb-1 ms-3"><a href="javascript:void(0)" class="nav-link-sub text-success py-1" style="font-size: 0.85rem;" onclick="loadPage('Page_Score_Entry')"><i class="fas fa-edit me-2" style="font-size: 0.7rem;"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡∏õ‡∏û.5)</a></li>
      <li class="mb-1 ms-3"><a href="javascript:void(0)" class="nav-link-sub text-info py-1" style="font-size: 0.85rem;" onclick="loadPage('Page_Academic_Report')"><i class="fas fa-chart-pie me-2" style="font-size: 0.7rem;"></i>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ (‡∏°‡∏™.)</a></li>
      <li class="mb-2 ms-3"><a href="javascript:void(0)" class="nav-link-sub text-success py-1" style="font-size: 0.85rem;" onclick="loadPage('Page_Lesson_History')"><i class="fas fa-book-reader me-2" style="font-size: 0.7rem;"></i>‡πÅ‡∏ü‡πâ‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏™‡∏≠‡∏ô</a></li>
      <li class="mb-2"><a href="javascript:void(0)" class="dept-btn budget" onclick="loadPage('Page_Budget')"><i class="fas fa-wallet"></i> <span>‡∏ù‡πà‡∏≤‡∏¢‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</span></a></li>
      <li class="mb-2"><a href="javascript:void(0)" class="dept-btn personnel" onclick="loadPage('Page_Personnel')"><i class="fas fa-users"></i> <span>‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</span></a></li>
      <li class="mb-2"><a href="javascript:void(0)" class="dept-btn general" onclick="loadPage('Page_General')"><i class="fas fa-building"></i> <span>‡∏ù‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</span></a></li>
    `;
  }

  document.getElementById('menu-list').innerHTML = menuHTML;
  const lastPage = localStorage.getItem('pssms_last_page');
  if (lastPage) loadPage(lastPage); else loadPage(startPage);
  setTimeout(preloadTeacherDataBackground, 2000);
}

const pageCache = {}; 

function loadPage(pageName) {
  // üåü 1. ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global (State Reset) ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≤‡∏°‡∏ß‡∏¥‡∏ä‡∏≤/‡∏Ç‡πâ‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤
  // -- ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ --
  currentStudents = [];
  tempHistoryData = [];
  currentMorningStudents = [];
  isDrawing = false; 
  
  // -- ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡∏õ‡∏û.5) --
  currentScoreConfig = null;
  currentScoreStudents = [];
  currentAttStats = {};
  isHeaderEditMode = false;
  isQualVisible = false;
  isSavingScores = false; 
  
  // -- ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÜ --
  currentTimetableData = [];
  allLessonHistories = [];

  // üåü 2. ‡πÄ‡∏Å‡πá‡∏ö‡∏Å‡∏ß‡∏≤‡∏î Modal (‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏î‡πâ‡∏á) ‡πÅ‡∏•‡∏∞‡∏à‡∏≠‡∏î‡∏≥‡πÜ ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤
  const openModals = document.querySelectorAll('.modal.show');
  openModals.forEach(m => {
      const modalInstance = bootstrap.Modal.getInstance(m);
      if (modalInstance) modalInstance.hide();
  });
  
  // ‡∏•‡∏ö‡∏â‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÜ (Backdrop) ‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
  document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());
  document.body.classList.remove('modal-open');
  document.body.style.overflow = '';
  document.body.style.paddingRight = '';

  // üåü 3. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
  localStorage.setItem('pssms_last_page', pageName);
  
  if (pageCache[pageName]) { 
      setupPageContent(pageName, pageCache[pageName]); 
      return; 
  }
  
  showLoader(true);
  google.script.run
    .withFailureHandler(err => { 
        showLoader(false); 
        alert("‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message); 
    })
    .withSuccessHandler(function(html) {
        pageCache[pageName] = html; 
        setupPageContent(pageName, html);
    })
    .getPage(pageName);
}

function setupPageContent(pageName, html) {
  document.getElementById('page-content').innerHTML = html;
  showLoader(false); 
  if (window.innerWidth <= 768) { const sidebar = document.getElementById('sidebar'); if(sidebar) sidebar.classList.remove('active'); }
  setTimeout(applyThaiDatePickers, 100);
  if(pageName === 'Page_Dashboard_Admin') loadStudentSummary();
  if(pageName === 'Page_Dashboard_Teacher') initTeacherDashboard();
  if(pageName === 'Page_Dashboard_Student') initStudentDashboard();
  if(pageName === 'Page_Admin_Users') loadUserData();
  if(pageName === 'Page_Admin_Settings') loadCurrentConfig();
  if(pageName === 'Page_Academic') initAcademicPage();
  if(pageName === 'Page_Admin_Timetable') initTimetablePage();
  if(pageName === 'Page_Academic_Report') initAcademicReportPage();
  if(pageName === 'Page_Lesson_History') initLessonHistoryPage();
  if(pageName === 'Page_Subject_Config') initSubjectConfigPage();
  if(pageName === 'Page_Score_Entry') initScoreEntryPage();
  if(pageName === 'Page_Grade_Summary') initGradeSummaryPage();
}

// ==========================================
// 4. SYSTEM THEME (DARK MODE)
// ==========================================

function toggleDarkMode() {
  const body = document.body;
  if (body.classList.contains('dark-mode')) {
    body.classList.remove('dark-mode');
    localStorage.setItem('pssms_theme', 'light');
    document.getElementById('darkModeIcon').className = 'fas fa-moon text-secondary fa-lg';
  } else {
    body.classList.add('dark-mode');
    localStorage.setItem('pssms_theme', 'dark');
    document.getElementById('darkModeIcon').className = 'fas fa-sun text-warning fa-lg';
  }
}

function applySavedTheme() {
  if (localStorage.getItem('pssms_theme') === 'dark') document.body.classList.add('dark-mode');
}

// ==========================================
// 5. THAI DATEPICKER SYSTEM
// ==========================================
function applyThaiDatePickers() {
  const dateInputs = document.querySelectorAll('input[type="date"]');
  dateInputs.forEach(input => {
    input.type = 'text'; input.classList.add('bg-white'); 
    flatpickr(input, {
      locale: "th", dateFormat: "Y-m-d", altInput: true, altFormat: "d M Y", 
      formatDate: (date, format, locale) => { if (format === "d M Y") { const d = date.getDate(); const m = flatpickr.l10ns.th.months.longhand[date.getMonth()]; const y = date.getFullYear() + 543; return `${d} ${m} ${y}`; } return flatpickr.formatDate(date, format, locale); },
      onReady: function(selectedDates, dateStr, instance) { if(instance.currentYearElement) instance.currentYearElement.value = instance.currentYear + 543; },
      onYearChange: function(selectedDates, dateStr, instance) { if(instance.currentYearElement) instance.currentYearElement.value = instance.currentYear + 543; },
      onMonthChange: function(selectedDates, dateStr, instance) { if(instance.currentYearElement) instance.currentYearElement.value = instance.currentYear + 543; },
      onChange: function(selectedDates, dateStr, instance) { input.value = dateStr; if (input.id === 'teachingDate') { if (typeof updateThaiDateDisplay === 'function') updateThaiDateDisplay(); if (typeof reloadTimetableByDate === 'function') reloadTimetableByDate(); } }
    });
  });
}

// ==========================================
// 6. Toast & Shortcut
// ==========================================

function showToast(msg, type="success") {
  let container = document.getElementById('toastContainer');
  if (!container) {
      container = document.createElement('div');
      container.id = 'toastContainer';
      container.style.cssText = 'position: fixed; bottom: 20px; right: 20px; z-index: 1050;';
      document.body.appendChild(container);
  }
  const bgClass = type === 'success' ? 'bg-success' : (type === 'info' ? 'bg-primary' : 'bg-warning text-dark');
  const icon = type === 'success' ? 'fa-check-circle' : (type === 'info' ? 'fa-cloud-upload-alt' : 'fa-exclamation-triangle');
  const toast = document.createElement('div');
  toast.className = `toast align-items-center text-white ${bgClass} border-0 mb-2 show animate__animated animate__fadeInUp shadow-lg`;
  toast.style.minWidth = "250px";
  toast.style.borderRadius = "8px";
  toast.innerHTML = `<div class="d-flex p-2"><div class="toast-body fw-bold" style="font-size: 0.9rem;"><i class="fas ${icon} me-2 fa-lg"></i>${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto shadow-none" onclick="this.parentElement.parentElement.remove()"></button></div>`;
  container.appendChild(toast);
  setTimeout(() => { toast.classList.replace('animate__fadeInUp', 'animate__fadeOutDown'); setTimeout(() => toast.remove(), 500); }, 2500);
}

document.addEventListener('keydown', function(e) {
  if ((e.ctrlKey || e.metaKey) && (e.key === 's' || e.key === 'S')) {
      const saveBtn = document.getElementById('btnSaveScores');
      const gridCard = document.getElementById('scoreGridCard');
      if (saveBtn && !saveBtn.disabled && gridCard && !gridCard.classList.contains('d-none')) {
          e.preventDefault(); 
          saveAllInOneScores(false); 
      }
  }
});

// ==========================================
// 7. BACKGROUND PRELOADER
// ==========================================
function preloadTeacherDataBackground() {
  const user = getSessionUser();
  if(!user || user.role.toUpperCase() === 'STUDENT') return; 
  const subjectCacheKey = `report_subjects_${user.id}_${user.currentTerm}_${user.currentYear}`;
  if (!sessionStorage.getItem(subjectCacheKey)) {
    google.script.run.withSuccessHandler(function(subjects) { sessionStorage.setItem(subjectCacheKey, JSON.stringify(subjects)); }).getTeacherSubjects(user.id, user.role, user.currentTerm, user.currentYear);
  }
}

// ==========================================
// 8. ‡∏£‡∏∞‡∏ö‡∏ö Auto-Retry ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏ô‡πá‡∏ï‡∏´‡∏•‡∏∏‡∏î/‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏Ñ‡πâ‡∏≤‡∏á
// ==========================================
window.safeRun = function(maxRetries = 3) {
  let _onSuccess = null;
  let _onFailure = null;

  // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á Success/Failure
  const chainObj = {
    withSuccessHandler: function(func) { _onSuccess = func; return this; },
    withFailureHandler: function(func) { _onFailure = func; return this; }
  };

  // 2. ‡πÉ‡∏ä‡πâ Proxy ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÑ‡∏õ Google Apps Script
  return new Proxy(chainObj, {
    get: function(target, propName) {
      if (propName in target) return target[propName];

      // 3. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏à‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ù‡∏±‡πà‡∏á Server (‡πÄ‡∏ä‡πà‡∏ô saveAttendanceBatch) ‡πÉ‡∏´‡πâ‡∏ó‡∏≥ Auto-Retry
      return function(...args) {
        const attemptCall = (retriesLeft) => {
          google.script.run
            .withSuccessHandler((res) => {
              if (_onSuccess) _onSuccess(res);
            })
            .withFailureHandler((err) => {
              if (retriesLeft > 0) {
                console.warn(`‚ö†Ô∏è [Auto-Retry] ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà... (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å ${retriesLeft} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)`);
                
                // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡πÄ‡∏ô‡∏µ‡∏¢‡∏ô‡πÜ ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏π‡∏ï‡∏Å‡πÉ‡∏à
                if (typeof showToast === "function") {
                   showToast(`‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà... (${retriesLeft})`, 'info');
                }
                
                // ‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡∏µ‡πÄ‡∏•‡∏¢‡πå 1.5 - 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà (‡∏Å‡∏±‡∏ô‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÇ‡∏î‡∏ô‡∏¢‡∏¥‡∏á‡∏ã‡πâ‡∏≥‡∏£‡∏±‡∏ß‡πÜ)
                setTimeout(() => attemptCall(retriesLeft - 1), 1500); 
              } else {
                // ‡∏ñ‡πâ‡∏≤‡∏•‡∏≠‡∏á‡∏à‡∏ô‡∏Ñ‡∏£‡∏ö‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏¢‡∏±‡∏á‡∏û‡∏±‡∏á ‡∏Ñ‡πà‡∏≠‡∏¢‡πÇ‡∏¢‡∏ô Error ‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏π‡πÄ‡∏´‡πá‡∏ô
                if (_onFailure) _onFailure(err);
                else alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
              }
            })
            [propName](...args); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°
        };
        
        attemptCall(maxRetries); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏¢‡∏¥‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
      };
    }
  });
};
</script>