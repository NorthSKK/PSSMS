<script>
// ==========================================
// 1. Core System & UI
// ==========================================
window.onload = function() {
  applySavedTheme();
  checkAutoLogin();
};

function formatThaiDate(dateString) {
  if (!dateString || dateString === "undefined" || dateString === "") return "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î";
  const date = new Date(dateString);
  if (isNaN(date.getTime())) return dateString; 
  const days = ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå'];
  const months = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
  return `${days[date.getDay()]} ${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear() + 543}`;
}

const sidebar = document.getElementById('sidebar');
const collapseBtn = document.getElementById('sidebarCollapse');
if (collapseBtn) {
  collapseBtn.onclick = () => sidebar.classList.toggle('active');
}

function showLoader(status) {
  const loader = document.getElementById('loader');
  if (loader) status ? loader.classList.remove('d-none') : loader.classList.add('d-none');
}

// ==========================================
// 2. Authentication
// ==========================================
function checkAutoLogin() {
  const savedUser = localStorage.getItem('pssms_user');
  const sessionUser = sessionStorage.getItem('pssms_user');
  if (savedUser) { renderApp(JSON.parse(savedUser)); } 
  else if (sessionUser) { renderApp(JSON.parse(sessionUser)); } 
  else { showLoader(false); document.getElementById('login-section').classList.remove('d-none'); }
}

function processLogin() {
  const user = document.getElementById('username').value;
  const pass = document.getElementById('password').value;
  const rememberMe = document.getElementById('rememberMe').checked;
  if(!user || !pass) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
  showLoader(true);
  google.script.run.withSuccessHandler(function(res) {
    showLoader(false);
    if (res.status === "success") {
      const userData = JSON.stringify(res);
      if (rememberMe) localStorage.setItem('pssms_user', userData);
      else sessionStorage.setItem('pssms_user', userData);
      renderApp(res);
    } else { alert(res.message); }
  }).checkLogin(user, pass);
}

function logout() {
  if(confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
    localStorage.removeItem('pssms_user');
    sessionStorage.removeItem('pssms_user');
    localStorage.removeItem('pssms_last_page'); 
    document.getElementById('main-app').classList.add('d-none');
    document.getElementById('login-section').classList.remove('d-none');
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
  }
}

// ==========================================
// 3. Routing & Menu
// ==========================================
function renderApp(user) {
  window.currentUser = user;
  document.getElementById('login-section').classList.add('d-none');
  document.getElementById('main-app').classList.remove('d-none');
  
  let termText = "";
  if(user.currentTerm && user.currentYear) {
    termText = `<span class="badge bg-info text-dark shadow-sm" style="font-size: 0.7rem; border-radius: 6px;">‡πÄ‡∏ó‡∏≠‡∏° ${user.currentTerm}/${user.currentYear}</span>`;
  }

  const currentTheme = localStorage.getItem('pssms_theme') || 'light';
  const themeIcon = currentTheme === 'dark' ? 'fa-sun text-warning' : 'fa-moon text-secondary';

  document.getElementById('user-display').innerHTML = `
  <div class="d-flex align-items-center justify-content-end gap-3">
    <button class="btn btn-light rounded-circle shadow-sm border" style="width: 40px; height: 40px; transition: all 0.3s;" onclick="toggleDarkMode()">
      <i id="darkModeIcon" class="fas ${themeIcon} fa-lg"></i>
    </button>
    <div class="text-end">
      <div class="fw-bold text-dark theme-text" style="font-size: 0.95rem; line-height: 1;">${user.name}</div>
      <div class="d-flex align-items-center justify-content-end gap-2 mt-1" style="font-size: 0.8rem;">
        <span class="text-muted fw-bold">${user.role}</span>
        ${termText}
      </div>
    </div>
  </div>`;
  
  let menuHTML = '';
  let startPage = '';
  const role = user.role.toUpperCase();

  if (role === 'STUDENT') {
    startPage = 'Page_Dashboard_Student';
    menuHTML += `<li class="mb-3"><a href="javascript:void(0)" class="nav-link-custom active" onclick="loadPage('Page_Dashboard_Student')"><i class="fas fa-home me-2"></i>‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</a></li>`;
  } else {
    startPage = (role === 'ADMIN') ? 'Page_Dashboard_Admin' : 'Page_Dashboard_Teacher';
    const homeLabel = (role === 'ADMIN') ? '‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£' : '‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏Ñ‡∏£‡∏π';
    menuHTML += `<li class="mb-3"><a href="javascript:void(0)" class="nav-link-custom active" onclick="loadPage('${startPage}')"><i class="fas fa-chart-line me-2"></i>${homeLabel}</a></li>`;
  }

  if (role === 'ADMIN') {
    menuHTML += `
      <div class="menu-divider">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö</div>
      <li class="mb-1"><a href="javascript:void(0)" class="nav-link-sub text-warning" onclick="loadPage('Page_Admin_Users')"><i class="fas fa-users-cog me-2"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</a></li>
      <li class="mb-1"><a href="javascript:void(0)" class="nav-link-sub text-info" onclick="loadPage('Page_Admin_Timetable')"><i class="fas fa-calendar-alt me-2"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô</a></li>
      <li class="mb-3"><a href="javascript:void(0)" class="nav-link-sub text-light" onclick="loadPage('Page_Admin_Settings')"><i class="fas fa-cogs me-2"></i>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</a></li>
    `;
  }

  if (role !== 'STUDENT') {
    menuHTML += `
      <div class="menu-divider">‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ 4 ‡∏ù‡πà‡∏≤‡∏¢</div>
      <li class="mb-1"><a href="javascript:void(0)" class="dept-btn academic" onclick="loadPage('Page_Academic')"><i class="fas fa-graduation-cap"></i> <span>‡∏ù‡πà‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£</span></a></li>
      <li class="mb-1 ms-3"><a href="javascript:void(0)" class="nav-link-sub text-success py-1" style="font-size: 0.85rem;" onclick="loadPage('Page_Score_Entry')"><i class="fas fa-edit me-2" style="font-size: 0.7rem;"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡∏õ‡∏û.5)</a></li>
      <li class="mb-1 ms-3"><a href="javascript:void(0)" class="nav-link-sub text-info py-1" style="font-size: 0.85rem;" onclick="loadPage('Page_Academic_Report')"><i class="fas fa-chart-pie me-2" style="font-size: 0.7rem;"></i>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ (‡∏°‡∏™.)</a></li>
      <li class="mb-2 ms-3"><a href="javascript:void(0)" class="nav-link-sub text-success py-1" style="font-size: 0.85rem;" onclick="loadPage('Page_Lesson_History')"><i class="fas fa-book-reader me-2" style="font-size: 0.7rem;"></i>‡πÅ‡∏ü‡πâ‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏™‡∏≠‡∏ô</a></li>
      <li class="mb-2"><a href="javascript:void(0)" class="dept-btn budget" onclick="loadPage('Page_Budget')"><i class="fas fa-wallet"></i> <span>‡∏ù‡πà‡∏≤‡∏¢‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</span></a></li>
      <li class="mb-2"><a href="javascript:void(0)" class="dept-btn personnel" onclick="loadPage('Page_Personnel')"><i class="fas fa-users"></i> <span>‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</span></a></li>
      <li class="mb-2"><a href="javascript:void(0)" class="dept-btn general" onclick="loadPage('Page_General')"><i class="fas fa-building"></i> <span>‡∏ù‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</span></a></li>
    `;
  }

  document.getElementById('menu-list').innerHTML = menuHTML;
  const lastPage = localStorage.getItem('pssms_last_page');
  if (lastPage) loadPage(lastPage); else loadPage(startPage);
  setTimeout(preloadTeacherDataBackground, 2000);
}

const pageCache = {}; 
function loadPage(pageName) {
  localStorage.setItem('pssms_last_page', pageName);
  if (pageCache[pageName]) { setupPageContent(pageName, pageCache[pageName]); return; }
  showLoader(true);
  google.script.run.withFailureHandler(err => { showLoader(false); alert("‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message); }).withSuccessHandler(function(html) {
    pageCache[pageName] = html; setupPageContent(pageName, html);
  }).getPage(pageName);
}

function setupPageContent(pageName, html) {
  document.getElementById('page-content').innerHTML = html;
  showLoader(false); 
  if (window.innerWidth <= 768) { const sidebar = document.getElementById('sidebar'); if(sidebar) sidebar.classList.remove('active'); }
  setTimeout(applyThaiDatePickers, 100);
  if(pageName === 'Page_Dashboard_Admin') loadStudentSummary();
  if(pageName === 'Page_Dashboard_Teacher') initTeacherDashboard();
  if(pageName === 'Page_Dashboard_Student') initStudentDashboard();
  if(pageName === 'Page_Admin_Users') loadUserData();
  if(pageName === 'Page_Admin_Settings') loadCurrentConfig();
  if(pageName === 'Page_Academic') initAcademicPage();
  if(pageName === 'Page_Admin_Timetable') initTimetablePage();
  if(pageName === 'Page_Academic_Report') initAcademicReportPage();
  if(pageName === 'Page_Lesson_History') initLessonHistoryPage();
  if(pageName === 'Page_Subject_Config') initSubjectConfigPage();
  if(pageName === 'Page_Score_Entry') initScoreEntryPage();
  if(pageName === 'Page_Grade_Summary') initGradeSummaryPage();
}

// ==========================================
// 4. System Settings Logic
// ==========================================
function loadCurrentConfig() {
  google.script.run.withSuccessHandler(function(config) {
    document.getElementById('inputTerm').value = config.term || "1";
    document.getElementById('inputYear').value = config.year || "2568";
    if (config.termStart) document.getElementById('inputStartDate').value = new Date(config.termStart).toISOString().split('T')[0];
    if (config.termEnd) document.getElementById('inputEndDate').value = new Date(config.termEnd).toISOString().split('T')[0];
    if(document.getElementById('currentTermDisplay')) document.getElementById('currentTermDisplay').innerText = `${config.term}/${config.year}`;
    if(document.getElementById('currentRangeDisplay')) document.getElementById('currentRangeDisplay').innerText = `${formatThaiDate(config.termStart)} ‡∏ñ‡∏∂‡∏á ${formatThaiDate(config.termEnd)}`;
  }).getSystemConfig();
}

function saveConfig() {
  const term = document.getElementById('inputTerm').value;
  const year = document.getElementById('inputYear').value;
  const startDate = document.getElementById('inputStartDate').value;
  const endDate = document.getElementById('inputEndDate').value;
  if(!term || !year || !startDate || !endDate) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á');
  showLoader(true);
  google.script.run.withSuccessHandler(function(res) { showLoader(false); alert(res.message); loadCurrentConfig(); }).saveSystemConfig(term, year, startDate, endDate);
}

// ==========================================
// 5. User Management 
// ==========================================
var allUsers = [];
function loadUserData() { google.script.run.withSuccessHandler(d => { allUsers = d; renderTable(d); }).getAllUsers(); }

function renderTable(data) {
  const tbodyStudent = document.getElementById('tableBodyStudent');
  const tbodyStaff = document.getElementById('tableBodyStaff');
  if(!tbodyStudent || !tbodyStaff) return;
  let htmlStudent = ''; let htmlStaff = '';
  data.forEach(row => {
    const rawStatus = row[7] ? String(row[7]).trim() : "‡∏õ‡∏Å‡∏ï‡∏¥";
    if (row[3] === 'Student') {
      let statusBadge = rawStatus === '‡∏õ‡∏Å‡∏ï‡∏¥' ? '<span class="badge bg-success-subtle text-success border border-success rounded-pill px-3">‡∏õ‡∏Å‡∏ï‡∏¥</span>' : '<span class="badge bg-danger-subtle text-danger border border-danger rounded-pill px-3">‡πÅ‡∏Ç‡∏ß‡∏ô‡∏•‡∏≠‡∏¢</span>';
      let trClass = rawStatus === '‡πÅ‡∏Ç‡∏ß‡∏ô‡∏•‡∏≠‡∏¢' ? 'table-danger' : '';
      htmlStudent += `<tr class="${trClass}"><td class="ps-4 fw-bold text-primary">${row[0]}</td><td>${row[2]}</td><td><span class="badge bg-light text-dark border">${row[4]}</span></td><td class="text-center">${statusBadge}</td><td class="text-end pe-4"><button class="btn btn-sm btn-outline-primary me-1 shadow-none" onclick="openModal('edit', '${row[0]}')"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-outline-danger shadow-none" onclick="confirmDelete('${row[0]}')"><i class="fas fa-trash"></i></button></td></tr>`;
    } else {
      let roleBadge = row[3] === 'Admin' ? '<span class="badge bg-danger">Admin</span>' : '<span class="badge bg-success">Teacher</span>';
      htmlStaff += `<tr><td class="ps-4 text-muted">${row[0]}</td><td class="fw-bold">${row[2]}</td><td>${row[4]}</td><td class="text-center">${roleBadge}</td><td class="text-end pe-4"><button class="btn btn-sm btn-outline-primary me-1 shadow-none" onclick="openModal('edit', '${row[0]}')"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-outline-danger shadow-none" onclick="confirmDelete('${row[0]}')"><i class="fas fa-trash"></i></button></td></tr>`;
    }
  });
  tbodyStudent.innerHTML = htmlStudent || '<tr><td colspan="5" class="text-center p-5 text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</td></tr>';
  tbodyStaff.innerHTML = htmlStaff || '<tr><td colspan="5" class="text-center p-5 text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</td></tr>';
  renderStudentSummary(data);
}

function renderStudentSummary(data) {
  const summaryContainer = document.getElementById('studentSummaryContainer');
  const tbody = document.getElementById('summaryTableBody');
  if (!summaryContainer || !tbody) return;
  const students = data.filter(row => row[3] === 'Student');
  if (students.length === 0) { summaryContainer.style.display = 'none'; return; }
  summaryContainer.style.display = 'block';
  let totalActive = 0, totalSuspended = 0, totalMale = 0, totalFemale = 0;
  const roomStats = {};
  students.forEach(s => {
    const room = String(s[4]).trim() || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
    const name = String(s[2]).trim();
    const status = String(s[7]).trim() || "‡∏õ‡∏Å‡∏ï‡∏¥";
    const isMale = /^(‡∏ô‡∏≤‡∏¢|‡∏î\.‡∏ä\.|‡∏î‡∏ä\.|‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢)/.test(name);
    if (status === '‡∏õ‡∏Å‡∏ï‡∏¥') totalActive++; else totalSuspended++;
    if (isMale) totalMale++; else totalFemale++;
    if (!roomStats[room]) roomStats[room] = { male: 0, female: 0, active: 0, suspended: 0, total: 0 };
    if (isMale) roomStats[room].male++; else roomStats[room].female++;
    if (status === '‡∏õ‡∏Å‡∏ï‡∏¥') roomStats[room].active++; else roomStats[room].suspended++;
    roomStats[room].total++;
  });
  document.getElementById('sumTotal').innerText = students.length;
  document.getElementById('sumActive').innerText = totalActive;
  document.getElementById('sumSuspended').innerText = totalSuspended;
  document.getElementById('sumMale').innerText = totalMale;
  document.getElementById('sumFemale').innerText = totalFemale;
  let html = '';
  const sortedRooms = Object.keys(roomStats).sort((a, b) => a.localeCompare(b, 'th', { numeric: true }));
  sortedRooms.forEach(room => {
    const stat = roomStats[room];
    html += `<tr><td class="fw-bold text-start ps-3"><span class="badge bg-light text-dark border border-secondary-subtle shadow-sm">${room}</span></td><td>${stat.male > 0 ? stat.male : '-'}</td><td>${stat.female > 0 ? stat.female : '-'}</td><td class="text-success fw-bold">${stat.active > 0 ? stat.active : '-'}</td><td class="text-danger">${stat.suspended > 0 ? stat.suspended : '-'}</td><td class="fw-bold text-primary bg-light">${stat.total}</td></tr>`;
  });
  html += `<tr class="table-light fw-bold text-dark"><td class="text-end pe-3">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td><td>${totalMale}</td><td>${totalFemale}</td><td class="text-success">${totalActive}</td><td class="text-danger">${totalSuspended}</td><td class="text-primary fs-6">${students.length}</td></tr>`;
  tbody.innerHTML = html;
}

function toggleStatusField() {
  const role = document.getElementById('inputRole').value;
  const statusContainer = document.getElementById('statusFieldContainer');
  if(statusContainer) {
    if(role === 'Student') statusContainer.classList.remove('d-none');
    else statusContainer.classList.add('d-none');
  }
}

function openModal(mode, id=null) {
  const modal = new bootstrap.Modal(document.getElementById('userModal'));
  document.getElementById('mode').value = mode;
  if(mode === 'add') {
    document.getElementById('modalTitle').innerHTML = '<i class="fas fa-user-plus me-2"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà';
    document.getElementById('userForm').reset();
    document.getElementById('inputUser').disabled = false;
    document.getElementById('inputRole').value = 'Student'; 
  } else {
    document.getElementById('modalTitle').innerHTML = '<i class="fas fa-user-edit me-2"></i>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
    const user = allUsers.find(r => String(r[0]) === String(id));
    if(user) {
      document.getElementById('inputUser').value = user[0];
      document.getElementById('inputUser').disabled = true;
      document.getElementById('inputPass').value = user[1];
      document.getElementById('inputName').value = user[2];
      document.getElementById('inputRole').value = user[3];
      document.getElementById('inputDept').value = user[4];
      document.getElementById('inputEmail').value = user[5];
      if(document.getElementById('inputStatus')) document.getElementById('inputStatus').value = user[7] || "‡∏õ‡∏Å‡∏ï‡∏¥";
    }
  }
  toggleStatusField(); modal.show();
}

function saveUser() {
  const mode = document.getElementById('mode').value;
  const form = { 
    username: document.getElementById('inputUser').value, password: document.getElementById('inputPass').value, 
    fullname: document.getElementById('inputName').value, role: document.getElementById('inputRole').value, 
    dept: document.getElementById('inputDept').value, email: document.getElementById('inputEmail').value,
    status: document.getElementById('inputStatus') ? document.getElementById('inputStatus').value : '‡∏õ‡∏Å‡∏ï‡∏¥'
  };
  if(!form.username || !form.password || !form.fullname) return alert("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö");
  showLoader(true);
  const action = mode === 'add' ? 'addUser' : 'editUser';
  google.script.run.withSuccessHandler(res => { 
    showLoader(false); alert(res.message); 
    if(res.status === 'success') { bootstrap.Modal.getInstance(document.getElementById('userModal')).hide(); loadUserData(); } 
  })[action](form);
}

function confirmDelete(id) {
  if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö ' + id + '?')) { showLoader(true); google.script.run.withSuccessHandler(res => { showLoader(false); alert(res.message); loadUserData(); }).deleteUser(id); }
}

function filterTable() {
  const input = document.getElementById('searchInput').value.toLowerCase();
  const filtered = allUsers.filter(r => String(r[0]).toLowerCase().includes(input) || String(r[2]).toLowerCase().includes(input) || String(r[4]).toLowerCase().includes(input));
  renderTable(filtered);
}

function handleFileUpload(input, type) {
  const file = input.files[0];
  if (!file) return;
  if (!confirm(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${type === 'student' ? '‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' : '‡∏Ñ‡∏£‡∏π'}?`)) { input.value = ''; return; }
  document.getElementById('uploadStatus').classList.remove('d-none');
  const reader = new FileReader();
  reader.onload = e => {
    const content = e.target.result.split(',')[1];
    const func = type === 'student' ? 'importStudentCSV' : 'importTeacherCSV';
    google.script.run.withSuccessHandler(res => { document.getElementById('uploadStatus').classList.add('d-none'); alert(res.message); input.value = ''; loadUserData(); })[func](content);
  };
  reader.readAsDataURL(file);
}

// ==========================================
// 6. DASHBOARD & ACADEMIC LOGIC
// ==========================================
function loadStudentSummary() {
  google.script.run.withSuccessHandler(function(data) {
    if (data && data.length > 0) { renderStudentTable(data); renderStudentChart(data); }
  }).getStudentSummaryStats();
}

function renderStudentTable(data) {
  const tbody = document.getElementById('summaryTableBody');
  const tfooter = document.getElementById('tableFooter');
  if(!tbody) return;
  let html = ''; let sumM = 0, sumF = 0, sumT = 0;
  data.forEach(item => {
    sumM += item.male; sumF += item.female; sumT += item.total;
    html += `<tr><td><span class="badge bg-light text-dark border">${item.grade}</span></td><td class="text-center text-primary">${item.male}</td><td class="text-center text-danger">${item.female}</td><td class="text-center fw-bold">${item.total}</td></tr>`;
  });
  tbody.innerHTML = html;
  if(tfooter) tfooter.innerHTML = `<tr><td>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td><td class="text-center text-primary">${sumM}</td><td class="text-center text-danger">${sumF}</td><td class="text-center bg-primary text-white">${sumT}</td></tr>`;
}

function renderStudentChart(data) {
  const canvas = document.getElementById('studentChart');
  if(!canvas) return;
  if (window.myChart) window.myChart.destroy();
  window.myChart = new Chart(canvas.getContext('2d'), {
    type: 'bar',
    data: {
      labels: data.map(i => i.grade),
      datasets: [{ label: '‡∏ä‡∏≤‡∏¢', data: data.map(i => i.male), backgroundColor: '#3498db' }, { label: '‡∏´‡∏ç‡∏¥‡∏á', data: data.map(i => i.female), backgroundColor: '#e74c3c' }]
    },
    options: { indexAxis: 'y', responsive: true, plugins: { legend: { position: 'bottom' } }, scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } } }
  });
}

// ==========================================
// 7. TIMETABLE LOGIC
// ==========================================
var currentTimetableData = []; 
var editModalInstance = null;

function handleTimetableUpload(input) {
  const file = input.files[0];
  if (!file) return;
  alert("‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Import CSV ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà (‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö)");
  input.value = '';
}

function initTimetablePage() {
  google.script.run.withSuccessHandler(function(users) {
    const selectView = document.getElementById('viewTeacherID');
    if(!selectView) return;
    let html = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π --</option>';
    users.filter(u => u[3] === 'Teacher' || u[3] === 'Admin').forEach(u => { html += `<option value="${u[0]}">${u[0]} - ${u[2]}</option>`; });
    selectView.innerHTML = html;
  }).getAllUsers();
}

function viewTimetable() {
  const tid = document.getElementById('viewTeacherID').value;
  const term = document.getElementById('viewTerm').value;
  const year = document.getElementById('viewYear').value;
  if(!tid) return;
  const tbody = document.getElementById('timetableDisplayBody');
  tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>';
  google.script.run.withSuccessHandler(function(data) {
    currentTimetableData = data; 
    document.getElementById('totalPeriodsBadge').innerText = data.length;
    renderTimetableList();
    renderTimetableGrid();
  }).getFilteredTimetables(tid, term, year);
}

function renderTimetableGrid() {
  const days = ['‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏®‡∏∏‡∏Å‡∏£‡πå'];
  const tbody = document.getElementById('timetableGridBody');
  let html = '';
  days.forEach(day => {
    html += `<tr><td class="bg-light fw-bold" style="vertical-align: middle;">${day}</td>`;
    for(let p = 1; p <= 8; p++) {
      if (p === 5) html += `<td class="bg-warning-subtle align-middle fw-bold text-muted" style="width: 60px; font-size: 12px;">‡∏û‡∏±‡∏Å</td>`;
      const match = currentTimetableData.find(item => item.data[6] === day && parseInt(item.data[7]) === p);
      if(match) {
        const r = match.data;
        html += `<td class="p-1" onclick="openEditTimetable(${match.rowIndex})" style="cursor:pointer; background-color: #e7f1ff; min-width: 110px; border: 1px solid #dee2e6;"><div class="text-primary fw-bold small">${r[0]}</div><div class="text-dark truncate-text" style="font-size: 11px; line-height: 1.2;">${r[1]}</div><div class="badge bg-secondary mt-1" style="font-size: 10px;">${r[2]}/${r[3]} (${r[4]})</div></td>`;
      } else { html += `<td class="text-muted align-middle" style="background-color: #fafafa; border: 1px solid #dee2e6;">-</td>`; }
    }
    html += `</tr>`;
  });
  tbody.innerHTML = html;
}

function renderTimetableList() {
  const tbody = document.getElementById('timetableDisplayBody');
  let html = '';
  if(currentTimetableData.length === 0) html = '<tr><td colspan="5" class="text-center p-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô</td></tr>';
  else {
    const dayOrder = {'‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå':1, '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£':2, '‡∏û‡∏∏‡∏ò':3, '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ':4, '‡∏®‡∏∏‡∏Å‡∏£‡πå':5};
    currentTimetableData.sort((a,b) => {
      if(dayOrder[a.data[6]] !== dayOrder[b.data[6]]) return dayOrder[a.data[6]] - dayOrder[b.data[6]];
      return a.data[7] - b.data[7];
    });
    currentTimetableData.forEach(item => {
      const r = item.data;
      html += `<tr><td><span class="badge bg-light text-dark border">${r[6]}</span></td><td>‡∏Ñ‡∏≤‡∏ö ${r[7]}</td><td><div class="fw-bold text-primary">${r[0]}</div><div class="small text-muted">${r[1]}</div></td><td>${r[2]}/${r[3]} (${r[4]})</td><td class="text-end"><button class="btn btn-sm btn-outline-primary" onclick="openEditTimetable(${item.rowIndex})"><i class="fas fa-edit"></i></button></td></tr>`;
    });
  }
  tbody.innerHTML = html;
}

function openEditTimetable(rowIndex) {
  const item = currentTimetableData.find(i => i.rowIndex === rowIndex);
  if(!item) return;
  document.getElementById('editRowIndex').value = rowIndex;
  document.getElementById('editSubjectCode').value = item.data[0];
  document.getElementById('editSubjectName').value = item.data[1];
  if(document.getElementById('editLevel')) document.getElementById('editLevel').value = item.data[2];
  if(document.getElementById('editRoom')) document.getElementById('editRoom').value = item.data[3];
  if(document.getElementById('editLocation')) document.getElementById('editLocation').value = item.data[4];
  document.getElementById('editDay').value = item.data[6];
  document.getElementById('editPeriod').value = item.data[7];
  const modalEl = document.getElementById('editTimetableModal');
  if(modalEl) {
    if (!editModalInstance) editModalInstance = new bootstrap.Modal(modalEl);
    editModalInstance.show();
  } else { alert("‡πÑ‡∏°‡πà‡∏û‡∏ö HTML ‡∏Ç‡∏≠‡∏á Modal"); }
}

function saveTimetableEdit() {
  const rowIndex = document.getElementById('editRowIndex').value;
  const tid = document.getElementById('viewTeacherID').value;
  const term = document.getElementById('viewTerm').value;
  const year = document.getElementById('viewYear').value;
  const rowData = [
    document.getElementById('editSubjectCode').value, document.getElementById('editSubjectName').value, 
    document.getElementById('editLevel').value, document.getElementById('editRoom').value, 
    document.getElementById('editLocation').value, tid, document.getElementById('editDay').value, 
    document.getElementById('editPeriod').value, term, year
  ];
  const btn = document.getElementById('btnSaveTimetable');
  btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
  google.script.run.withSuccessHandler(res => { 
    btn.disabled = false; btn.innerHTML = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'; alert(res.message); 
    if(editModalInstance) editModalInstance.hide(); viewTimetable(); 
  }).updateTimetableRow(rowIndex, rowData);
}

function confirmDeleteTimetable() {
  if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ?')) {
    const rowIndex = document.getElementById('editRowIndex').value;
    google.script.run.withSuccessHandler(res => { alert(res.message); if(editModalInstance) editModalInstance.hide(); viewTimetable(); }).deleteTimetableRow(rowIndex);
  }
}

function switchTimetableView(mode) {
  if(mode === 'list') { 
    document.getElementById('sectionListView').classList.remove('d-none'); document.getElementById('sectionGridView').classList.add('d-none'); 
    document.getElementById('btnListView').classList.add('active'); document.getElementById('btnGridView').classList.remove('active'); 
  } else { 
    document.getElementById('sectionListView').classList.add('d-none'); document.getElementById('sectionGridView').classList.remove('d-none'); 
    document.getElementById('btnListView').classList.remove('active'); document.getElementById('btnGridView').classList.add('active'); 
  }
}

// ==========================================
// 8. TEACHER DASHBOARD LOGIC
// ==========================================
function loadTodoList() {
  const user = getSessionUser();
  if (!user) return;
  const storageKey = `todo_list_${user.id}`;
  let localTodos = JSON.parse(localStorage.getItem(storageKey)) || [];
  renderTodoList(localTodos);
  google.script.run.withSuccessHandler(function(serverData) {
    if (serverData) { localStorage.setItem(storageKey, serverData); renderTodoList(JSON.parse(serverData)); }
  }).getTodoList(user.id);
}

function syncTodoToServer(todos) {
  const user = getSessionUser();
  if (!user) return;
  const storageKey = `todo_list_${user.id}`;
  localStorage.setItem(storageKey, JSON.stringify(todos));
  renderTodoList(todos);
  google.script.run.saveTodoList(user.id, JSON.stringify(todos));
}

function renderTodoList(todos) {
  const container = document.getElementById('todoListContainer');
  const countEl = document.getElementById('todoCount');
  if (!container) return;

  if (!todos || todos.length === 0) {
    container.innerHTML = `<div class="d-flex align-items-center justify-content-center w-100 animate__animated animate__fadeIn" style="min-height: 100px; background-color: #ffffff; border: none;"><div class="text-center"><i class="fas fa-check-double fa-lg mb-2 text-success" style="opacity: 0.12;"></i><br><span class="text-muted" style="font-size: 0.82rem; opacity: 0.4; letter-spacing: 0.5px;">‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏á‡∏≤‡∏ô‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö üéâ</span></div></div>`; 
    if (countEl) countEl.innerText = `0 ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á`;
    return;
  }

  const pending = todos.filter(t => !t.done);
  const completed = todos.filter(t => t.done);
  const sortedTodos = [...pending, ...completed];
  let html = '';
  sortedTodos.forEach((todo, index) => {
    const isDone = todo.done;
    const textStyle = isDone ? 'text-muted text-decoration-line-through opacity-30' : 'text-dark';
    const bgStyle = isDone ? 'bg-light' : 'bg-white';
    const animationClass = "animate__animated animate__fadeIn animate__faster";
    html += `<li class="list-group-item d-flex justify-content-between align-items-center ${bgStyle} border-0 px-2 py-1 mb-0 rounded-0 w-100 ${animationClass}"><div class="form-check text-truncate d-flex align-items-center mb-0" style="flex-grow: 1; min-height: auto;"><input class="form-check-input me-2 rounded-circle" type="checkbox" id="todo_${index}" ${isDone ? 'checked' : ''} onchange="toggleTodoByObject('${encodeURIComponent(JSON.stringify(todo))}')" style="cursor:pointer; width:0.95rem; height:0.95rem; margin-top: 0; flex-shrink: 0; transition: all 0.3s;"><label class="form-check-label text-truncate ${textStyle}" for="todo_${index}" style="font-size: 0.82rem; cursor:pointer; line-height: 1.4; transition: all 0.3s; width: 100%;">${todo.text}</label></div><button class="btn btn-link btn-sm text-danger p-0 opacity-10" onclick="deleteTodoByText('${encodeURIComponent(todo.text)}')" style="border: none; text-decoration: none; margin-right: 12px; transition: opacity 0.2s;" title="‡∏•‡∏ö"><i class="fas fa-times" style="font-size: 0.9rem;"></i></button></li>`;
  });
  container.innerHTML = html;
  if (countEl) countEl.innerText = `${pending.length} ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á`;
}

function addTodoItem() {
  const user = getSessionUser();
  if (!user) return;
  const input = document.getElementById('newTodoInput');
  const text = input.value.trim();
  if (!text) return; 
  const storageKey = `todo_list_${user.id}`;
  let todos = JSON.parse(localStorage.getItem(storageKey)) || [];
  const newTodo = { text: text, done: false, notionId: null };
  todos.unshift(newTodo);
  input.value = ''; 
  syncTodoToServer(todos);

  if (user.id === 'teacher12') {
    google.script.run.withSuccessHandler(function(response) {
      const result = JSON.parse(response);
      if (result.id) {
        let currentTodos = JSON.parse(localStorage.getItem(storageKey)) || [];
        const idx = currentTodos.findIndex(t => t.text === text && !t.notionId);
        if (idx !== -1) { currentTodos[idx].notionId = result.id; syncTodoToServer(currentTodos); }
      }
    }).sendTaskToNotion(text);
  }
}

function toggleTodoByObject(encodedObj) {
  const todoObj = JSON.parse(decodeURIComponent(encodedObj));
  const user = getSessionUser();
  const storageKey = `todo_list_${user.id}`;
  let todos = JSON.parse(localStorage.getItem(storageKey)) || [];
  const target = todos.find(t => t.text === todoObj.text);
  if (target) {
    target.done = !target.done;
    syncTodoToServer(todos);
    if (user.id === 'teacher12' && target.notionId) google.script.run.updateTaskStatus(target.notionId, target.done);
  }
}

function deleteTodoByText(encodedText) {
  const text = decodeURIComponent(encodedText);
  const user = getSessionUser();
  const storageKey = `todo_list_${user.id}`;
  let todos = JSON.parse(localStorage.getItem(storageKey)) || [];
  const newTodos = todos.filter(t => t.text !== text);
  syncTodoToServer(newTodos);
}

function initTeacherDashboard() {
  const user = JSON.parse(localStorage.getItem('pssms_user') || sessionStorage.getItem('pssms_user'));
  if(!user) return;
  if(document.getElementById('dashTeacherName')) document.getElementById('dashTeacherName').innerText = user.name;
  if(document.getElementById('dashTodayDate')) document.getElementById('dashTodayDate').innerText = new Date().toLocaleDateString('th-TH', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
  const now = new Date();
  const localDate = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
  const scheduleCacheKey = `today_schedule_${user.id}_${localDate}`;

  if (sessionStorage.getItem(scheduleCacheKey)) {
     renderTeacherTodaySchedule(JSON.parse(sessionStorage.getItem(scheduleCacheKey)));
  } else {
     google.script.run.withSuccessHandler(data => {
       sessionStorage.setItem(scheduleCacheKey, JSON.stringify(data));
       renderTeacherTodaySchedule(data);
     }).getTeacherTimetable(user.id);
  }
  
  loadTeacherAtRiskDashboard(user.id, user.currentTerm, user.currentYear);
  setTimeout(loadTodoList, 300);
}

function renderTeacherTodaySchedule(timetable) {
  const tbody = document.getElementById('todayScheduleBody');
  const nextTitle = document.getElementById('nextClassTitle');
  const nextDetail = document.getElementById('nextClassDetail');
  if(!tbody) return;
  if(!timetable || timetable.length === 0) {
    tbody.innerHTML = '<tr><td colspan="3" class="text-center p-5 text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</td></tr>';
    if(nextTitle) nextTitle.innerText = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏£‡∏∞‡∏á‡∏≤‡∏ô‡∏™‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ";
    return;
  }
  timetable.sort((a,b) => a[5] - b[5]);
  const timeMap = { 1: "08:30-09:20", 2: "09:20-10:10", 3: "10:20-11:10", 4: "11:10-12:00", 5: "13:00-13:50", 6: "13:50-14:40", 7: "14:40-15:30", 8: "15:30-16:00" };
  const now = new Date(); 
  const currentMinutes = now.getHours() * 60 + now.getMinutes();
  let nextClass = null; let html = '';

  timetable.forEach(r => {
    const p = r[5]; const timeRange = timeMap[p] || "--:--"; const times = timeRange.split('-');
    const [startH, startM] = times[0].split(':').map(Number); const startTotalMinutes = (startH * 60) + startM;
    const [endH, endM] = times[1].split(':').map(Number); const endTotalMinutes = (endH * 60) + endM;
    if (!nextClass && startTotalMinutes > currentMinutes) nextClass = r;
    const isTeaching = (currentMinutes >= startTotalMinutes && currentMinutes < endTotalMinutes);
    const encodedItem = encodeURIComponent(JSON.stringify(r));
    html += `<tr class="${isTeaching ? 'table-primary' : ''}" style="cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f1f3f5'" onmouseout="this.style.backgroundColor=''" onclick="jumpToAttendance('${encodedItem}')" title="üëÜ ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ"><td class="ps-3 fw-bold align-middle">‡∏Ñ‡∏≤‡∏ö ${p}</td><td class="align-middle"><div class="fw-bold text-primary">${r[0]} - ${r[1]}</div><div class="small text-muted"><i class="fas fa-door-open me-1"></i>‡∏´‡πâ‡∏≠‡∏á ${r[2]} (${r[4]}) | <i class="fas fa-clock me-1"></i>${timeRange} ‡∏ô.</div></td><td class="text-center align-middle">${isTeaching ? '<span class="badge bg-danger pulse mb-1">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏≠‡∏ô</span>' : (startTotalMinutes > currentMinutes ? '<span class="badge bg-light text-dark border mb-1">‡∏£‡∏≠‡∏™‡∏≠‡∏ô</span>' : '<span class="badge bg-success mb-1">‡∏™‡∏≠‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</span>')}<br><span class="badge bg-primary rounded-pill" style="font-size: 0.65rem;"><i class="fas fa-hand-pointer me-1"></i>‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</span></td></tr>`;
  });
  tbody.innerHTML = html;
  if(nextTitle && nextClass) {
    nextTitle.innerHTML = `‡∏Ñ‡∏≤‡∏ö ${nextClass[5]}: <span class="text-warning">${nextClass[0]}</span> ${nextClass[1]}`;
    nextDetail.innerHTML = `<i class="fas fa-door-open me-1"></i>‡∏´‡πâ‡∏≠‡∏á ${nextClass[2]} (${nextClass[4]}) | <i class="fas fa-clock me-1"></i>${timeMap[nextClass[5]]} ‡∏ô.`;
  } else if(nextTitle) { 
    nextTitle.innerText = "‡∏™‡∏≠‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß"; nextDetail.innerText = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏£‡∏∞‡∏á‡∏≤‡∏ô‡∏™‡∏≠‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß"; 
  }
}

function jumpToAttendance(encodedData) {
  sessionStorage.setItem('pending_attendance_item', decodeURIComponent(encodedData));
  const now = new Date();
  const localDate = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
  sessionStorage.setItem('pending_teaching_date', localDate);
  loadPage('Page_Academic');
}

function loadTeacherAtRiskDashboard(teacherId, term, year) {
  let container = document.getElementById('atRiskDashboardContainer');
  if (!container) {
    const pageContent = document.getElementById('page-content');
    if(pageContent) {
      pageContent.insertAdjacentHTML('beforeend', '<div id="atRiskDashboardContainer" class="mt-4 animate__animated animate__fadeInUp pb-5"></div>');
      container = document.getElementById('atRiskDashboardContainer');
    }
  }
  if(!container) return;
  const riskCacheKey = `risk_dash_${teacherId}_${term}_${year}`;
  if (sessionStorage.getItem(riskCacheKey)) {
    renderTeacherAtRiskDashboard(JSON.parse(sessionStorage.getItem(riskCacheKey)), container); return; 
  }
  container.innerHTML = `<div class="text-center p-4"><div class="spinner-border text-danger mb-2" role="status"></div><div class="text-muted small">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏≤‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤...</div></div>`;
  google.script.run.withSuccessHandler(function(data) {
    sessionStorage.setItem(riskCacheKey, JSON.stringify(data));
    renderTeacherAtRiskDashboard(data, container);
  }).getTeacherAtRiskDashboard(teacherId, term, year);
}

function renderTeacherAtRiskDashboard(data, container) {
  const { critical, ms, risk } = data;
  const renderList = (arr, colorClass) => {
    if(arr.length === 0) return `<div class="text-center text-muted small py-4">‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°! ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ üéâ</div>`;
    return arr.map(s => `<div class="d-flex justify-content-between align-items-center border-bottom py-2"><div style="flex-grow:1; padding-right:10px;"><div class="fw-bold text-dark" style="font-size: 0.85rem;">${s.id} ${s.name}</div><div class="text-primary" style="font-size: 0.75rem;"><i class="fas fa-book me-1"></i>${s.subjectCode} (${s.className})</div><div class="text-muted" style="font-size: 0.7rem;">‡∏™‡∏≠‡∏ô‡πÑ‡∏õ ${s.taught} ‡∏Ñ‡∏≤‡∏ö (‡∏Ç‡∏≤‡∏î <span class="text-danger fw-bold">${s.absent}</span>, ‡∏•‡∏≤ <span class="text-info">${s.leave}</span>)</div></div><div><span class="badge bg-${colorClass} rounded-pill shadow-sm" style="font-size: 0.85rem;">${s.percent}%</span></div></div>`).join('');
  };
  const html = `<h6 class="fw-bold text-danger mb-3 border-bottom pb-2 border-danger border-2 d-inline-block mt-2"><i class="fas fa-exclamation-triangle me-2"></i>‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á (‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô)</h6><div class="row g-3"><div class="col-md-4"><div class="card border-danger shadow-sm h-100"><div class="card-header bg-danger text-white fw-bold small d-flex justify-content-between align-items-center"><span><i class="fas fa-ban me-1"></i> ‡∏´‡∏°‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (< 60%)</span><span class="badge bg-white text-danger">${critical.length}</span></div><div class="card-body p-2" style="max-height: 300px; overflow-y: auto;">${renderList(critical, 'danger')}</div></div></div><div class="col-md-4"><div class="card border-warning shadow-sm h-100"><div class="card-header bg-warning text-dark fw-bold small d-flex justify-content-between align-items-center"><span><i class="fas fa-exclamation-circle me-1"></i> ‡∏ï‡∏¥‡∏î ‡∏°‡∏™. (60-79%)</span><span class="badge bg-white text-dark">${ms.length}</span></div><div class="card-body p-2" style="max-height: 300px; overflow-y: auto;">${renderList(ms, 'warning text-dark')}</div></div></div><div class="col-md-4"><div class="card border-info shadow-sm h-100"><div class="card-header bg-info text-dark fw-bold small d-flex justify-content-between align-items-center"><span><i class="fas fa-search me-1"></i> ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á (80-85%)</span><span class="badge bg-white text-dark">${risk.length}</span></div><div class="card-body p-2" style="max-height: 300px; overflow-y: auto;">${renderList(risk, 'info text-dark')}</div></div></div></div>`;
  container.innerHTML = html;
}

// ==========================================
// 9. ACADEMIC & ATTENDANCE LOGIC
// ==========================================
var sigCanvas, sigCtx, isDrawing = false;
var currentStudents = [];
let tempHistoryData = [];

function getRealClassName() {
  const classVal = document.getElementById('selectClass').value;
  if (!classVal) return "";
  return String(JSON.parse(classVal)[2]).trim(); 
}

function initAcademicPage() {
  const user = getSessionUser();
  if(!user) return;
  if(document.getElementById('academic-header-info')) document.getElementById('academic-header-info').innerText = `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô: ${user.name} | ‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ${user.currentYear}`;
  
  const dateInput = document.getElementById('teachingDate');
  const pendingDate = sessionStorage.getItem('pending_teaching_date');
  if (pendingDate) {
      if(dateInput) dateInput.value = pendingDate;
      sessionStorage.removeItem('pending_teaching_date'); 
  } else if(dateInput && !dateInput.value) {
      const today = new Date();
      dateInput.value = new Date(today.getTime() - (today.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
  }
  updateThaiDateDisplay();
  reloadTimetableByDate();
}

function updateThaiDateDisplay() {
  const dateVal = document.getElementById('teachingDate').value;
  const display = document.getElementById('thaiDateDisplay');
  if(display && dateVal) display.innerHTML = '<i class="fas fa-calendar-check me-2"></i>' + formatThaiDate(dateVal);
}

function reloadTimetableByDate(forceRefresh = false) {
  const user = getSessionUser();
  const dateInput = document.getElementById('teachingDate');
  const dateStr = dateInput ? dateInput.value : "";
  if(!user || !dateStr) { showLoader(false); return; }

  const cacheKey = `v2_timetable_${user.id}_${dateStr}`;
  if (!forceRefresh && sessionStorage.getItem(cacheKey)) { buildTimetableDropdown(JSON.parse(sessionStorage.getItem(cacheKey))); return; }

  showLoader(true);
  google.script.run
    .withFailureHandler(err => { showLoader(false); alert("Error: " + err.message); })
    .withSuccessHandler(function(timetable) {
      try { sessionStorage.setItem(cacheKey, JSON.stringify(timetable)); } catch(e){} 
      buildTimetableDropdown(timetable);
    }).getTeacherTimetableByDate(user.id, dateStr); 
}

function buildTimetableDropdown(timetable) {
  const select = document.getElementById('selectClass');
  if(!select) return;
  select.innerHTML = '<option value="">-- ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô --</option>';
  if(document.getElementById('studentRows')) document.getElementById('studentRows').innerHTML = ''; 
  document.getElementById('classInfoCard')?.classList.add('d-none');
  document.getElementById('studentListSection')?.classList.add('d-none');

  if(!timetable || timetable.length === 0) { select.innerHTML = '<option value="">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>'; showLoader(false); return; }
  
  timetable.forEach(item => {
    let opt = document.createElement('option');
    opt.value = JSON.stringify(item);
    opt.text = `‡∏Ñ‡∏≤‡∏ö ${item[5]}: ${item[0]} ${item[1]} (${String(item[2]).trim()})`;
    select.add(opt);
  });

  const pendingStr = sessionStorage.getItem('pending_attendance_item');
  if (pendingStr) {
     try {
         const pendingObj = JSON.parse(pendingStr);
         for(let i = 0; i < select.options.length; i++) {
             if(!select.options[i].value) continue;
             const optObj = JSON.parse(select.options[i].value);
             if(optObj[0] === pendingObj[0] && optObj[2] === pendingObj[2] && String(optObj[5]) === String(pendingObj[5])) {
                 select.selectedIndex = i; break;
             }
         }
     } catch(e) { console.error("Error parsing pending item:", e); }
     if (select.selectedIndex > 0) loadStudentList(); else showLoader(false); 
     sessionStorage.removeItem('pending_attendance_item');
  } else { showLoader(false); }
}

function autoSelectRoom() {
  const val = document.getElementById('selectClass').value;
  if(!val) return;
  const roomSelect = document.getElementById('selectRoom');
  if(roomSelect) roomSelect.value = String(JSON.parse(val)[3]).trim();
  loadStudentList(); 
}

function loadStudentList(forceRefresh = false) {
    const classVal = document.getElementById('selectClass').value;
    const btn = document.getElementById('btnSubmitAll');
    const dateInput = document.getElementById('teachingDate'); 

    if(!classVal) {
        if(btn) btn.disabled = true;
        document.getElementById('classInfoCard')?.classList.add('d-none');
        document.getElementById('studentListSection')?.classList.add('d-none');
        showLoader(false); return;
    }

    const item = JSON.parse(classVal);
    const fullClassName = getRealClassName(); 
    let dateStr = dateInput && dateInput.value ? dateInput.value : new Date().toISOString().split('T')[0];

    document.getElementById('classInfoCard')?.classList.remove('d-none');
    if(document.getElementById('dispClass')) document.getElementById('dispClass').innerText = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á: ${fullClassName}`;

    showLoader(true);
    const cacheKey = `v4_stdlist_${fullClassName}`;

    const fetchHistoryAndRender = (studentsData) => {
        google.script.run
        .withFailureHandler(err => { showLoader(false); renderAttendanceTable(studentsData, {}); })
        .withSuccessHandler(function(historyArray) {
            showLoader(false);
            const historyMap = {};
            if (historyArray) { historyArray.forEach(h => { historyMap[h.cleanId] = h.status; historyMap[String(h.studentId).trim()] = h.status; }); }
            renderAttendanceTable(studentsData, historyMap);
            document.getElementById('studentListSection')?.classList.remove('d-none');
            
            if(btn) {
                btn.disabled = false;
                if(Object.keys(historyMap).length > 0) {
                    btn.innerHTML = '<i class="fas fa-edit me-1"></i> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô (‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á)';
                    btn.className = "btn btn-warning w-100 mt-4 py-3 fw-bold shadow-sm";
                } else {
                    btn.innerHTML = '<i class="fas fa-save me-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô';
                    btn.className = "btn btn-primary w-100 mt-4 py-3 fw-bold shadow-sm";
                }
                let detailBtn = document.getElementById('btnDetailedSubmit');
                if(!detailBtn) btn.insertAdjacentHTML('afterend', `<button id="btnDetailedSubmit" class="btn btn-outline-success w-100 py-2 mt-2 fw-bold shadow-sm" onclick="openDetailedLessonModal()"><i class="fas fa-clipboard-list me-2"></i>‡∏à‡∏ö‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏™‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (DPA/3R8C)</button>`);
            }
            setTimeout(setupSignatureCanvas, 200);
        }).getTodayAttendanceHistory(dateStr, item[0], fullClassName);
    };

    if (!forceRefresh && sessionStorage.getItem(cacheKey)) {
        currentStudents = JSON.parse(sessionStorage.getItem(cacheKey));
        fetchHistoryAndRender(currentStudents); 
    } else {
        google.script.run
        .withFailureHandler(err => { showLoader(false); alert("Error: " + err.message); })
        .withSuccessHandler(function(students) {
            currentStudents = students;
            if(!students || students.length === 0) {
                showLoader(false);
                document.getElementById('studentRows').innerHTML = `<tr><td colspan="3" class="text-center p-4 text-danger">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡πâ‡∏≠‡∏á ${fullClassName}</td></tr>`;
                if(btn) btn.disabled = true; return;
            }
            try { sessionStorage.setItem(cacheKey, JSON.stringify(students)); } catch(e){}
            fetchHistoryAndRender(students);
        }).getStudentsByClass(fullClassName);
    }
}

function renderAttendanceTable(students, historyMap = {}) {
  let html = '';
  students.sort((a, b) => String(a[0]).localeCompare(String(b[0])));
  
  students.forEach((s, index) => {
    const rawId = String(s[0]).trim();    
    const cleanId = String(parseInt(rawId)); 
    const stdName = s[2];
    
    let currentStatus = "‡∏°‡∏≤"; let isMatched = false;
    if (historyMap[cleanId]) { currentStatus = historyMap[cleanId]; isMatched = true; } 
    else if (historyMap[rawId]) { currentStatus = historyMap[rawId]; isMatched = true; }
    
    html += `<tr><td class="text-center fw-bold text-muted">${index + 1}</td><td><div class="fw-bold">${stdName}</div><div class="small text-muted">ID: ${rawId} ${isMatched ? '<i class="fas fa-check-circle text-success ms-1"></i>' : ''}</div></td><td><div class="btn-group w-100" role="group"><input type="radio" class="btn-check" name="status_${rawId}" id="present_${rawId}" value="‡∏°‡∏≤" ${currentStatus === '‡∏°‡∏≤' ? 'checked' : ''} onchange="updateSummary()"><label class="btn btn-outline-success btn-sm" for="present_${rawId}">‡∏°‡∏≤</label><input type="radio" class="btn-check" name="status_${rawId}" id="late_${rawId}" value="‡∏™‡∏≤‡∏¢" ${currentStatus === '‡∏™‡∏≤‡∏¢' ? 'checked' : ''} onchange="updateSummary()"><label class="btn btn-outline-warning btn-sm" for="late_${rawId}">‡∏™‡∏≤‡∏¢</label><input type="radio" class="btn-check" name="status_${rawId}" id="leave_${rawId}" value="‡∏•‡∏≤" ${currentStatus === '‡∏•‡∏≤' || currentStatus === 'leave' ? 'checked' : ''} onchange="updateSummary()"><label class="btn btn-outline-info btn-sm" for="leave_${rawId}">‡∏•‡∏≤</label><input type="radio" class="btn-check" name="status_${rawId}" id="absent_${rawId}" value="‡∏Ç‡∏≤‡∏î" ${currentStatus === '‡∏Ç‡∏≤‡∏î' ? 'checked' : ''} onchange="updateSummary()"><label class="btn btn-outline-danger btn-sm" for="absent_${rawId}">‡∏Ç‡∏≤‡∏î</label></div></td></tr>`;
  });
  
  document.getElementById('studentRows').innerHTML = html;
  updateSummary();
}

function updateSummary() {
  const present = document.querySelectorAll('input[value="‡∏°‡∏≤"]:checked').length;
  const absent = document.querySelectorAll('input[value="‡∏Ç‡∏≤‡∏î"]:checked').length;
  const late = document.querySelectorAll('input[value="‡∏™‡∏≤‡∏¢"]:checked').length;
  const leave = document.querySelectorAll('input[value="‡∏•‡∏≤"]:checked').length;

  if(document.getElementById('sumPresent')) document.getElementById('sumPresent').innerText = present;
  if(document.getElementById('sumAbsent')) document.getElementById('sumAbsent').innerText = absent;
  if(document.getElementById('sumOther')) document.getElementById('sumOther').innerText = late + leave;
}

function setupSignatureCanvas() {
  sigCanvas = document.getElementById('sig-canvas');
  if(!sigCanvas) return;
  sigCtx = sigCanvas.getContext('2d');
  sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
  sigCanvas.onmousedown = () => isDrawing = true;
  window.onmouseup = () => { isDrawing = false; sigCtx.beginPath(); };
  sigCanvas.onmousemove = drawSig;
  sigCanvas.ontouchstart = (e) => { e.preventDefault(); isDrawing = true; };
  sigCanvas.ontouchend = () => { isDrawing = false; sigCtx.beginPath(); };
  sigCanvas.ontouchmove = (e) => { e.preventDefault(); drawSig(e.touches[0]); };
}

function drawSig(e) {
  if (!isDrawing) return;
  const rect = sigCanvas.getBoundingClientRect();
  const x = (e.clientX || e.pageX) - rect.left; const y = (e.clientY || e.pageY) - rect.top;
  sigCtx.lineWidth = 3; sigCtx.lineCap = "round"; sigCtx.strokeStyle = "#000080";
  sigCtx.lineTo(x, y); sigCtx.stroke(); sigCtx.beginPath(); sigCtx.moveTo(x, y);
}
function clearSignature() { if(sigCtx) { sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height); sigCtx.beginPath(); } }

function submitAcademicData() {
  const classVal = document.getElementById('selectClass').value;
  const topic = document.getElementById('inputTopic').value;
  const dateInput = document.getElementById('teachingDate'); 
  const user = getSessionUser();
  
  if(!topic) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö");
  const sigData = sigCanvas.toDataURL();
  if(sigData.length < 1000) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö");

  const btn = document.getElementById('btnSubmitAll');
  btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

  const item = JSON.parse(classVal);
  let date = dateInput && dateInput.value ? dateInput.value : new Date().toISOString().split('T')[0];
  const normalizedClassName = getRealClassName(); 
  
  const attendanceBatch = currentStudents.map(s => {
    return { date: date, term: user.currentTerm, year: user.currentYear, subjectCode: item[0], subjectName: item[1], className: normalizedClassName, period: item[5], studentId: s[0], studentName: s[2], status: document.querySelector(`input[name="status_${s[0]}"]:checked`).value, teacherId: user.id };
  });

  const lessonRecord = {
    date: date, subjectCode: item[0], subjectName: item[1], className: normalizedClassName, period: item[5], topic: topic,
    totalPresent: parseInt(document.getElementById('sumPresent').innerText) + parseInt(document.querySelectorAll('input[value="‡∏™‡∏≤‡∏¢"]:checked').length),
    totalAbsent: document.getElementById('sumAbsent').innerText,
    totalLeave: document.querySelectorAll('input[value="‡∏•‡∏≤"]:checked').length,
    teacherId: user.id, signature: sigData
  };

  showLoader(true);
  google.script.run.withSuccessHandler(function() {
    google.script.run.withSuccessHandler(function() {
      showLoader(false);
      sessionStorage.removeItem(`risk_dash_${user.id}_${user.currentTerm}_${user.currentYear}`);
      alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
      loadPage('Page_Dashboard_Teacher'); 
    }).saveLessonRecord(lessonRecord);
  }).saveAttendanceBatch(attendanceBatch);
}

function getSessionUser() { return JSON.parse(localStorage.getItem('pssms_user') || sessionStorage.getItem('pssms_user')); }

// ----------------------------------------------------------------------
// ‡∏ä‡∏∏‡∏î‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Modal ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
// ----------------------------------------------------------------------
function viewTodayHistory() {
  const classVal = document.getElementById('selectClass').value;
  const dateInput = document.getElementById('teachingDate'); 
  if(!classVal) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
  
  const item = JSON.parse(classVal);
  const subjectCode = item[0];
  const className = getRealClassName(); 
  let dateStr = dateInput && dateInput.value ? dateInput.value : new Date().toISOString().split('T')[0];

  showLoader(true);
  google.script.run.withSuccessHandler(function(history) {
    showLoader(false);
    if (!history || history.length === 0) return alert("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏±‡∏ö");
    tempHistoryData = history;
    renderHistoryModal(subjectCode);
  }).getTodayAttendanceHistory(dateStr, subjectCode, className);
}

function viewAllHistory() {
  const classVal = document.getElementById('selectClass').value;
  if(!classVal) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
  
  const item = JSON.parse(classVal);
  const subjectCode = item[0];
  const className = getRealClassName(); 

  showLoader(true);
  google.script.run.withSuccessHandler(function(sessions) {
    showLoader(false);
    renderSessionListModal(sessions, subjectCode, className);
  }).getCourseSessionList(subjectCode, className);
}

function renderSessionListModal(sessions, subjectCode, className) {
  let html = '';
  if (sessions.length === 0) {
    html = '<div class="text-center p-4 text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡πÉ‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ</div>';
  } else {
    html = '<div class="list-group list-group-flush">';
    sessions.forEach(s => {
      html += `<button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-3" onclick="loadHistoryForEdit('${s.date}')"><div><div class="fw-bold text-primary"><i class="fas fa-calendar-alt me-2"></i>${s.displayDate}</div><div class="small text-muted">‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà ${s.period}</div></div><span class="badge bg-light text-dark border rounded-pill">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ${s.count} ‡∏Ñ‡∏ô <i class="fas fa-chevron-right ms-2 text-secondary"></i></span></button>`;
    });
    html += '</div>';
  }

  const modalHtml = `<div id="sessionListModal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:10000; display:flex; align-items:center; justify-content:center; padding:15px;"><div class="bg-white rounded-3 shadow-lg animate__animated animate__fadeInUp" style="width:100%; max-width:500px; max-height:80vh; display:flex; flex-direction:column;"><div class="p-3 bg-primary text-white d-flex justify-content-between align-items-center rounded-top"><h6 class="mb-0 fw-bold"><i class="fas fa-history me-2"></i>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô: ${className}</h6><button class="btn-close btn-close-white" onclick="document.getElementById('sessionListModal').remove()"></button></div><div class="p-0" style="overflow-y:auto;">${html}</div><div class="p-3 bg-light border-top text-center"><button class="btn btn-secondary btn-sm w-100" onclick="document.getElementById('sessionListModal').remove()">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button></div></div></div>`;
  const old = document.getElementById('sessionListModal'); if(old) old.remove();
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function loadHistoryForEdit(dateStr) {
  const modalList = document.getElementById('sessionListModal'); if(modalList) modalList.remove();
  const classVal = document.getElementById('selectClass').value;
  const item = JSON.parse(classVal);
  const subjectCode = item[0];
  const className = getRealClassName(); 
  const dateInput = document.getElementById('teachingDate');
  if(dateInput) { dateInput.value = dateStr; reloadTimetableByDate(); }

  showLoader(true);
  google.script.run.withSuccessHandler(function(historyArray) {
    showLoader(false);
    tempHistoryData = historyArray;
    if (!tempHistoryData || tempHistoryData.length === 0) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î");
    renderHistoryModal(subjectCode);
  }).getTodayAttendanceHistory(dateStr, subjectCode, className);
}

function renderHistoryModal(subjectCode) {
  let html = tempHistoryData.map((h, index) => {
    let badgeClass = h.status === '‡∏°‡∏≤' ? 'bg-success' : (h.status === '‡∏™‡∏≤‡∏¢' ? 'bg-warning text-dark' : 'bg-danger');
    return `<div class="d-flex justify-content-between align-items-center border-bottom py-2"><div style="flex-grow: 1;"><div class="fw-bold" style="font-size: 0.85rem;">${h.studentName}</div><div id="status-badge-${index}" class="badge ${badgeClass}" style="font-size: 0.7rem;">${h.status}</div></div><div class="btn-group btn-group-sm"><button class="btn btn-outline-success" onclick="updateLocalStatus(${index}, '‡∏°‡∏≤')">‡∏°‡∏≤</button><button class="btn btn-outline-warning" onclick="updateLocalStatus(${index}, '‡∏™‡∏≤‡∏¢')">‡∏™‡∏≤‡∏¢</button><button class="btn btn-outline-info" onclick="updateLocalStatus(${index}, '‡∏•‡∏≤')">‡∏•‡∏≤</button><button class="btn btn-outline-danger" onclick="updateLocalStatus(${index}, '‡∏Ç‡∏≤‡∏î')">‡∏Ç‡∏≤‡∏î</button></div></div>`;
  }).join('');

  const modalHtml = `<div id="historyModal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:10000; display:flex; align-items:center; justify-content:center; padding:15px;"><div class="bg-white rounded-3 shadow-lg" style="width:100%; max-width:450px; max-height:85vh; display:flex; flex-direction:column;"><div class="p-3 bg-dark text-white d-flex justify-content-between align-items-center"><h6 class="mb-0 fw-bold"><i class="fas fa-user-edit me-2"></i>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</h6><button class="btn-close btn-close-white" onclick="document.getElementById('historyModal').remove()"></button></div><div class="p-3" style="overflow-y:auto;"><div class="alert alert-secondary small py-1 mb-2">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç" ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</div>${html}</div><div class="p-3 bg-light border-top"><button class="btn btn-primary w-100 fw-bold py-2" onclick="saveAllHistoryChanges()"><i class="fas fa-save me-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button></div></div></div>`;
  const oldModal = document.getElementById('historyModal'); if(oldModal) oldModal.remove();
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function updateLocalStatus(index, newStatus) {
  tempHistoryData[index].status = newStatus;
  const badge = document.getElementById(`status-badge-${index}`);
  badge.innerText = newStatus;
  badge.className = `badge ${newStatus === '‡∏°‡∏≤' ? 'bg-success' : (newStatus === '‡∏™‡∏≤‡∏¢' ? 'bg-warning text-dark' : (newStatus === '‡∏•‡∏≤' ? 'bg-info text-dark' : 'bg-danger'))}`;
}

function saveAllHistoryChanges() {
  if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
  const user = getSessionUser();
  showLoader(true);
  google.script.run.withSuccessHandler(function(res) {
    showLoader(false);
    if(res.status === "success") {
      alert("‚úÖ " + res.message);
      document.getElementById('historyModal').remove();
      if(user) sessionStorage.removeItem(`risk_dash_${user.id}_${user.currentTerm}_${user.currentYear}`);
      loadStudentList(true); 
    } else { alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + res.message); }
  }).updateAttendanceBatch(tempHistoryData); 
}

// ==========================================
// ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏™‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (Detailed Lesson)
// ==========================================
function openDetailedLessonModal() {
  const topic = document.getElementById('inputTopic').value;
  if(!topic) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å '‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô' ‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏£‡∏±‡∏ö"); document.getElementById('inputTopic').focus(); return; }
  const sigData = sigCanvas.toDataURL();
  if(sigData.length < 1000) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö"); return; }
  document.getElementById('detailedLessonForm').reset();
  const modal = new bootstrap.Modal(document.getElementById('detailedLessonModal'));
  modal.show();
}

function getBase64(file) {
  return new Promise((resolve, reject) => {
    if(!file) { resolve(null); return; }
    const reader = new FileReader(); reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error);
  });
}

async function submitDetailedLesson() {
  const classVal = document.getElementById('selectClass').value;
  const topic = document.getElementById('inputTopic').value;
  const dateInput = document.getElementById('teachingDate'); 
  const user = getSessionUser();
  const item = JSON.parse(classVal);
  let date = dateInput && dateInput.value ? dateInput.value : new Date().toISOString().split('T')[0];
  const normalizedClassName = getRealClassName(); 
  
  const dpaElements = document.querySelectorAll('.dpa-check:checked'); const dpaValues = Array.from(dpaElements).map(el => el.value);
  const skillElements = document.querySelectorAll('.skill-check:checked'); const skillValues = Array.from(skillElements).map(el => el.value);
  const workFile = document.getElementById('dl_work_file').files[0];
  const imageFile = document.getElementById('dl_image_file').files[0];

  const submitBtn = document.querySelector('#detailedLessonModal .btn-primary');
  const originalBtnText = submitBtn.innerHTML;
  submitBtn.disabled = true; submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
  showLoader(true);

  try {
    const workFileBase64 = await getBase64(workFile);
    const imageFileBase64 = await getBase64(imageFile);

    const detailedRecord = {
      date: date, subjectCode: item[0], subjectName: item[1], className: normalizedClassName, period: item[5], topic: topic, teacherId: user.id,
      outcomes: document.getElementById('dl_outcomes').value, problems: document.getElementById('dl_problems').value, solutions: document.getElementById('dl_solutions').value,
      dpa: dpaValues, skills: skillValues, studentResults: document.getElementById('dl_student_results').value, workFileBase64: workFileBase64, imageFileBase64: imageFileBase64
    };

    const attendanceBatch = currentStudents.map(s => {
      return { date: date, term: user.currentTerm, year: user.currentYear, subjectCode: item[0], subjectName: item[1], className: normalizedClassName, period: item[5], studentId: s[0], studentName: s[2], status: document.querySelector(`input[name="status_${s[0]}"]:checked`).value, teacherId: user.id };
    });

    const basicRecord = {
      date: date, subjectCode: item[0], subjectName: item[1], className: normalizedClassName, period: item[5], topic: topic,
      totalPresent: parseInt(document.getElementById('sumPresent').innerText) + parseInt(document.querySelectorAll('input[value="‡∏™‡∏≤‡∏¢"]:checked').length),
      totalAbsent: document.getElementById('sumAbsent').innerText, totalLeave: document.querySelectorAll('input[value="‡∏•‡∏≤"]:checked').length,
      teacherId: user.id, signature: sigCanvas.toDataURL()
    };

    google.script.run.withSuccessHandler(() => {
      google.script.run.withSuccessHandler(() => {
        google.script.run.withSuccessHandler((res) => {
          showLoader(false);
          bootstrap.Modal.getInstance(document.getElementById('detailedLessonModal')).hide();
          sessionStorage.removeItem(`risk_dash_${user.id}_${user.currentTerm}_${user.currentYear}`);
          sessionStorage.removeItem(`lesson_history_${user.id}_${user.currentTerm}_${user.currentYear}`);
          alert(res.message);
          loadPage('Page_Dashboard_Teacher'); 
        }).saveDetailedLessonRecord(detailedRecord);
      }).saveLessonRecord(basicRecord);
    }).saveAttendanceBatch(attendanceBatch);

  } catch (err) {
    showLoader(false); submitBtn.disabled = false; submitBtn.innerHTML = originalBtnText; alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
  }
}

// ==========================================
// 10. ACADEMIC REPORT LOGIC
// ==========================================
function initAcademicReportPage() { reloadReportSubjects(); }

function reloadReportSubjects() {
  const termEl = document.getElementById('reportTerm');
  const yearEl = document.getElementById('reportYear');
  const select = document.getElementById('reportClassSelect');
  if(!termEl || !yearEl || !select) return;
  const term = termEl.value; const year = yearEl.value; const user = getSessionUser();

  select.innerHTML = `<option value="">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏¥‡∏ä‡∏≤...</option>`; select.disabled = true;
  const tbody = document.getElementById('reportTableBody'); if(tbody) tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-muted">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤</td></tr>';
  const summaryDiv = document.getElementById('reportSummaryInfo'); if(summaryDiv) summaryDiv.remove();

  const subjectCacheKey = `report_subjects_${user.id}_${term}_${year}`;
  const cachedSubjects = sessionStorage.getItem(subjectCacheKey);
  if (cachedSubjects) { buildReportSubjectDropdown(JSON.parse(cachedSubjects), term, year); return; }

  google.script.run
    .withFailureHandler(err => { select.innerHTML = '<option value="">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</option>'; select.disabled = false; alert(err.message); })
    .withSuccessHandler(subjects => { sessionStorage.setItem(subjectCacheKey, JSON.stringify(subjects)); buildReportSubjectDropdown(subjects, term, year); })
    .getTeacherSubjects(user.id, user.role, term, year);
}

function buildReportSubjectDropdown(subjects, term, year) {
  const select = document.getElementById('reportClassSelect');
  select.disabled = false;
  if(subjects.length === 0) { select.innerHTML = `<option value="">‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏ô‡πÄ‡∏ó‡∏≠‡∏° ${term}/${year}</option>`; return; }
  let html = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ --</option><option value="ALL" class="fw-bold text-white bg-primary">‡∏î‡∏π‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô (‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</option>';
  subjects.forEach(sub => { html += `<option value='${JSON.stringify(sub)}'>${sub[0]} - ${sub[3]} (${sub[1]})</option>`; });
  select.innerHTML = html;
}

function generateReport() {
  const val = document.getElementById('reportClassSelect').value;
  if(!val) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
  const term = document.getElementById('reportTerm').value; const year = document.getElementById('reportYear').value; const user = getSessionUser();
  showLoader(true);

  if (val === "ALL") {
    google.script.run.withFailureHandler(err => { showLoader(false); alert("Error: " + err.message); })
      .withSuccessHandler(function(res) { try { renderAllSubjectsReportTable(res); } catch (e) { showLoader(false); console.error(e); } })
      .getAllSubjectsReport(user.id, term, year);
  } else {
    try {
      const item = JSON.parse(val); 
      google.script.run.withFailureHandler(err => { showLoader(false); alert("Error: " + err.message); })
        .withSuccessHandler(function(res) { try { renderReportTable(res, item[0], item[1], item[2]); } catch (e) { showLoader(false); console.error(e); } })
        .getSemesterReport(item[0], item[2], term, year);
    } catch (e) { showLoader(false); alert("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: " + e.message); }
  }
}

function renderReportTable(res, subjectCode, subjectName, className) {
  showLoader(false);
  const tbody = document.getElementById('reportTableBody'); if (!tbody) return;
  tbody.innerHTML = '';
  const oldHeader = document.getElementById('reportSummaryInfo'); if(oldHeader) oldHeader.remove();

  if(!res || !res.students || res.students.length === 0) { tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ</td></tr>'; return; }

  const data = res.students; const meta = res.meta || { periodsPerWeek: 0, totalCoursePeriods: 0, maxAbsenceQuota: 0, currentTotalTaught: 0 }; 
  const taught = meta.currentTotalTaught; const total = meta.totalCoursePeriods; const progressPercent = total > 0 ? Math.min((taught / total) * 100, 100).toFixed(1) : 0; const remaining = total - taught;
  const critical = []; const ms = []; const risk = [];
  data.forEach(s => { const p = parseFloat(s.percent); if (p < 60) critical.push(s); else if (p < 80) ms.push(s); else if (p <= 85) risk.push(s); });

  const renderList = (arr, colorClass) => {
    if(arr.length === 0) return `<div class="text-center text-muted small py-3">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ üéâ</div>`;
    return arr.map(s => `<div class="d-flex justify-content-between align-items-center border-bottom py-2"><div><div class="fw-bold text-dark" style="font-size: 0.85rem;">${s.id} ${s.name}</div><div class="text-muted" style="font-size: 0.75rem;">‡∏°‡∏≤ <span class="text-success fw-bold">${s.present + s.late}</span>/${taught} ‡∏Ñ‡∏≤‡∏ö (‡∏Ç‡∏≤‡∏î <span class="text-danger">${s.absent}</span>, ‡∏•‡∏≤ <span class="text-info">${s.leave}</span>)</div></div><span class="badge bg-${colorClass} rounded-pill" style="font-size: 0.8rem;">${s.percent}%</span></div>`).join('');
  };

  let infoHtml = `<div id="reportSummaryInfo" class="mb-4 animate__animated animate__fadeIn"><div class="card border-0 shadow-sm mb-4" style="background: linear-gradient(to right, #ffffff, #f8f9fa);"><div class="card-body"><div class="d-flex justify-content-between align-items-center mb-2"><h6 class="fw-bold text-primary m-0"><i class="fas fa-clock me-2"></i>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤: ${subjectCode} ${subjectName} (${className})</h6><span class="badge bg-light text-dark border">‡∏™‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß ${taught} / ${total} ‡∏Ñ‡∏≤‡∏ö</span></div><div class="progress" style="height: 15px; border-radius: 10px; background-color: #e9ecef;"><div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" role="progressbar" style="width: ${progressPercent}%">${progressPercent}%</div></div><div class="d-flex justify-content-between mt-2" style="font-size: 0.8rem;"><span class="text-secondary"><i class="fas fa-info-circle me-1"></i>‡πÄ‡∏Å‡∏ì‡∏ë‡πå: ‡∏Ç‡∏≤‡∏î‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î <b>${meta.maxAbsenceQuota}</b> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (20%)</span><span class="text-success fw-bold">‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å ${remaining > 0 ? remaining : 0} ‡∏Ñ‡∏≤‡∏ö</span></div></div></div><h6 class="fw-bold text-danger mb-3"><i class="fas fa-exclamation-triangle me-2"></i>‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</h6><div class="row g-3 mb-4"><div class="col-md-4"><div class="card border-info shadow-sm h-100"><div class="card-header bg-info text-dark fw-bold small d-flex justify-content-between"><span>‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á (80-85%)</span><span class="badge bg-white text-dark">${risk.length}</span></div><div class="card-body p-2" style="max-height: 250px; overflow-y: auto;">${renderList(risk, 'info text-dark')}</div></div></div><div class="col-md-4"><div class="card border-warning shadow-sm h-100"><div class="card-header bg-warning text-dark fw-bold small d-flex justify-content-between"><span>‡∏ï‡∏¥‡∏î ‡∏°‡∏™. (60-79%)</span><span class="badge bg-white text-dark">${ms.length}</span></div><div class="card-body p-2" style="max-height: 250px; overflow-y: auto;">${renderList(ms, 'warning text-dark')}</div></div></div><div class="col-md-4"><div class="card border-danger shadow-sm h-100"><div class="card-header bg-danger text-white fw-bold small d-flex justify-content-between"><span>‡∏´‡∏°‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (< 60%)</span><span class="badge bg-white text-danger">${critical.length}</span></div><div class="card-body p-2" style="max-height: 250px; overflow-y: auto;">${renderList(critical, 'danger')}</div></div></div></div></div>`;
  const tableEl = document.querySelector('table');
  if(tableEl) { tableEl.insertAdjacentHTML('beforebegin', infoHtml); const theads = tableEl.querySelectorAll('th'); if (theads.length >= 3) { theads[1].innerText = "‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"; theads[2].innerText = "‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•"; } }

  let html = '';
  data.forEach((s, index) => {
    const p = parseFloat(s.percent); const totalMissed = (s.leave || 0) + (s.absent || 0); const remainingQuota = meta.maxAbsenceQuota - totalMissed;
    let statusBadge = ''; let rowClass = ''; let progressColor = ''; let quotaText = '';
    if (remainingQuota >= 0) quotaText = `<span class="text-muted small">‡∏Ç‡∏≤‡∏î‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å <b>${remainingQuota}</b> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>`; else quotaText = `<span class="text-danger fw-bold small">‡πÄ‡∏Å‡∏¥‡∏ô‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤ <b>${Math.abs(remainingQuota)}</b> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>`;
    if (p > 85) { statusBadge = '<span class="badge bg-success rounded-pill px-2">‡∏õ‡∏Å‡∏ï‡∏¥</span>'; progressColor = 'bg-success'; } else if (p >= 80) { statusBadge = '<span class="badge bg-info text-dark rounded-pill px-2">‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á</span>'; progressColor = 'bg-info'; } else if (p >= 60) { statusBadge = '<span class="badge bg-warning text-dark rounded-pill px-2">‡∏°‡∏™.</span>'; rowClass = 'table-warning'; progressColor = 'bg-warning'; } else { statusBadge = '<span class="badge bg-danger rounded-pill px-2">‡∏´‡∏°‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</span>'; rowClass = 'table-danger'; progressColor = 'bg-danger'; }
    html += `<tr class="${rowClass}"><td class="text-center small">${index + 1}</td><td><div class="fw-bold text-primary small">${s.id}</div></td><td><div class="fw-bold small">${s.name}</div></td><td class="text-center"><span class="text-success fw-bold">${s.present}</span> <span class="text-muted">/</span> <span class="text-warning fw-bold">${s.late}</span></td><td class="text-center"><span class="text-info">${s.leave}</span> <span class="text-muted">/</span> <span class="text-danger fw-bold">${s.absent}</span><div class="mt-1">${quotaText}</div></td><td style="vertical-align: middle;"><div class="d-flex align-items-center"><div class="flex-grow-1 me-2"><div class="progress" style="height: 6px;"><div class="progress-bar ${progressColor}" style="width: ${p}%"></div></div></div><span class="fw-bold small ${p < 80 ? 'text-danger' : 'text-success'}">${p}%</span></div></td><td class="text-center">${statusBadge}</td></tr>`;
  });
  tbody.innerHTML = html;
}

function renderAllSubjectsReportTable(data) {
  showLoader(false);
  const tbody = document.getElementById('reportTableBody'); if (!tbody) return;
  tbody.innerHTML = '';
  const oldHeader = document.getElementById('reportSummaryInfo'); if(oldHeader) oldHeader.remove();
  if(!data || data.length === 0) { tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡πÄ‡∏ó‡∏≠‡∏°‡∏ô‡∏µ‡πâ</td></tr>'; return; }

  const critical = []; const ms = []; const risk = [];
  data.forEach(s => { const p = parseFloat(s.percent); if (p < 60) critical.push(s); else if (p < 80) ms.push(s); else if (p <= 85) risk.push(s); });
  const renderList = (arr, colorClass) => {
    if(arr.length === 0) return `<div class="text-center text-muted small py-3">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ üéâ</div>`;
    return arr.map(s => `<div class="d-flex justify-content-between align-items-center border-bottom py-2"><div style="flex-grow:1; padding-right:10px;"><div class="fw-bold text-dark" style="font-size: 0.85rem;">${s.id} ${s.name}</div><div class="text-primary" style="font-size: 0.75rem;"><i class="fas fa-book me-1"></i>${s.subjectCode} (${s.className})</div></div><span class="badge bg-${colorClass} rounded-pill" style="font-size: 0.8rem;">${s.percent}%</span></div>`).join('');
  };

  let infoHtml = `<div id="reportSummaryInfo" class="mb-4 animate__animated animate__fadeIn"><div class="card border-0 shadow-sm mb-4 bg-primary text-white text-center py-3" style="border-radius: 10px;"><h5 class="fw-bold m-0"><i class="fas fa-layer-group me-2"></i>‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</h5><div class="small mt-1 opacity-75">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <b>${data.length}</b> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤)</div></div><h6 class="fw-bold text-danger mb-3"><i class="fas fa-exclamation-triangle me-2"></i>‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤)</h6><div class="row g-3 mb-4"><div class="col-md-4"><div class="card border-info shadow-sm h-100"><div class="card-header bg-info text-dark fw-bold small d-flex justify-content-between"><span>‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á (80-85%)</span><span class="badge bg-white text-dark">${risk.length}</span></div><div class="card-body p-2" style="max-height: 250px; overflow-y: auto;">${renderList(risk, 'info text-dark')}</div></div></div><div class="col-md-4"><div class="card border-warning shadow-sm h-100"><div class="card-header bg-warning text-dark fw-bold small d-flex justify-content-between"><span>‡∏ï‡∏¥‡∏î ‡∏°‡∏™. (60-79%)</span><span class="badge bg-white text-dark">${ms.length}</span></div><div class="card-body p-2" style="max-height: 250px; overflow-y: auto;">${renderList(ms, 'warning text-dark')}</div></div></div><div class="col-md-4"><div class="card border-danger shadow-sm h-100"><div class="card-header bg-danger text-white fw-bold small d-flex justify-content-between"><span>‡∏´‡∏°‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (< 60%)</span><span class="badge bg-white text-danger">${critical.length}</span></div><div class="card-body p-2" style="max-height: 250px; overflow-y: auto;">${renderList(critical, 'danger')}</div></div></div></div></div>`;
  const tableEl = document.querySelector('table');
  if(tableEl) { tableEl.insertAdjacentHTML('beforebegin', infoHtml); const theads = tableEl.querySelectorAll('th'); if (theads.length >= 3) { theads[1].innerText = "‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"; theads[2].innerText = "‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•"; } }

  let html = ''; let currentGroup = ''; let studentIndex = 1; 
  data.forEach((s) => {
    const p = parseFloat(s.percent); const remainingQuota = s.remainingQuota; const groupKey = `${s.subjectCode}_${s.className}`;
    if (groupKey !== currentGroup) {
      studentIndex = 1; 
      html += `<tr style="background-color: #e7f1ff; border-top: 2px solid #0d6efd; border-bottom: 2px solid #0d6efd;"><td colspan="7" class="fw-bold text-primary text-start py-3 ps-3"><i class="fas fa-book-open me-2 text-primary"></i> <span style="font-size: 1.05rem;">‡∏ß‡∏¥‡∏ä‡∏≤: ${s.subjectCode} ${s.subjectName}</span><span class="badge bg-primary rounded-pill ms-2" style="font-size:0.85rem;"><i class="fas fa-users me-1"></i>‡∏´‡πâ‡∏≠‡∏á ${s.className}</span><span class="badge bg-light text-dark border ms-2 shadow-sm">‡∏™‡∏≠‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ${s.taught} ‡∏Ñ‡∏≤‡∏ö</span></td></tr>`;
      currentGroup = groupKey;
    }
    let statusBadge = ''; let rowClass = ''; let progressColor = ''; let quotaText = '';
    if (remainingQuota >= 0) quotaText = `<span class="text-muted small">‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤ <b>${remainingQuota}</b></span>`; else quotaText = `<span class="text-danger fw-bold small">‡πÄ‡∏Å‡∏¥‡∏ô <b>${Math.abs(remainingQuota)}</b></span>`;
    if (p > 85) { statusBadge = '<span class="badge bg-success rounded-pill px-2">‡∏õ‡∏Å‡∏ï‡∏¥</span>'; progressColor = 'bg-success'; } else if (p >= 80) { statusBadge = '<span class="badge bg-info text-dark rounded-pill px-2">‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á</span>'; progressColor = 'bg-info'; } else if (p >= 60) { statusBadge = '<span class="badge bg-warning text-dark rounded-pill px-2">‡∏°‡∏™.</span>'; rowClass = 'table-warning'; progressColor = 'bg-warning'; } else { statusBadge = '<span class="badge bg-danger rounded-pill px-2">‡∏´‡∏°‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</span>'; rowClass = 'table-danger'; progressColor = 'bg-danger'; }
    html += `<tr class="${rowClass}"><td class="text-center small">${studentIndex++}</td><td><div class="fw-bold text-primary small">${s.id}</div></td><td><div class="fw-bold small">${s.name}</div></td><td class="text-center"><span class="text-success fw-bold">${s.present}</span> <span class="text-muted">/</span> <span class="text-warning fw-bold">${s.late}</span></td><td class="text-center"><span class="text-info">${s.leave}</span> <span class="text-muted">/</span> <span class="text-danger fw-bold">${s.absent}</span><div class="mt-1">${quotaText}</div></td><td style="vertical-align: middle;"><div class="d-flex align-items-center"><div class="flex-grow-1 me-2"><div class="progress" style="height: 6px;"><div class="progress-bar ${progressColor}" style="width: ${p}%"></div></div></div><span class="fw-bold small ${p < 80 ? 'text-danger' : 'text-success'}">${p}%</span></div></td><td class="text-center">${statusBadge}</td></tr>`;
  });
  tbody.innerHTML = html;
}

// ==========================================
// 11. BACKGROUND PRELOADER
// ==========================================
function preloadTeacherDataBackground() {
  const user = getSessionUser();
  if(!user || user.role.toUpperCase() === 'STUDENT') return; 
  const subjectCacheKey = `report_subjects_${user.id}_${user.currentTerm}_${user.currentYear}`;
  if (!sessionStorage.getItem(subjectCacheKey)) {
    google.script.run.withSuccessHandler(function(subjects) { sessionStorage.setItem(subjectCacheKey, JSON.stringify(subjects)); }).getTeacherSubjects(user.id, user.role, user.currentTerm, user.currentYear);
  }
}

// ==========================================
// 13. LESSON HISTORY DASHBOARD
// ==========================================
let allLessonHistories = []; 

function initLessonHistoryPage() {
  const user = getSessionUser();
  if(!user) return;
  if(document.getElementById('history-header-info')) document.getElementById('history-header-info').innerText = `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô: ${user.name} | ‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${user.currentTerm}/${user.currentYear}`;
  const cacheKey = `lesson_history_${user.id}_${user.currentTerm}_${user.currentYear}`;

  if (sessionStorage.getItem(cacheKey)) {
     allLessonHistories = JSON.parse(sessionStorage.getItem(cacheKey));
     renderLessonHistoryCards(allLessonHistories); return;
  }
  showLoader(true);
  google.script.run.withFailureHandler(err => { showLoader(false); alert("Error: " + err.message); })
    .withSuccessHandler(res => { showLoader(false); sessionStorage.setItem(cacheKey, JSON.stringify(res)); allLessonHistories = res; renderLessonHistoryCards(res); })
    .getDetailedLessonRecords(user.id, user.currentTerm, user.currentYear);
}

function filterLessonHistory() {
  const keyword = document.getElementById('searchLessonHistory').value.toLowerCase();
  const filtered = allLessonHistories.filter(item => item.subjectCode.toLowerCase().includes(keyword) || item.subjectName.toLowerCase().includes(keyword) || item.className.toLowerCase().includes(keyword) || item.topic.toLowerCase().includes(keyword));
  renderLessonHistoryCards(filtered);
}

function renderLessonHistoryCards(data) {
  const container = document.getElementById('lessonHistoryContainer'); if(!container) return;
  if (data.length === 0) { container.innerHTML = `<div class="col-12 text-center p-5 text-muted"><i class="fas fa-folder-open fa-3x mb-3 opacity-25"></i><h5>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ô‡πÄ‡∏ó‡∏≠‡∏°‡∏ô‡∏µ‡πâ</h5></div>`; return; }

  let html = '';
  data.forEach((item, index) => {
    const dpaBadges = item.dpa.length > 0 ? item.dpa.map(d => `<span class="badge bg-info text-dark me-1 mb-1 shadow-sm">${d}</span>`).join('') : '<span class="text-muted small">- ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏ -</span>';
    const skillBadges = item.skills.length > 0 ? item.skills.map(s => `<span class="badge bg-warning text-dark me-1 mb-1 shadow-sm">${s}</span>`).join('') : '<span class="text-muted small">- ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏ -</span>';
    let attachments = ''; let availableFiles = [];
    if (item.workUrl && !item.workUrl.includes("Error")) availableFiles.push({ url: item.workUrl, title: '‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏•‡∏á‡∏≤‡∏ô/‡∏ä‡∏¥‡πâ‡∏ô‡∏á‡∏≤‡∏ô' });
    if (item.imageUrl && !item.imageUrl.includes("Error")) availableFiles.push({ url: item.imageUrl, title: '‡∏†‡∏≤‡∏û‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏®' });
    if (availableFiles.length > 0) {
      const encodedFiles = encodeURIComponent(JSON.stringify(availableFiles));
      attachments += `<hr class="text-muted mt-2 mb-2"><div class="d-flex gap-2">`;
      availableFiles.forEach((file, fIndex) => {
         let btnClass = fIndex === 0 ? "btn-outline-primary" : "btn-outline-success"; let icon = fIndex === 0 ? "fa-file-alt" : "fa-image";
         attachments += `<button type="button" onclick="openGalleryModal('${encodedFiles}', ${fIndex})" class="btn btn-sm ${btnClass}"><i class="fas ${icon} me-1"></i> ${file.title}</button>`;
      });
      attachments += `</div>`;
    }
    const safeTs = encodeURIComponent(item.timestamp);
    html += `<div class="col-md-6 col-xl-4"><div class="card shadow-sm border-0 w-100 mb-2" style="border-radius: 12px; overflow: hidden;"><div class="card-header bg-dark text-white p-3 d-flex justify-content-between align-items-start gap-2 position-relative"><div style="min-width: 90px;"><span class="badge bg-light text-dark fw-bold mb-1">${formatThaiDate(item.date)}</span><div class="small"><i class="fas fa-clock me-1"></i> ‡∏Ñ‡∏≤‡∏ö ${item.period}</div></div><div class="text-end pe-4" style="flex-grow: 1;"><div class="fw-bold text-info" style="font-size: 0.9rem; line-height: 1.2; margin-bottom: 3px;">${item.subjectCode} ${item.subjectName}</div><div class="badge bg-primary">‡∏´‡πâ‡∏≠‡∏á ${item.className}</div></div><div class="dropdown position-absolute" style="top: 12px; right: 10px;"><button class="btn btn-sm text-white opacity-75 shadow-none p-1" type="button" data-bs-toggle="dropdown"><i class="fas fa-ellipsis-v fa-lg"></i></button><ul class="dropdown-menu dropdown-menu-end shadow"><li><a class="dropdown-item" href="javascript:void(0)" onclick="openEditLessonHistory('${safeTs}')"><i class="fas fa-edit me-2 text-warning"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</a></li><li><hr class="dropdown-divider"></li><li><a class="dropdown-item text-danger" href="javascript:void(0)" onclick="deleteLessonHistory('${safeTs}')"><i class="fas fa-trash-alt me-2"></i> ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ</a></li></ul></div></div><div class="card-body bg-white"><h6 class="fw-bold text-primary mb-3 pb-2 border-bottom"><i class="fas fa-lightbulb me-2"></i>${item.topic}</h6><div class="mb-3"><div class="small fw-bold text-secondary mb-1">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ:</div><div class="small text-dark bg-light p-2 rounded border-start border-3 border-success" style="white-space: pre-wrap; font-size: 0.8rem;">${item.outcomes || '-'}</div></div><div class="row g-2 mb-3"><div class="col-6"><div class="small fw-bold text-danger mb-1"><i class="fas fa-exclamation-circle me-1"></i> ‡∏õ‡∏±‡∏ç‡∏´‡∏≤:</div><div class="small text-dark bg-light p-2 rounded border-start border-3 border-danger" style="white-space: pre-wrap; font-size: 0.8rem;">${item.problems || '-'}</div></div><div class="col-6"><div class="small fw-bold text-success mb-1"><i class="fas fa-check-circle me-1"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:</div><div class="small text-dark bg-light p-2 rounded border-start border-3 border-info" style="white-space: pre-wrap; font-size: 0.8rem;">${item.solutions || '-'}</div></div></div><div><div class="mb-2"><div class="small fw-bold text-secondary mb-1" style="font-size: 0.75rem;">‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î DPA:</div><div>${dpaBadges}</div></div><div class="mb-2"><div class="small fw-bold text-secondary mb-1" style="font-size: 0.75rem;">‡∏ó‡∏±‡∏Å‡∏©‡∏∞ 3R8C:</div><div>${skillBadges}</div></div>${attachments}</div></div></div></div>`;
  });
  container.innerHTML = html;
}

function deleteLessonHistory(encodedTs) {
  if(!confirm("‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏™‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ)")) return;
  const ts = decodeURIComponent(encodedTs); showLoader(true);
  google.script.run.withSuccessHandler(res => { showLoader(false); alert(res.message); if(res.status === 'success') { const user = getSessionUser(); sessionStorage.removeItem(`lesson_history_${user.id}_${user.currentTerm}_${user.currentYear}`); initLessonHistoryPage(); } }).deleteDetailedLessonRecord(ts);
}

function openEditLessonHistory(encodedTs) {
  const ts = decodeURIComponent(encodedTs); const item = allLessonHistories.find(i => String(i.timestamp) === ts); if(!item) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
  document.getElementById('edit_dl_ts').value = ts; document.getElementById('edit_dl_topic').value = item.topic; document.getElementById('edit_dl_outcomes').value = item.outcomes; document.getElementById('edit_dl_problems').value = item.problems; document.getElementById('edit_dl_solutions').value = item.solutions; document.getElementById('edit_dl_student_results').value = item.studentResults;
  document.querySelectorAll('.edit-dpa-check').forEach(cb => cb.checked = false); document.querySelectorAll('.edit-skill-check').forEach(cb => cb.checked = false);
  item.dpa.forEach(val => { const cb = document.querySelector(`.edit-dpa-check[value="${val}"]`); if(cb) cb.checked = true; });
  item.skills.forEach(val => { const cb = document.querySelector(`.edit-skill-check[value="${val}"]`); if(cb) cb.checked = true; });
  const modal = new bootstrap.Modal(document.getElementById('editLessonHistoryModal')); modal.show();
}

async function saveEditLessonHistory() {
  const ts = document.getElementById('edit_dl_ts').value;
  const dpaElements = document.querySelectorAll('.edit-dpa-check:checked'); const dpaValues = Array.from(dpaElements).map(el => el.value);
  const skillElements = document.querySelectorAll('.edit-skill-check:checked'); const skillValues = Array.from(skillElements).map(el => el.value);
  const workFile = document.getElementById('edit_dl_work_file').files[0]; const imageFile = document.getElementById('edit_dl_image_file').files[0];
  const btn = document.getElementById('btnSaveEditLesson'); const oldText = btn.innerHTML; btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
  try {
    const workFileBase64 = await getBase64(workFile); const imageFileBase64 = await getBase64(imageFile);
    const record = { topic: document.getElementById('edit_dl_topic').value, outcomes: document.getElementById('edit_dl_outcomes').value, problems: document.getElementById('edit_dl_problems').value, solutions: document.getElementById('edit_dl_solutions').value, dpa: dpaValues, skills: skillValues, studentResults: document.getElementById('edit_dl_student_results').value, workFileBase64: workFileBase64, imageFileBase64: imageFileBase64 };
    google.script.run.withSuccessHandler(res => { btn.disabled = false; btn.innerHTML = oldText; bootstrap.Modal.getInstance(document.getElementById('editLessonHistoryModal')).hide(); alert(res.message); if (res.status === 'success') { const user = getSessionUser(); sessionStorage.removeItem(`lesson_history_${user.id}_${user.currentTerm}_${user.currentYear}`); initLessonHistoryPage(); } }).updateDetailedLessonRecord(ts, record);
  } catch(e) { btn.disabled = false; btn.innerHTML = oldText; alert("Error: " + e.message); }
}

// ==========================================
// 14. THAI DATEPICKER SYSTEM
// ==========================================
function applyThaiDatePickers() {
  const dateInputs = document.querySelectorAll('input[type="date"]');
  dateInputs.forEach(input => {
    input.type = 'text'; input.classList.add('bg-white'); 
    flatpickr(input, {
      locale: "th", dateFormat: "Y-m-d", altInput: true, altFormat: "d M Y", 
      formatDate: (date, format, locale) => { if (format === "d M Y") { const d = date.getDate(); const m = flatpickr.l10ns.th.months.longhand[date.getMonth()]; const y = date.getFullYear() + 543; return `${d} ${m} ${y}`; } return flatpickr.formatDate(date, format, locale); },
      onReady: function(selectedDates, dateStr, instance) { if(instance.currentYearElement) instance.currentYearElement.value = instance.currentYear + 543; },
      onYearChange: function(selectedDates, dateStr, instance) { if(instance.currentYearElement) instance.currentYearElement.value = instance.currentYear + 543; },
      onMonthChange: function(selectedDates, dateStr, instance) { if(instance.currentYearElement) instance.currentYearElement.value = instance.currentYear + 543; },
      onChange: function(selectedDates, dateStr, instance) { input.value = dateStr; if (input.id === 'teachingDate') { if (typeof updateThaiDateDisplay === 'function') updateThaiDateDisplay(); if (typeof reloadTimetableByDate === 'function') reloadTimetableByDate(); } }
    });
  });
}

// ==========================================
// üåü ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û/‡πÑ‡∏ü‡∏•‡πå ‡πÅ‡∏ö‡∏ö Popup
// ==========================================
let galleryItems = []; let galleryCurrentIndex = 0;
function openGalleryModal(encodedFiles, startIndex) {
  galleryItems = JSON.parse(decodeURIComponent(encodedFiles)); galleryCurrentIndex = parseInt(startIndex);
  let modalEl = document.getElementById('galleryViewerModal');
  if (!modalEl) {
    const modalHtml = `<div class="modal fade" id="galleryViewerModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-xl modal-dialog-centered" style="max-width: 90vw;"><div class="modal-content bg-dark" style="height: 85vh; border-radius: 12px; overflow: hidden;"><div class="modal-header border-0 text-white p-3" style="background-color: rgba(0,0,0,0.6); position: absolute; width: 100%; z-index: 10;"><h6 class="modal-title fw-bold" id="galleryViewerTitle">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h6><button type="button" class="btn-close btn-close-white shadow-none" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body p-0 position-relative"><div class="position-absolute top-50 start-50 translate-middle text-white text-center" style="z-index: 1;"><div class="spinner-border text-light mb-2" role="status"></div><div class="small">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Drive...</div></div><iframe id="galleryViewerIframe" src="" width="100%" height="100%" style="border: none; position: relative; z-index: 2; background-color: white;"></iframe><button id="btnGalleryPrev" class="btn btn-dark position-absolute top-50 start-0 translate-middle-y ms-3 shadow-lg" style="z-index: 10; border-radius: 50%; width: 50px; height: 50px; opacity: 0.85;" onclick="navigateGallery(-1)"><i class="fas fa-chevron-left fa-lg"></i></button><button id="btnGalleryNext" class="btn btn-dark position-absolute top-50 end-0 translate-middle-y me-3 shadow-lg" style="z-index: 10; border-radius: 50%; width: 50px; height: 50px; opacity: 0.85;" onclick="navigateGallery(1)"><i class="fas fa-chevron-right fa-lg"></i></button></div></div></div></div>`;
    document.body.insertAdjacentHTML('beforeend', modalHtml); modalEl = document.getElementById('galleryViewerModal');
  }
  updateGalleryView(); const modal = new bootstrap.Modal(modalEl); modal.show();
}

function updateGalleryView() {
  const item = galleryItems[galleryCurrentIndex];
  document.getElementById('galleryViewerTitle').innerHTML = `<i class="fas fa-search-plus me-2 text-info"></i> ${item.title} <span class="badge bg-light text-dark ms-2" style="font-size:0.75rem;">${galleryCurrentIndex + 1} / ${galleryItems.length}</span>`;
  let embedUrl = item.url; if (embedUrl && embedUrl.includes('/view')) embedUrl = embedUrl.replace(/\/view.*/, '/preview');
  document.getElementById('galleryViewerIframe').src = embedUrl;
  const showNav = galleryItems.length > 1 ? 'block' : 'none'; document.getElementById('btnGalleryPrev').style.display = showNav; document.getElementById('btnGalleryNext').style.display = showNav;
}

function navigateGallery(direction) {
  galleryCurrentIndex += direction;
  if (galleryCurrentIndex < 0) galleryCurrentIndex = galleryItems.length - 1;
  if (galleryCurrentIndex >= galleryItems.length) galleryCurrentIndex = 0;
  updateGalleryView(); 
}

// ==========================================
// ü§ñ üìä ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô AI-Insights
// ==========================================
function analyzeProblems() {
  const body = document.getElementById('problemAnalysisBody');
  const recordsWithProblems = allLessonHistories.filter(item => { const p = item.problems ? item.problems.trim() : ""; return p !== "" && p !== "-"; });
  if (recordsWithProblems.length === 0) { body.innerHTML = `<div class="text-center p-5 text-muted"><i class="fas fa-smile-beam fa-4x mb-3 text-success"></i><h5 class="fw-bold text-success">‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö!</h5><p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏∏‡∏õ‡∏™‡∏£‡∏£‡∏Ñ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö</p></div>`; new bootstrap.Modal(document.getElementById('problemAnalysisModal')).show(); return; }
  body.innerHTML = `<div class="text-center p-5 animate__animated animate__fadeIn"><div class="spinner-grow text-danger mb-3" style="width: 3rem; height: 3rem;" role="status"></div><h5 class="fw-bold text-danger animate__animated animate__pulse animate__infinite">PSSMS AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</h5><p class="text-muted small">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏° ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏à‡∏±‡∏¢ (CAR)</p></div>`;
  const modal = new bootstrap.Modal(document.getElementById('problemAnalysisModal')); modal.show();
  setTimeout(() => { runSmartAIAnalysis(recordsWithProblems, body); }, 1500);
}

function runSmartAIAnalysis(records, body) {
  const categories = {
    "‡∏î‡πâ‡∏≤‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡πÉ‡∏à": { keywords: ["‡∏Ñ‡∏∏‡∏¢", "‡πÄ‡∏•‡πà‡∏ô", "‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå", "‡∏´‡∏•‡∏±‡∏ö", "‡πÑ‡∏°‡πà‡∏™‡∏ô‡πÉ‡∏à", "‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡∏±‡∏á", "‡∏ß‡∏≠‡∏Å‡πÅ‡∏ß‡∏Å", "‡∏™‡∏°‡∏≤‡∏ò‡∏¥", "‡πÄ‡∏ö‡∏∑‡πà‡∏≠", "‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à", "‡πÄ‡∏Å‡∏°", "‡∏Å‡∏ß‡∏ô", "‡πÅ‡∏Å‡∏•‡πâ‡∏á", "‡∏ó‡∏∞‡πÄ‡∏•‡∏≤‡∏∞", "‡πÄ‡∏´‡∏°‡πà‡∏≠", "‡∏´‡∏¢‡∏≠‡∏Å", "‡∏û‡∏π‡∏î‡πÅ‡∏ó‡∏£‡∏Å", "‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πà‡∏ß‡∏°‡∏°‡∏∑‡∏≠", "‡∏Ç‡∏≤‡∏î‡∏™‡∏°‡∏≤‡∏ò‡∏¥", "‡πÇ‡∏ã‡πÄ‡∏ä‡∏µ‡∏¢‡∏•", "‡πÅ‡∏ä‡∏ó", "‡πÅ‡∏ï‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤", "‡∏Å‡∏¥‡∏ô‡∏Ç‡∏ô‡∏°", "‡∏ã‡∏ô", "‡∏´‡∏≤‡∏ß", "‡∏ü‡∏∏‡∏ö", "‡∏ô‡∏¥‡∏ô‡∏ó‡∏≤", "‡∏ï‡∏µ‡∏Å‡∏±‡∏ô", "‡∏ß‡∏¥‡πà‡∏á‡πÄ‡∏•‡πà‡∏ô", "‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏û‡πà‡∏ô‡∏û‡πà‡∏≤‡∏ô", "‡πÑ‡∏°‡πà‡∏ü‡∏±‡∏á", "‡∏´‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏á", "‡∏Ñ‡∏∏‡∏¢‡∏Ç‡πâ‡∏≤‡∏°‡πÇ‡∏ï‡πä‡∏∞", "‡πÄ‡∏•‡πà‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠", "‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏•‡∏á", "‡πÄ‡∏Ñ‡∏≤‡∏∞‡πÇ‡∏ï‡πä‡∏∞", "‡πÇ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á", "‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°", "‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ï‡∏∑‡∏≠‡∏£‡∏∑‡∏≠‡∏£‡πâ‡∏ô", "‡πÄ‡∏â‡∏∑‡πà‡∏≠‡∏¢‡∏ä‡∏≤", "‡∏ô‡∏¥‡πà‡∏á‡πÄ‡∏â‡∏¢", "‡∏Å‡πâ‡∏≤‡∏ß‡∏£‡πâ‡∏≤‡∏ß", "‡∏´‡∏¢‡∏≤‡∏ö‡∏Ñ‡∏≤‡∏¢", "‡∏û‡∏π‡∏î‡∏Ñ‡∏≥‡∏´‡∏¢‡∏≤‡∏ö", "‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏≤‡∏£‡∏û", "‡∏ï‡πà‡∏≠‡∏ï‡πâ‡∏≤‡∏ô", "‡∏ä‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Ñ‡∏∏‡∏¢", "‡πÅ‡∏≠‡∏ö‡∏Å‡∏¥‡∏ô", "‡πÑ‡∏°‡πà‡∏à‡∏î", "‡∏ô‡∏±‡πà‡∏á‡πÄ‡∏´‡∏°‡πà‡∏≠", "‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ", "‡πÄ‡∏ã‡∏•‡∏ü‡∏µ‡πà", "‡∏ï‡∏∞‡πÇ‡∏Å‡∏ô", "‡∏£‡∏ö‡∏Å‡∏ß‡∏ô", "‡∏î‡∏∑‡πâ‡∏≠", "‡πÑ‡∏°‡πà‡∏ô‡∏¥‡πà‡∏á", "‡∏¢‡∏∏‡∏Å‡∏¢‡∏¥‡∏Å", "‡∏•‡∏∏‡∏Å‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà", "‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ‡πÄ‡∏•‡πà‡∏ô", "‡∏û‡∏±‡∏ö‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©", "‡∏ü‡∏±‡∏á‡πÄ‡∏û‡∏•‡∏á", "‡πÉ‡∏™‡πà‡∏´‡∏π‡∏ü‡∏±‡∏á", "‡∏™‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡∏à‡∏Å", "‡∏´‡∏ß‡∏µ‡∏ú‡∏°", "‡∏ó‡∏≤‡∏•‡∏¥‡∏õ", "‡∏Ñ‡∏∏‡∏¢‡πÅ‡∏ó‡∏£‡∏Å", "‡πÄ‡∏ñ‡∏µ‡∏¢‡∏á", "‡∏´‡∏±‡∏ß‡πÄ‡∏£‡∏≤‡∏∞", "‡πÇ‡∏´‡∏ß‡∏Å‡πÄ‡∏´‡∏ß‡∏Å", "‡∏á‡πà‡∏ß‡∏á", "‡∏≠‡∏¥‡∏î‡∏≠‡∏≠‡∏î", "‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏â‡∏±‡∏ö‡∏Å‡∏£‡∏∞‡πÄ‡∏â‡∏á", "‡∏ñ‡∏≠‡∏ô‡∏´‡∏≤‡∏¢‡πÉ‡∏à", "‡πÑ‡∏£‡πâ‡∏™‡∏°‡∏≤‡∏ò‡∏¥", "‡∏•‡∏≠‡∏¢‡πÑ‡∏õ‡∏•‡∏≠‡∏¢‡∏°‡∏≤", "‡πÑ‡∏°‡πà‡∏à‡∏î‡∏à‡πà‡∏≠", "‡∏´‡∏•‡∏∏‡∏Å‡∏´‡∏•‡∏¥‡∏Å", "‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏±‡∏ô", "‡∏´‡∏¢‡∏≠‡∏Å‡∏•‡πâ‡∏≠", "‡∏Å‡πà‡∏≠‡∏Å‡∏ß‡∏ô", "‡∏£‡∏±‡∏á‡πÅ‡∏Å", "‡∏ö‡∏π‡∏•‡∏•‡∏µ‡πà", "‡πÑ‡∏°‡πà‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°", "‡πÄ‡∏•‡πà‡∏ô‡∏´‡∏±‡∏ß", "‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡πÉ‡∏à"], count: 0, items: [] },
    "‡∏î‡πâ‡∏≤‡∏ô‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ": { keywords: ["‡∏ä‡πâ‡∏≤", "‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à", "‡∏•‡∏∑‡∏°", "‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô", "‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å", "‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô", "‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç", "‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì", "‡∏¢‡∏≤‡∏Å", "‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ô", "‡∏™‡∏±‡∏ö‡∏™‡∏ô", "‡∏™‡∏≠‡∏ö", "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô", "‡∏ï‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ô", "‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå", "‡∏™‡∏£‡∏∏‡∏õ", "‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì", "‡∏≠‡πà‡∏≠‡∏ô", "‡∏ó‡∏±‡∏Å‡∏©‡∏∞", "‡∏à‡∏±‡∏ö‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°", "‡∏ï‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°", "‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ", "‡∏ó‡∏î‡∏•‡∏≠‡∏á", "‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏Å‡∏ï‡πå", "‡∏ó‡∏≥‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ", "‡∏Ñ‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô", "‡∏≠‡πà‡∏≤‡∏ô‡∏™‡∏∞‡∏Å‡∏î", "‡∏™‡∏∞‡∏Å‡∏î‡∏Ñ‡∏≥", "‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡∏∞‡∏Å‡∏∏‡∏Å‡∏ï‡∏∞‡∏Å‡∏±‡∏Å", "‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ú‡∏¥‡∏î", "‡∏•‡∏≤‡∏¢‡∏°‡∏∑‡∏≠", "‡∏≠‡πà‡∏≤‡∏ô‡∏ä‡πâ‡∏≤", "‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ä‡πâ‡∏≤", "‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á", "‡∏ï‡∏µ‡πÇ‡∏à‡∏ó‡∏¢‡πå", "‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏Å", "‡∏Ñ‡∏¥‡∏î‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å", "‡∏à‡∏≥‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ", "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏∑‡∏°‡∏´‡∏•‡∏±‡∏á", "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥", "‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤", "‡∏™‡∏±‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå", "‡πÅ‡∏¢‡∏Å‡πÅ‡∏¢‡∏∞", "‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ", "‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ", "‡πÑ‡∏°‡πà‡∏Å‡∏•‡πâ‡∏≤‡∏ï‡∏≠‡∏ö", "‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î", "‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ú‡∏¥‡∏î", "‡∏°‡πÇ‡∏ô‡∏ó‡∏±‡∏®‡∏ô‡πå‡∏Ñ‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô", "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÄ‡∏î‡∏¥‡∏°", "‡∏•‡∏∑‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤", "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ", "‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô‡∏†‡∏≤‡∏û", "‡∏ô‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å", "‡∏Ç‡∏≤‡∏î‡∏ó‡∏±‡∏Å‡∏©‡∏∞", "‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ", "‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô", "‡∏ó‡∏≥‡∏ú‡∏¥‡∏î‡∏™‡πÄ‡∏ï‡πá‡∏õ", "‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤", "‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô", "‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á", "‡∏á‡∏á", "‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô", "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏•‡∏∂‡∏Å", "‡πÑ‡∏°‡πà‡∏ö‡∏£‡∏£‡∏•‡∏∏", "‡∏ï‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô", "‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå", "‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡∏¥‡∏°", "‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏°", "‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ï‡∏Å", "‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏¥‡∏î", "‡∏ö‡∏ß‡∏Å‡πÄ‡∏•‡∏Ç‡∏ú‡∏¥‡∏î", "‡∏™‡∏π‡∏ï‡∏£‡∏Ñ‡∏ì‡∏¥‡∏ï", "‡∏ó‡πà‡∏≠‡∏á‡∏à‡∏≥", "‡∏û‡∏£‡∏µ‡πÄ‡∏ã‡∏ô‡∏ï‡πå", "‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠", "‡∏Ç‡∏≤‡∏î‡πÑ‡∏´‡∏ß‡∏û‡∏£‡∏¥‡∏ö", "‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤", "‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡πà‡∏≠‡∏ô", "‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ä‡πâ‡∏≤", "‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ"], count: 0, items: [] },
    "‡∏î‡πâ‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ô‡∏±‡∏¢": { keywords: ["‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô", "‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô", "‡∏™‡∏≤‡∏¢", "‡∏Ç‡∏≤‡∏î", "‡∏´‡∏ô‡∏µ", "‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå", "‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠", "‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤", "‡∏•‡∏∑‡∏°‡∏ô‡∏≥", "‡∏†‡∏≤‡∏£‡∏∞‡∏á‡∏≤‡∏ô", "‡∏ß‡∏¥‡∏ô‡∏±‡∏¢", "‡∏ï‡∏£‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏ß‡∏•‡∏≤", "‡∏•‡∏≠‡∏Å", "‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï", "‡∏Ç‡πâ‡∏≠‡∏ï‡∏Å‡∏•‡∏á", "‡∏Å‡∏é", "‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö", "‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢", "‡∏•‡∏∞‡∏ó‡∏¥‡πâ‡∏á", "‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏≤‡∏¢", "‡∏ú‡∏•‡∏±‡∏î‡∏ß‡∏±‡∏ô", "‡∏Ñ‡πâ‡∏≤‡∏á", "‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á", "‡∏î‡∏¥‡∏ô‡∏™‡∏≠", "‡∏õ‡∏≤‡∏Å‡∏Å‡∏≤", "‡∏™‡∏°‡∏∏‡∏î", "‡∏´‡∏≤‡∏¢", "‡∏ó‡∏¥‡πâ‡∏á", "‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö", "‡πÇ‡∏î‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "‡∏°‡∏≤‡∏™‡∏≤‡∏¢", "‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ä‡πâ‡∏≤", "‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô", "‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏≤‡∏™", "‡∏•‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô", "‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡πÅ‡∏ó‡∏ô", "‡∏Å‡πä‡∏≠‡∏õ‡∏õ‡∏µ‡πâ", "‡∏ß‡∏≤‡∏á‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏ß‡πâ", "‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á", "‡πÑ‡∏°‡πà‡∏ó‡∏≥‡πÄ‡∏ß‡∏£", "‡∏™‡∏Å‡∏õ‡∏£‡∏Å", "‡∏ó‡∏¥‡πâ‡∏á‡∏Ç‡∏¢‡∏∞", "‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "‡∏´‡∏ô‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "‡πÅ‡∏≠‡∏ö‡∏´‡∏ô‡∏µ", "‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á", "‡∏≠‡πâ‡∏≤‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•", "‡πÅ‡∏Å‡πâ‡∏ï‡∏±‡∏ß", "‡πÄ‡∏•‡∏ó", "‡πÑ‡∏°‡πà‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß", "‡∏™‡∏°‡∏∏‡∏î‡∏´‡∏°‡∏î", "‡∏•‡∏∑‡∏°‡πÄ‡∏≠‡∏≤‡∏°‡∏≤", "‡∏•‡∏∑‡∏°‡∏ó‡∏≥", "‡∏Ñ‡πâ‡∏≤‡∏á‡∏™‡πà‡∏á", "‡∏ú‡∏•‡∏±‡∏î‡∏ß‡∏±‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏û‡∏£‡∏∏‡πà‡∏á", "‡∏´‡∏°‡∏±‡∏Å‡∏´‡∏°‡∏°", "‡∏î‡∏≠‡∏á‡∏á‡∏≤‡∏ô", "‡πÑ‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô", "‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô", "‡∏Ç‡∏≤‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö", "‡πÑ‡∏°‡πà‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏™‡∏±‡∏ç‡∏ç‡∏≤", "‡∏ú‡∏¥‡∏î‡∏ô‡∏±‡∏î", "‡∏•‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô", "‡πÅ‡∏≠‡∏ö‡∏î‡∏π", "‡∏•‡∏∑‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠", "‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡∏ß‡∏ú‡∏¥‡∏î‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö", "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏´‡∏•‡∏∏‡∏î", "‡∏ú‡∏°‡∏¢‡∏≤‡∏ß", "‡πÑ‡∏°‡πà‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Å‡∏é", "‡∏ù‡πà‡∏≤‡∏ù‡∏∑‡∏ô", "‡∏Ç‡∏±‡∏î‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á"], count: 0, items: [] },
    "‡∏î‡πâ‡∏≤‡∏ô‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°‡πÅ‡∏•‡∏∞‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£": { keywords: ["‡πÄ‡∏ô‡πá‡∏ï", "‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï", "‡∏Ñ‡∏≠‡∏°", "‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡πÄ‡∏ï‡∏≠‡∏£‡πå", "‡∏£‡πâ‡∏≠‡∏ô", "‡πÑ‡∏ü‡∏î‡∏±‡∏ö", "‡∏ù‡∏ô‡∏ï‡∏Å", "‡∏û‡∏±‡∏á", "‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏£‡∏ö‡∏Å‡∏ß‡∏ô", "‡πÅ‡∏≠‡∏≠‡∏±‡∏î", "‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì", "‡∏à‡∏≠", "‡∏Ñ‡∏±‡∏ö‡πÅ‡∏Ñ‡∏ö", "‡∏≠‡∏≤‡∏Å‡∏≤‡∏®", "‡∏°‡∏∑‡∏î", "‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°", "‡∏ä‡∏≥‡∏£‡∏∏‡∏î", "‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà", "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠", "‡πÑ‡∏°‡∏Ñ‡πå", "‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô", "‡∏•‡∏≥‡πÇ‡∏û‡∏á", "‡∏™‡∏∞‡∏î‡∏∏‡∏î", "‡∏´‡∏•‡∏∏‡∏î", "‡∏Ñ‡πâ‡∏≤‡∏á", "‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡∏Å", "‡πÅ‡∏≠‡∏£‡πå‡πÄ‡∏™‡∏µ‡∏¢", "‡∏û‡∏±‡∏î‡∏•‡∏°", "‡∏≠‡∏ö‡∏≠‡πâ‡∏≤‡∏ß", "‡∏´‡∏ô‡∏≤‡∏ß", "‡πÅ‡∏™‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á", "‡∏°‡∏∑‡∏î‡πÑ‡∏õ", "‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å", "‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á", "‡∏ï‡∏±‡∏î‡∏´‡∏ç‡πâ‡∏≤", "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "‡∏Ç‡∏±‡∏î‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞", "‡πÅ‡∏Ç‡∏Å‡∏°‡∏≤‡πÄ‡∏¢‡∏∑‡∏≠‡∏ô", "‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®", "‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏•‡πá‡∏ï", "‡πÇ‡∏ó‡∏£‡∏ó‡∏±‡∏®‡∏ô‡πå", "‡∏™‡∏≤‡∏¢ HDMI", "‡∏õ‡∏•‡∏±‡πä‡∏Å‡πÑ‡∏ü", "‡πÇ‡∏ï‡πä‡∏∞‡∏û‡∏±‡∏á", "‡πÄ‡∏Å‡πâ‡∏≤‡∏≠‡∏µ‡πâ‡πÄ‡∏™‡∏µ‡∏¢", "‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏∞‡∏≠‡∏≤‡∏î", "‡∏ù‡∏∏‡πà‡∏ô", "‡πÄ‡∏´‡∏°‡πá‡∏ô", "‡∏Å‡∏•‡∏¥‡πà‡∏ô", "‡∏≠‡∏¥‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï", "‡∏´‡∏•‡∏∏‡∏î‡∏ö‡πà‡∏≠‡∏¢", "‡πÑ‡∏ß‡πÑ‡∏ü", "wifi", "‡∏ä‡πâ‡∏≤‡∏°‡∏≤‡∏Å", "‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô", "‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏û‡∏≠", "‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠", "‡πÅ‡∏ö‡πà‡∏á‡∏Å‡∏±‡∏ô", "‡πÅ‡∏¢‡πà‡∏á‡∏Å‡∏±‡∏ô", "‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£", "‡∏ù‡∏ô‡∏ï‡∏Å‡∏´‡∏ô‡∏±‡∏Å", "‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°", "‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏ó‡∏£‡∏Å", "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ä‡∏ô", "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏£‡∏¥‡πâ‡∏ô", "‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏´‡∏°‡∏î", "‡∏´‡∏°‡∏∂‡∏Å‡∏´‡∏°‡∏î", "‡πÅ‡∏ö‡∏ï‡∏´‡∏°‡∏î"], count: 0, items: [] },
    "‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ": { keywords: [], count: 0, items: [] }
  };

  records.forEach(item => {
     let matched = false; const text = (item.problems + " " + item.outcomes).toLowerCase();
     for (const cat in categories) {
        if(cat === "‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ") continue;
        if (categories[cat].keywords.some(kw => text.includes(kw))) { categories[cat].count++; categories[cat].items.push(item); matched = true; break; }
     }
     if(!matched) { categories["‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ"].count++; categories["‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ"].items.push(item); }
  });

  let topCat = "‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ"; let maxCount = -1;
  for (const cat in categories) { if (categories[cat].count > maxCount && cat !== "‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ") { maxCount = categories[cat].count; topCat = cat; } }

  let aiInsight = "";
  if (topCat === "‡∏î‡πâ‡∏≤‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡πÉ‡∏à") { aiInsight = "üìå <b>AI ‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤ (CAR):</b> ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏£‡πà‡∏ß‡∏° ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á <span class='text-primary fw-bold'>'‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏£‡πà‡∏ß‡∏°‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£ Gamification (‡πÄ‡∏Å‡∏°‡∏°‡∏¥‡∏ü‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô) ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°‡πÅ‡∏£‡∏á‡∏ó‡∏≤‡∏á‡∏ö‡∏ß‡∏Å'</span> ‡∏´‡∏£‡∏∑‡∏≠ <span class='text-primary fw-bold'>'‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ Active Learning ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏°‡πà‡∏û‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'</span>"; } 
  else if (topCat === "‡∏î‡πâ‡∏≤‡∏ô‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ") { aiInsight = "üìå <b>AI ‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤ (CAR):</b> ‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á <span class='text-primary fw-bold'>'‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ú‡∏•‡∏™‡∏±‡∏°‡∏§‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ä‡πâ‡∏≤ ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô (Peer-Assisted Learning) ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡∏™‡∏∑‡πà‡∏≠‡∏°‡∏±‡∏•‡∏ï‡∏¥‡∏°‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡πÄ‡∏ä‡∏¥‡∏á‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö'</span> ‡∏´‡∏£‡∏∑‡∏≠ <span class='text-primary fw-bold'>'‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏î‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡πÅ‡∏ö‡∏ö‡∏ù‡∏∂‡∏Å‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•'</span>"; } 
  else if (topCat === "‡∏î‡πâ‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ô‡∏±‡∏¢") { aiInsight = "üìå <b>AI ‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤ (CAR):</b> ‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏ß‡∏¥‡∏ô‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡πà‡∏ô‡∏ä‡∏±‡∏î ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á <span class='text-primary fw-bold'>'‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ô‡∏±‡∏¢‡πÉ‡∏ô‡∏ï‡∏ô‡πÄ‡∏≠‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à‡πÅ‡∏ö‡∏ö‡πÇ‡∏ó‡πÄ‡∏Ñ‡∏ô (Token Economy) ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô'</span>"; } 
  else if (topCat === "‡∏î‡πâ‡∏≤‡∏ô‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°‡πÅ‡∏•‡∏∞‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£") { aiInsight = "üìå <b>AI ‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤:</b> ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏° ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ <span class='text-primary fw-bold'>'‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡πÅ‡∏ö‡∏ö‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô (Flexible Lesson Plan) ‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡∏ö Unplugged (‡πÑ‡∏°‡πà‡∏û‡∏∂‡πà‡∏á‡∏û‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤/‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï) ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏™‡∏°‡∏≠'</span> ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏ù‡πà‡∏≤‡∏¢‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á"; } 
  else { aiInsight = "üìå <b>AI ‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤:</b> ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏•‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ï‡∏±‡∏ß ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ <span class='text-primary fw-bold'>'‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (Individual Analysis)'</span> ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢ (Differentiated Instruction) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ñ‡∏£‡∏±‡∏ö"; }

  let html = `<div class="card border-0 shadow-sm mb-4 rounded-3" style="background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);"><div class="card-body"><div class="d-flex align-items-center mb-3 pb-2 border-bottom"><div class="bg-danger text-white rounded-circle d-flex justify-content-center align-items-center me-3 shadow" style="width: 45px; height: 45px;"><i class="fas fa-brain fa-lg"></i></div><div><h6 class="fw-bold mb-0 text-danger">PSSMS AI-Insights</h6><div class="small text-muted">‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <b>${records.length}</b> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div></div></div><div class="d-flex flex-wrap gap-2 mb-3">`;
  for (const cat in categories) { if (categories[cat].count > 0) { let badgeColor = cat === topCat ? "bg-danger" : "bg-secondary"; let isTopAlert = cat === topCat ? '<i class="fas fa-exclamation-circle ms-1 animate__animated animate__flash animate__infinite"></i>' : ''; html += `<span class="badge ${badgeColor} p-2 shadow-sm" style="font-size: 0.85rem; border-radius: 8px;">${cat} : ‡∏û‡∏ö ${categories[cat].count} ‡∏Ñ‡∏≤‡∏ö ${isTopAlert}</span>`; } }
  html += `</div><div class="alert alert-primary mb-0 shadow-sm border-start border-4 border-primary"><div class="d-flex"><i class="fas fa-lightbulb fa-2x text-warning me-3"></i><div style="font-size: 0.9rem; line-height: 1.5;">${aiInsight}</div></div></div></div></div><h6 class="fw-bold text-dark mb-3"><i class="fas fa-list-ul me-2"></i>‡πÄ‡∏à‡∏≤‡∏∞‡∏•‡∏∂‡∏Å‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h6>`;

  for (const cat in categories) {
     if (categories[cat].items.length > 0) {
        let catIcon = "fa-folder"; if(cat.includes("‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°")) catIcon = "fa-user-ninja"; else if(cat.includes("‡∏ó‡∏±‡∏Å‡∏©‡∏∞")) catIcon = "fa-chart-line"; else if(cat.includes("‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö")) catIcon = "fa-clipboard-check"; else if(cat.includes("‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°")) catIcon = "fa-wifi";
        html += `<div class="mb-4"><span class="badge bg-dark fs-6 mb-2 shadow-sm"><i class="fas ${catIcon} me-2"></i>${cat}</span><div class="list-group shadow-sm border-0" style="border-radius: 10px; overflow: hidden;">`;
        categories[cat].items.forEach(item => {
          html += `<div class="list-group-item border-start border-4 border-danger border-top-0 border-end-0 border-bottom"><div class="d-flex justify-content-between small mb-2 bg-light p-1 rounded"><span class="fw-bold text-primary"><i class="fas fa-book me-1"></i>${item.subjectCode} (‡∏´‡πâ‡∏≠‡∏á ${item.className})</span><span class="text-secondary"><i class="fas fa-calendar-alt me-1"></i>${formatThaiDate(item.date)}</span></div><div style="font-size: 0.85rem; line-height: 1.5;"><span class="badge bg-danger-subtle text-danger border border-danger mb-1">‡∏õ‡∏±‡∏ç‡∏´‡∏≤</span> <span class="text-dark fw-bold">${item.problems}</span><br><span class="badge bg-success-subtle text-success border border-success mt-1">‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</span> <span class="text-dark">${item.solutions || '-'}</span></div></div>`;
        });
        html += `</div></div>`;
     }
  }
  body.innerHTML = html;
}

// ==========================================
// 15. POR POR 5: SUBJECT CONFIG LOGIC
// ==========================================
function initSubjectConfigPage() {
  const user = getSessionUser();
  if(!user) return;
  document.getElementById('configTerm').value = user.currentTerm;
  document.getElementById('configYear').value = user.currentYear;
  const select = document.getElementById('configClassSelect'); select.innerHTML = `<option value="">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏¥‡∏ä‡∏≤...</option>`;
  const subjectCacheKey = `v2_subjects_${user.id}_${user.currentTerm}_${user.currentYear}`;
  const cachedSubjects = sessionStorage.getItem(subjectCacheKey);

  if (cachedSubjects && cachedSubjects !== "[]") { buildConfigSubjectDropdown(JSON.parse(cachedSubjects)); } 
  else {
     google.script.run.withFailureHandler(err => { select.innerHTML = `<option value="">‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</option>`; alert("Error: " + err.message); })
       .withSuccessHandler(subjects => { sessionStorage.setItem(subjectCacheKey, JSON.stringify(subjects)); buildConfigSubjectDropdown(subjects); })
       .getTeacherSubjects(user.id, user.role, user.currentTerm, user.currentYear);
  }
}

function buildConfigSubjectDropdown(subjects) {
  const select = document.getElementById('configClassSelect');
  if(subjects.length === 0) { select.innerHTML = `<option value="">‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏ô‡πÄ‡∏ó‡∏≠‡∏°‡∏ô‡∏µ‡πâ</option>`; return; }
  let html = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ --</option>';
  subjects.forEach(sub => { html += `<option value='${JSON.stringify(sub)}'>${sub[0]} - ${sub[1]} (${sub[2]})</option>`; });
  select.innerHTML = html;
}

function loadSubjectConfig() {
  const val = document.getElementById('configClassSelect').value;
  const panel = document.getElementById('configPanel');
  const info = document.getElementById('configSubjectInfo');
  if(!val) { panel.style.pointerEvents = 'none'; panel.classList.add('opacity-50'); info.classList.add('d-none'); return; }

  const item = JSON.parse(val); const user = getSessionUser();
  document.getElementById('dispConfigSubject').innerText = `${item[0]} ${item[1]}`;
  document.getElementById('dispConfigClass').innerText = `‡∏´‡πâ‡∏≠‡∏á ${item[2]}`;
  info.classList.remove('d-none'); panel.style.pointerEvents = 'auto'; panel.classList.remove('opacity-50');
  showLoader(true);
  
  google.script.run.withSuccessHandler(config => {
       showLoader(false); const tbody = document.getElementById('indicatorTableBody'); tbody.innerHTML = '';
       if (config) {
          const ratios = config.ratio.split(':');
          document.getElementById('scoreFormative').value = ratios[0] || 0; document.getElementById('scoreMidterm').value = ratios[1] || 0; document.getElementById('scoreFinal').value = ratios[2] || 0;
          if(config.indicators && config.indicators.length > 0) { config.indicators.forEach(ind => addIndicatorRow(ind.name, ind.score)); } else { addIndicatorRow(); }
       } else {
          document.getElementById('scoreFormative').value = 70; document.getElementById('scoreMidterm').value = 10; document.getElementById('scoreFinal').value = 20; addIndicatorRow();
       }
       calculateTotalConfigScore();
    }).getSubjectConfig(item[0], item[2], user.currentTerm, user.currentYear);
}

function calculateTotalConfigScore() {
  const f = parseInt(document.getElementById('scoreFormative').value) || 0;
  const m = parseInt(document.getElementById('scoreMidterm').value) || 0;
  const e = parseInt(document.getElementById('scoreFinal').value) || 0;
  const total = f + m + e;
  const badge = document.getElementById('totalScoreBadge');
  badge.innerText = total;
  if(total === 100) { badge.className = 'text-success fs-5 fw-bold'; } else { badge.className = 'text-danger fs-5 fw-bold'; }
}

function saveSubjectConfigData() {
  const val = document.getElementById('configClassSelect').value;
  if(!val) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤");
  const total = parseInt(document.getElementById('totalScoreBadge').innerText);
  if(total !== 100) { if(!confirm("‚ö†Ô∏è ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö 100 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return; }

  const item = JSON.parse(val); const user = getSessionUser();
  const indicators = []; const rows = document.querySelectorAll('#indicatorTableBody tr');
  rows.forEach(row => {
    const name = row.querySelector('.ind-name').value.trim(); const score = parseInt(row.querySelector('.ind-score').value) || 0;
    if(name && score > 0) { indicators.push({ name: name, score: score }); }
  });

  const configData = { subjectCode: item[0], className: item[2], term: user.currentTerm, year: user.currentYear, formative: parseInt(document.getElementById('scoreFormative').value) || 0, midterm: parseInt(document.getElementById('scoreMidterm').value) || 0, final: parseInt(document.getElementById('scoreFinal').value) || 0, indicators: indicators, teacherId: user.id };
  const btn = document.getElementById('btnSaveConfig');
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...'; btn.disabled = true;

  google.script.run.withSuccessHandler(res => { btn.innerHTML = '<i class="fas fa-save me-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏¥‡∏ä‡∏≤'; btn.disabled = false; alert(res.message); }).saveSubjectConfig(configData);
}

// ==========================================
// 16. POR POR 5: ALL-IN-ONE (‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)
// ==========================================

let currentScoreConfig = null;
let currentScoreStudents = [];
let currentAttStats = {};
let isHeaderEditMode = false;
let isQualVisible = false;
let isSavingScores = false; 

// üåü ‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô (‡πÄ‡∏Å‡∏£‡∏≤‡∏∞‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏î‡πá‡∏Å)
const normID = (id) => { let clean = String(id).replace(/[^a-zA-Z0-9]/g, '').replace(/^0+/, ''); return clean || '0'; };
const normStr = (str) => String(str).replace(/\s+/g, '').toLowerCase();

function initScoreEntryPage() {
  const user = getSessionUser();
  if(!user) return;
  const select = document.getElementById('scoreClassSelect');
  select.innerHTML = `<option value="">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏¥‡∏ä‡∏≤...</option>`;
  
  const subjectCacheKey = `v2_subjects_${user.id}_${user.currentTerm}_${user.currentYear}`;
  const cachedSubjects = sessionStorage.getItem(subjectCacheKey);

  if (cachedSubjects && cachedSubjects !== "[]") {
     buildScoreSubjectDropdown(JSON.parse(cachedSubjects));
  } else {
     google.script.run.withSuccessHandler(subjects => {
          sessionStorage.setItem(subjectCacheKey, JSON.stringify(subjects));
          buildScoreSubjectDropdown(subjects);
     }).getTeacherSubjects(user.id, user.role, user.currentTerm, user.currentYear);
  }
}

function buildScoreSubjectDropdown(subjects) {
  const select = document.getElementById('scoreClassSelect');
  if(subjects.length === 0) { select.innerHTML = `<option value="">‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏ô‡πÄ‡∏ó‡∏≠‡∏°‡∏ô‡∏µ‡πâ</option>`; return; }
  let html = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å --</option>';
  subjects.forEach(sub => { html += `<option value='${JSON.stringify(sub)}'>${sub[0]} - ${sub[1]} (${sub[2]})</option>`; });
  select.innerHTML = html;
}

function toggleHeaderEditMode() {
  const btnEdit = document.getElementById('btnEditHeader');
  if (!isHeaderEditMode) {
    isHeaderEditMode = true;
    btnEdit.className = "btn btn-danger shadow-sm px-3 fw-bold me-2";
    btnEdit.innerHTML = '<i class="fas fa-check me-2"></i>‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á';
    refreshTableOnly();
  } else {
    if(confirm("üí° ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
       saveAllInOneScores(); 
    } else {
       isHeaderEditMode = false;
       btnEdit.className = "btn btn-outline-primary shadow-sm px-3 fw-bold me-2";
       btnEdit.innerHTML = '<i class="fas fa-th me-2"></i>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á';
       refreshTableOnly();
    }
  }
}

function toggleQualColumns() {
  isQualVisible = !isQualVisible;
  const btn = document.getElementById('btnToggleQual');
  if (isQualVisible) {
    btn.className = "btn btn-info shadow-sm px-3 fw-bold me-2 text-white";
    btn.innerHTML = '<i class="fas fa-eye-slash me-2"></i>‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞';
  } else {
    btn.className = "btn btn-outline-info shadow-sm px-3 fw-bold me-2";
    btn.innerHTML = '<i class="fas fa-eye me-2"></i>‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞';
  }
  syncHeaderState(); 
  refreshTableOnly(); 
}

function loadScoreGrid() {
  const val = document.getElementById('scoreClassSelect').value;
  const gridCard = document.getElementById('scoreGridCard');
  const btnSave = document.getElementById('btnSaveScores');
  
  if(!val) {
    gridCard.classList.add('d-none');
    btnSave.disabled = true;
    return;
  }

  const item = JSON.parse(val);
  const user = getSessionUser();
  
  showLoader(true);
  google.script.run.withSuccessHandler(res => {
      showLoader(false);
      gridCard.classList.remove('d-none');
      btnSave.disabled = false;
      currentScoreConfig = res.config;
      currentScoreStudents = res.students;
      currentAttStats = res.attStats || {}; 
      renderAllInOneTable(res.students, res.config, res.existingScores, res.existingQuals);
  }).getAllInOneScoreGridData(item[0], item[2], user.currentTerm, user.currentYear);
}

function syncHeaderState() {
  if(!document.querySelector('.ind-name-edit')) return; 
  const newIndicators = [];
  const names = document.querySelectorAll('.ind-name-edit');
  const scores = document.querySelectorAll('.ind-score-edit');
  names.forEach((el, i) => {
    newIndicators.push({ name: el.innerText.trim(), score: parseFloat(scores[i].innerText) || 0 });
  });
  currentScoreConfig.indicators = newIndicators;
  
  const f = parseFloat(document.getElementById('edit-ratio-f').innerText) || 0;
  const m = parseFloat(document.getElementById('edit-ratio-m').innerText) || 0;
  const e = parseFloat(document.getElementById('edit-ratio-e').innerText) || 0;
  currentScoreConfig.ratio = `${f}:${m}:${e}`;
}

function refreshTableOnly() {
  const tempScores = {};
  const tempQuals = {};
  
  if (currentScoreStudents && currentScoreStudents.length > 0) {
      currentScoreStudents.forEach(std => {
        const stdId = String(std[0]).trim();
        const safeStdId = normID(stdId); 
        
        const indNames = Array.from(document.querySelectorAll('.ind-name-edit')).map(el => el.innerText.trim());
        document.querySelectorAll(`.formative-std-${safeStdId}`).forEach((input, i) => {
          if(input.value !== '' && indNames[i]) {
             const safeIndName = normStr(`ind_${indNames[i]}`); 
             tempScores[`${safeStdId}_${safeIndName}`] = parseFloat(input.value);
          }
        });
        
        const m = document.querySelector(`.midterm-std-${safeStdId}`);
        if(m && m.value !== '') tempScores[`${safeStdId}_midterm`] = parseFloat(m.value);
        
        const mr = document.querySelector(`.midterm-re-std-${safeStdId}`);
        if(mr && mr.value !== '') tempScores[`${safeStdId}_midterm_re`] = parseFloat(mr.value);
        
        const f = document.querySelector(`.final-std-${safeStdId}`);
        if(f && f.value !== '') tempScores[`${safeStdId}_final`] = parseFloat(f.value);

        const rem = document.querySelector(`.remark-select[data-safeid="${safeStdId}"]`);
        if(rem && rem.value !== '') tempScores[`${safeStdId}_remark`] = rem.value;

        const qr = document.querySelector(`.qual-read[data-safeid="${safeStdId}"]`);
        const qc = document.querySelector(`.qual-char[data-safeid="${safeStdId}"]`);
        const qp = document.querySelector(`.qual-comp[data-safeid="${safeStdId}"]`);
        if(qr && qc && qp) tempQuals[safeStdId] = { read: qr.value, char: qc.value, comp: qp.value };
      });
  }
  renderAllInOneTable(currentScoreStudents, currentScoreConfig, tempScores, tempQuals); 
}

// üåü 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏â‡∏ö‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö & ‡∏ô‡∏≥ % ‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡∏£‡∏´‡∏±‡∏™)
function renderAllInOneTable(students, config, existingScores, existingQuals) {
  const thead = document.getElementById('scoreTableHeader');
  const tbody = document.getElementById('scoreTableBody');
  const val = document.getElementById('scoreClassSelect').value;
  const item = JSON.parse(val);
  
  document.getElementById('scoreGridTitle').innerHTML = `‡∏õ‡∏û.5: ‡∏ß‡∏¥‡∏ä‡∏≤ ${item[0]} ${item[1]} ‡∏´‡πâ‡∏≠‡∏á ${item[2]}`;
  document.getElementById('scoreRatioBadge').innerText = `‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ${config.ratio}`;

  // üåü ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÅ‡∏•‡∏∞‡∏•‡∏î Padding ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏£‡∏Å‡πÜ
  let headHtml = `<tr><th rowspan="2" class="align-middle text-center sticky-head-1 text-muted px-1" style="width:40px;">‡∏ó‡∏µ‡πà</th><th rowspan="2" class="align-middle text-start sticky-head-2 text-muted px-2" style="min-width: 170px;">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>`;
  let subHeadHtml = `<tr>`;
  
  config.indicators.forEach((ind, idx) => {
    let deleteBtn = isHeaderEditMode ? `<div class="mt-1"><button class="btn btn-xs btn-outline-danger p-0 px-1 border-0" onclick="removeIndicator(${idx})"><i class="fas fa-times"></i></button></div>` : '';
    headHtml += `<th class="text-success border-bottom-0"><div contenteditable="${isHeaderEditMode}" class="ind-name-edit" data-idx="${idx}">${ind.name}</div>${deleteBtn}</th>`;
    subHeadHtml += `<th class="text-success small fw-normal">(<span contenteditable="${isHeaderEditMode}" class="ind-score-edit" onblur="reCalcAllRows()">${ind.score}</span>)</th>`;
  });
  
  if(isHeaderEditMode) headHtml += `<th rowspan="2" class="align-middle bg-light"><button class="btn btn-sm btn-light text-primary border shadow-sm px-2 py-0" onclick="addIndicator()"><i class="fas fa-plus"></i></button></th>`;

  const ratios = config.ratio.split(':');
  
  headHtml += `<th class="text-primary border-bottom-0 border-start col-highlight-f">‡∏£‡∏ß‡∏°‡πÄ‡∏Å‡πá‡∏ö</th><th class="text-warning text-dark border-bottom-0 col-highlight-m">‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ</th><th class="text-danger border-bottom-0 border-start border-white col-highlight-mr" style="opacity: 0.8;">‡∏ã‡πà‡∏≠‡∏°</th><th class="text-danger border-bottom-0 border-start col-highlight-e">‡∏õ‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏Ñ</th><th class="text-dark border-bottom-0 border-start col-highlight-total">‡∏£‡∏ß‡∏°</th><th class="text-success border-bottom-0 border-start col-highlight-grade">‡πÄ‡∏Å‡∏£‡∏î</th><th class="text-danger border-bottom-0 border-start col-highlight-mr">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th><th colspan="3" class="text-info text-dark border-start ${isQualVisible ? '' : 'd-none'}">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô (0-3)</th></tr>`;
  
  subHeadHtml += `<th class="text-primary small fw-normal border-start col-highlight-f">(<span id="edit-ratio-f">${ratios[0] || 0}</span>)</th><th class="text-warning text-dark small fw-normal col-highlight-m">(<span id="edit-ratio-m" contenteditable="${isHeaderEditMode}" onblur="reCalcAllRows()">${ratios[1] || 0}</span>)</th><th class="text-danger small fw-normal border-start border-white col-highlight-mr" style="opacity: 0.8;">-</th><th class="text-danger small fw-normal border-start col-highlight-e">(<span id="edit-ratio-e" contenteditable="${isHeaderEditMode}" onblur="reCalcAllRows()">${ratios[2] || 0}</span>)</th><th class="text-dark small fw-normal border-start col-highlight-total">(<span id="edit-ratio-total">100</span>)</th><th class="text-success small fw-normal border-start col-highlight-grade">0-4</th><th class="text-danger small fw-normal border-start col-highlight-mr">(‡∏£, ‡∏°‡∏™)</th><th class="text-info small fw-normal border-start ${isQualVisible ? '' : 'd-none'}">‡∏≠‡πà‡∏≤‡∏ô</th><th class="text-info small fw-normal ${isQualVisible ? '' : 'd-none'}">‡∏Ñ‡∏∏‡∏ì‡∏Ø</th><th class="text-info small fw-normal ${isQualVisible ? '' : 'd-none'}">‡∏™‡∏°‡∏£‡∏£‡∏ñ‡∏ô‡∏∞</th></tr>`;
  
  thead.innerHTML = headHtml + subHeadHtml;

  let bodyHtml = '';
  students.sort((a, b) => String(a[0]).localeCompare(String(b[0])));

  students.forEach((std, rowIndex) => {
    const stdId = String(std[0]).trim();
    const safeStdId = normID(stdId); 
    let colIndex = 0; 
    
    let pct = currentAttStats[safeStdId];
    let attText = '';
    let autoMS = false;
    let remarkVal = (existingScores[`${safeStdId}_remark`] !== undefined) ? existingScores[`${safeStdId}_remark`] : '';
    
    if (pct !== undefined) {
        // üåü ‡∏¢‡πâ‡∏≤‡∏¢ % ‡∏°‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™ ‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏õ‡πâ‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
        attText = `<span class="ms-2 fw-bold ${pct < 80 ? 'text-danger' : 'text-success'}" style="font-size: 0.72rem; letter-spacing:-0.3px;"><i class="fas fa-user-clock me-1"></i>${pct}%</span>`;
        if (pct < 80 && remarkVal === '') {
            remarkVal = '‡∏°‡∏™';
            autoMS = true;
        }
    }
    
    // üåü ‡∏à‡∏±‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ä‡∏¥‡∏î‡πÅ‡∏•‡∏∞‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
    bodyHtml += `<tr>
      <td class="text-center text-muted fw-bold sticky-col-1 align-middle" style="font-size:0.85rem;">${rowIndex + 1}</td>
      <td class="text-start sticky-col-2 align-middle px-2">
         <div class="fw-bold text-dark text-truncate" style="max-width: 170px; font-size: 0.88rem; line-height:1.2;">${std[2]}</div>
         <div class="d-flex align-items-center mt-1">
            <span class="text-muted font-monospace" style="font-size: 0.75rem;">${stdId}</span>
            ${attText}
         </div>
      </td>`;
    
    config.indicators.forEach((ind) => {
      const indName = normStr(`ind_${ind.name}`);
      const scoreKey = `${safeStdId}_${indName}`; 
      const val = (existingScores[scoreKey] !== undefined && existingScores[scoreKey] !== "") ? existingScores[scoreKey] : '';
      bodyHtml += `<td class="p-0 align-middle text-center"><input type="number" class="score-cell-input nav-input formative-std-${safeStdId}" style="background:transparent;" value="${val}" data-row="${rowIndex}" data-col="${colIndex++}" onkeydown="handleCellNav(event)" onkeyup="calcRow('${stdId}', '${safeStdId}')"></td>`;
    });

    if(isHeaderEditMode) bodyHtml += `<td class="bg-light"></td>`;

    const midVal = (existingScores[`${safeStdId}_midterm`] !== undefined && existingScores[`${safeStdId}_midterm`] !== "") ? existingScores[`${safeStdId}_midterm`] : '';
    const midReVal = (existingScores[`${safeStdId}_midterm_re`] !== undefined && existingScores[`${safeStdId}_midterm_re`] !== "") ? existingScores[`${safeStdId}_midterm_re`] : ''; 
    const finVal = (existingScores[`${safeStdId}_final`] !== undefined && existingScores[`${safeStdId}_final`] !== "") ? existingScores[`${safeStdId}_final`] : '';
    const q = existingQuals[safeStdId] || { read: "3", char: "3", comp: "3" };
    const opt = `<option value="3">3</option><option value="2">2</option><option value="1">1</option><option value="0">0</option>`;

    bodyHtml += `<td class="p-0 align-middle text-center border-start col-highlight-f"><input type="text" class="score-cell-input fw-bold text-primary" style="background:transparent;" id="sum_f_std_${safeStdId}" value="0" readonly tabindex="-1"></td>
      <td class="p-0 align-middle text-center col-highlight-m"><input type="number" class="score-cell-input nav-input midterm-std-${safeStdId}" style="background:transparent;" value="${midVal}" data-row="${rowIndex}" data-col="${colIndex++}" onkeydown="handleCellNav(event)" onkeyup="calcRow('${stdId}', '${safeStdId}')"></td>
      <td class="p-0 align-middle text-center border-start border-white col-highlight-mr"><input type="number" class="score-cell-input nav-input midterm-re-std-${safeStdId} text-danger fw-bold" style="background:transparent;" value="${midReVal}" placeholder="-" data-row="${rowIndex}" data-col="${colIndex++}" onkeydown="handleCellNav(event)" onkeyup="calcRow('${stdId}', '${safeStdId}')"></td>
      <td class="p-0 align-middle text-center border-start col-highlight-e"><input type="number" class="score-cell-input nav-input final-std-${safeStdId}" style="background:transparent;" value="${finVal}" data-row="${rowIndex}" data-col="${colIndex++}" onkeydown="handleCellNav(event)" onkeyup="calcRow('${stdId}', '${safeStdId}')"></td>
      
      <td class="text-center align-middle text-dark fw-bold border-start col-highlight-total" id="sum_total_std_${safeStdId}" style="font-size: 0.95rem;">0</td>
      <td class="text-center align-middle text-success fw-bold border-start col-highlight-grade" id="grade_std_${safeStdId}" style="font-size: 1rem;">0</td>
      
      <td class="p-0 align-middle text-center border-start col-highlight-mr position-relative">
        <select class="qual-select remark-select nav-input" data-row="${rowIndex}" data-col="${colIndex++}" data-safeid="${safeStdId}" onkeydown="handleCellNav(event)" onchange="calcRow('${stdId}', '${safeStdId}')" style="width: 100%; height:100%; background: transparent; padding:4px; font-size: 0.85rem; border:none; outline:none; text-align:center;">
          <option value="" ${remarkVal === '' ? 'selected' : ''}>-</option>
          <option value="‡∏£" ${remarkVal === '‡∏£' ? 'selected' : ''}>‡∏£</option>
          <option value="‡∏°‡∏™" ${remarkVal === '‡∏°‡∏™' ? 'selected' : ''}>‡∏°‡∏™</option>
        </select>
        ${autoMS ? '<div class="text-danger fw-bold position-absolute" style="font-size: 0.45rem; top: 1px; right: 2px; text-align: center;"><i class="fas fa-robot"></i></div>' : ''}
      </td>
      
      <td class="p-0 align-middle text-center border-start ${isQualVisible ? '' : 'd-none'}"><select class="qual-select qual-read nav-input w-100 h-100 border-0 text-center" data-row="${rowIndex}" data-col="${colIndex++}" onkeydown="handleCellNav(event)" data-safeid="${safeStdId}">${opt.replace(`value="${q.read}"`, `value="${q.read}" selected`)}</select></td>
      <td class="p-0 align-middle text-center ${isQualVisible ? '' : 'd-none'}"><select class="qual-select qual-char nav-input w-100 h-100 border-0 text-center" data-row="${rowIndex}" data-col="${colIndex++}" onkeydown="handleCellNav(event)" data-safeid="${safeStdId}">${opt.replace(`value="${q.char}"`, `value="${q.char}" selected`)}</select></td>
      <td class="p-0 align-middle text-center ${isQualVisible ? '' : 'd-none'}"><select class="qual-select qual-comp nav-input w-100 h-100 border-0 text-center" data-row="${rowIndex}" data-col="${colIndex++}" onkeydown="handleCellNav(event)" data-safeid="${safeStdId}">${opt.replace(`value="${q.comp}"`, `value="${q.comp}" selected`)}</select></td>
    </tr>`;
  });
  tbody.innerHTML = bodyHtml;
  reCalcAllRows();
}

function calculateGrade(score) {
  if (score >= 80) return "4";
  if (score >= 75) return "3.5";
  if (score >= 70) return "3";
  if (score >= 65) return "2.5";
  if (score >= 60) return "2";
  if (score >= 55) return "1.5";
  if (score >= 50) return "1";
  return "0";
}

function reCalcAllRows() {
  let sumFormativeMax = 0;
  document.querySelectorAll('.ind-score-edit').forEach(el => { sumFormativeMax += parseFloat(el.innerText) || 0; });
  const fEl = document.getElementById('edit-ratio-f');
  if(fEl) fEl.innerText = sumFormativeMax;

  const f = sumFormativeMax; 
  const m = parseFloat(document.getElementById('edit-ratio-m').innerText) || 0;
  const e = parseFloat(document.getElementById('edit-ratio-e').innerText) || 0;
  const totalRatio = f + m + e;
  
  const totEl = document.getElementById('edit-ratio-total');
  if(totEl) {
     totEl.innerText = totalRatio;
     totEl.style.color = (totalRatio !== 100) ? 'red' : ''; 
  }

  currentScoreStudents.forEach(std => {
      calcRow(String(std[0]).trim(), normID(std[0]));
  });
}

let autoSaveTimer = null; 
let retrySaveTimer = null;

function calcRow(stdId, safeStdId) {
  if (!safeStdId) safeStdId = normID(stdId);

  let sumFormative = 0;
  const maxScores = Array.from(document.querySelectorAll('.ind-score-edit')).map(el => parseFloat(el.innerText) || 0);
  const maxM = parseFloat(document.getElementById('edit-ratio-m').innerText) || 0;
  const maxE = parseFloat(document.getElementById('edit-ratio-e').innerText) || 0;
  
  document.querySelectorAll(`.formative-std-${safeStdId}`).forEach((input, i) => {
    const val = parseFloat(input.value) || 0;
    input.style.color = val > (maxScores[i] || 0) ? 'red' : '';
    sumFormative += val;
  });
  
  const sumEl = document.getElementById(`sum_f_std_${safeStdId}`);
  if(sumEl) sumEl.value = sumFormative;
  
  const midInput = document.querySelector(`.midterm-std-${safeStdId}`);
  const midReInput = document.querySelector(`.midterm-re-std-${safeStdId}`);
  const midVal = midInput && midInput.value !== '' ? parseFloat(midInput.value) : 0;
  const midReVal = midReInput && midReInput.value !== '' ? parseFloat(midReInput.value) : NaN; 
  
  let effectiveMidterm = midVal; 
  if (midInput && midReInput) {
      if (!isNaN(midReVal)) {
         effectiveMidterm = midReVal;
         midInput.style.textDecoration = "line-through";
         midInput.style.opacity = "0.4";
      } else {
         midInput.style.textDecoration = "none";
         midInput.style.opacity = "1";
      }
      midInput.style.color = midVal > maxM ? 'red' : '';
      midReInput.style.color = effectiveMidterm > maxM ? 'red' : '#dc3545';
  }
  
  const finInput = document.querySelector(`.final-std-${safeStdId}`);
  const finVal = finInput && finInput.value !== '' ? parseFloat(finInput.value) : 0;
  if (finInput) finInput.style.color = finVal > maxE ? 'red' : '';

  const total = sumFormative + effectiveMidterm + finVal;
  const totalCell = document.getElementById(`sum_total_std_${safeStdId}`);
  const gradeCell = document.getElementById(`grade_std_${safeStdId}`);
  if(totalCell) totalCell.innerText = total;

  const remarkSelect = document.querySelector(`.remark-select[data-safeid="${safeStdId}"]`);
  const remark = remarkSelect ? remarkSelect.value : '';

  if (remarkSelect) {
      if(remark !== '') remarkSelect.classList.add('text-danger', 'fw-bold');
      else remarkSelect.classList.remove('text-danger', 'fw-bold');
  }

  if(gradeCell && totalCell) {
      if (remark !== '') {
         gradeCell.innerText = remark;
         totalCell.className = "text-center align-middle text-white fw-bold fs-6 border-start bg-danger";
         gradeCell.className = "text-center align-middle text-white fw-bold fs-5 border-start bg-danger";
      } else {
         gradeCell.innerText = calculateGrade(total);
         if(total < 50) { 
           totalCell.className = "text-center align-middle text-white fw-bold fs-6 border-start bg-danger";
           gradeCell.className = "text-center align-middle text-white fw-bold fs-5 border-start bg-danger"; 
         } else { 
           totalCell.className = "text-center align-middle text-dark fw-bold fs-6 border-start col-highlight-total";
           gradeCell.className = "text-center align-middle text-success fw-bold fs-5 border-start col-highlight-grade";
         }
      }
  }

  const btn = document.getElementById('btnSaveScores');
  if (!isHeaderEditMode && btn) {
      clearTimeout(autoSaveTimer);
      btn.innerHTML = '<i class="fas fa-hourglass-half fa-spin me-2"></i>‡∏£‡∏≠‡πÄ‡∏ã‡∏ü (3 ‡∏ß‡∏¥)...';
      btn.className = "btn btn-outline-warning text-dark shadow-sm px-4 fw-bold"; 
      autoSaveTimer = setTimeout(() => { saveAllInOneScores(true); }, 3000); 
  }
}

function saveAllInOneScores(isSilent = false) {
  if(isSavingScores) {
      if(isSilent) {
          clearTimeout(retrySaveTimer);
          retrySaveTimer = setTimeout(() => saveAllInOneScores(true), 1500);
      }
      return; 
  }
  isSavingScores = true;

  const val = document.getElementById('scoreClassSelect').value;
  const btn = document.getElementById('btnSaveScores');
  const originalBtnClass = "btn btn-success shadow-sm px-4 fw-bold";
  const originalText = '<i class="fas fa-save me-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';

  if(!val) { isSavingScores = false; return; }
  const item = JSON.parse(val);
  const user = getSessionUser();
  
  const f = parseFloat(document.getElementById('edit-ratio-f').innerText) || 0;
  const m = parseFloat(document.getElementById('edit-ratio-m').innerText) || 0;
  const e = parseFloat(document.getElementById('edit-ratio-e').innerText) || 0;
  
  if((f + m + e) !== 100) {
     if(!isSilent) {
        if(!confirm("‚ö†Ô∏è ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö 100 ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) { isSavingScores = false; return; }
     } else {
        if(btn) { btn.innerHTML = originalText; btn.className = originalBtnClass; }
        isSavingScores = false; return; 
     }
  }

  if (!isSilent && btn) {
     btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
     btn.className = originalBtnClass;
     btn.disabled = true;
  } else if (btn) {
     btn.innerHTML = '<i class="fas fa-sync fa-spin me-2"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á Auto-Save...';
     btn.className = "btn btn-info text-white shadow-sm px-4 fw-bold";
  }

  try {
      const newIndicators = [];
      const names = document.querySelectorAll('.ind-name-edit');
      const scores = document.querySelectorAll('.ind-score-edit');
      names.forEach((el, i) => {
        newIndicators.push({ name: el.innerText.trim(), score: parseFloat(scores[i].innerText) || 0 });
      });

      currentScoreConfig.indicators = newIndicators;
      currentScoreConfig.ratio = `${f}:${m}:${e}`;

      const payload = {
        subjectCode: item[0], className: item[2], term: user.currentTerm, year: user.currentYear, teacherId: user.id,
        newConfig: { formative: f, midterm: m, final: e, indicators: newIndicators },
        scoreRecords: [], qualRecords: [], gradeRecords: []
      };

      currentScoreStudents.forEach(std => {
        const stdId = String(std[0]).trim();
        const safeStdId = normID(stdId); 
        
        document.querySelectorAll(`.formative-std-${safeStdId}`).forEach((input, i) => {
          const indName = normStr(`ind_${newIndicators[i].name}`);
          const val = input.value !== '' ? parseFloat(input.value) : ''; 
          payload.scoreRecords.push({ studentId: stdId, subjectCode: item[0], term: user.currentTerm, year: user.currentYear, indicatorId: indName, score: val });
        });

        const midInput = document.querySelector(`.midterm-std-${safeStdId}`);
        if (midInput) payload.scoreRecords.push({ studentId: stdId, subjectCode: item[0], term: user.currentTerm, year: user.currentYear, indicatorId: 'midterm', score: midInput.value !== '' ? parseFloat(midInput.value) : '' });

        const midReInput = document.querySelector(`.midterm-re-std-${safeStdId}`);
        if (midReInput) payload.scoreRecords.push({ studentId: stdId, subjectCode: item[0], term: user.currentTerm, year: user.currentYear, indicatorId: 'midterm_re', score: midReInput.value !== '' ? parseFloat(midReInput.value) : '' });

        const finInput = document.querySelector(`.final-std-${safeStdId}`);
        if (finInput) payload.scoreRecords.push({ studentId: stdId, subjectCode: item[0], term: user.currentTerm, year: user.currentYear, indicatorId: 'final', score: finInput.value !== '' ? parseFloat(finInput.value) : '' });

        const remarkInput = document.querySelector(`.remark-select[data-safeid="${safeStdId}"]`);
        if (remarkInput && remarkInput.value !== '') {
           payload.scoreRecords.push({ studentId: stdId, subjectCode: item[0], term: user.currentTerm, year: user.currentYear, indicatorId: 'remark', score: remarkInput.value });
        }

        const tCell = document.getElementById(`sum_total_std_${safeStdId}`);
        const gCell = document.getElementById(`grade_std_${safeStdId}`);
        payload.gradeRecords.push({ studentId: stdId, subjectCode: item[0], totalScore: tCell ? tCell.innerText : '0', grade: gCell ? gCell.innerText : '0' });
        
        const qRead = document.querySelector(`.qual-read[data-safeid="${safeStdId}"]`);
        const qChar = document.querySelector(`.qual-char[data-safeid="${safeStdId}"]`);
        const qComp = document.querySelector(`.qual-comp[data-safeid="${safeStdId}"]`);
        
        payload.qualRecords.push({ studentId: stdId, subjectCode: item[0], term: user.currentTerm, year: user.currentYear, read: qRead ? qRead.value : '3', char: qChar ? qChar.value : '3', comp: qComp ? qComp.value : '3' });
      });

      google.script.run
        .withFailureHandler(err => {
          isSavingScores = false; 
          if(btn) { btn.disabled = false; btn.innerHTML = originalText; btn.className = originalBtnClass; }
          if(!isSilent) alert("‚ùå ‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå: " + err.message);
        })
        .withSuccessHandler(res => {
          isSavingScores = false; 
          if(btn) { btn.disabled = false; btn.innerHTML = originalText; btn.className = originalBtnClass; }
          
          document.getElementById('scoreRatioBadge').innerText = `‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ${f}:${m}:${e}`;

          if (!isSilent) {
             let wasInEditMode = isHeaderEditMode;
             isHeaderEditMode = false;
             const btnEdit = document.getElementById('btnEditHeader');
             if(btnEdit) {
                btnEdit.className = "btn btn-outline-primary shadow-sm px-3 fw-bold me-2";
                btnEdit.innerHTML = '<i class="fas fa-th me-2"></i>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á';
             }
             showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß", "success");
             if(wasInEditMode) refreshTableOnly(); 
          } else {
             showToast("‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß (Auto-Saved)", "info");
          }
      }).saveAllInOneWithConfig(payload);

  } catch(e) {
      isSavingScores = false; 
      if(btn) { btn.disabled = false; btn.innerHTML = originalText; btn.className = originalBtnClass; }
      if(!isSilent) alert("‚ùå UI Error: " + e.message);
      console.error(e);
  }
}

function addIndicator() {
  currentScoreConfig.indicators.push({ name: "‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà", score: 10 });
  refreshTableOnly();
}

function removeIndicator(idx) {
  if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ô‡∏µ‡πâ?")) {
    currentScoreConfig.indicators.splice(idx, 1);
    refreshTableOnly();
  }
}

function handleCellNav(e) {
  if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
    const input = e.target;
    const row = parseInt(input.dataset.row);
    const col = parseInt(input.dataset.col);
    let nextRow = row; let nextCol = col;
    if (e.key === 'ArrowUp') nextRow--;
    if (e.key === 'ArrowDown') nextRow++;
    if (e.key === 'ArrowLeft') nextCol--;
    if (e.key === 'ArrowRight') nextCol++;
    const nextInput = document.querySelector(`.nav-input[data-row="${nextRow}"][data-col="${nextCol}"]`);
    if (nextInput) { e.preventDefault(); nextInput.focus(); nextInput.select(); }
  }
}

// ==========================================
// üåü ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°: Toast & Shortcut
// ==========================================

function showToast(msg, type="success") {
  let container = document.getElementById('toastContainer');
  if (!container) {
      container = document.createElement('div');
      container.id = 'toastContainer';
      container.style.cssText = 'position: fixed; bottom: 20px; right: 20px; z-index: 1050;';
      document.body.appendChild(container);
  }
  const bgClass = type === 'success' ? 'bg-success' : (type === 'info' ? 'bg-primary' : 'bg-warning text-dark');
  const icon = type === 'success' ? 'fa-check-circle' : (type === 'info' ? 'fa-cloud-upload-alt' : 'fa-exclamation-triangle');
  const toast = document.createElement('div');
  toast.className = `toast align-items-center text-white ${bgClass} border-0 mb-2 show animate__animated animate__fadeInUp shadow-lg`;
  toast.style.minWidth = "250px";
  toast.style.borderRadius = "8px";
  toast.innerHTML = `<div class="d-flex p-2"><div class="toast-body fw-bold" style="font-size: 0.9rem;"><i class="fas ${icon} me-2 fa-lg"></i>${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto shadow-none" onclick="this.parentElement.parentElement.remove()"></button></div>`;
  container.appendChild(toast);
  setTimeout(() => { toast.classList.replace('animate__fadeInUp', 'animate__fadeOutDown'); setTimeout(() => toast.remove(), 500); }, 2500);
}

document.addEventListener('keydown', function(e) {
  if ((e.ctrlKey || e.metaKey) && (e.key === 's' || e.key === 'S')) {
      const saveBtn = document.getElementById('btnSaveScores');
      const gridCard = document.getElementById('scoreGridCard');
      if (saveBtn && !saveBtn.disabled && gridCard && !gridCard.classList.contains('d-none')) {
          e.preventDefault(); 
          saveAllInOneScores(false); 
      }
  }
});

// ==========================================
// üåô SYSTEM THEME (DARK MODE)
// ==========================================

function toggleDarkMode() {
  const body = document.body;
  if (body.classList.contains('dark-mode')) {
    body.classList.remove('dark-mode');
    localStorage.setItem('pssms_theme', 'light');
    document.getElementById('darkModeIcon').className = 'fas fa-moon text-secondary fa-lg';
  } else {
    body.classList.add('dark-mode');
    localStorage.setItem('pssms_theme', 'dark');
    document.getElementById('darkModeIcon').className = 'fas fa-sun text-warning fa-lg';
  }
}

function applySavedTheme() {
  if (localStorage.getItem('pssms_theme') === 'dark') document.body.classList.add('dark-mode');
}
</script>